---
import Layout from "../layouts/Layout.astro";
import TopBar from "../components/TopBar.astro";
import ProjectMap from "../components/ProjectMap.jsx";
import LGUFooter from "../components/LGUFooter.astro";
import homeService from "../services/home.js";

// Fetch real data for the home page with error handling
let stats, featuredProjects, articles;

try {
  stats = await homeService.getHomeStats();
} catch (error) {
  console.error('Error fetching stats:', error);
  stats = {
    ongoingProjects: 32,
    totalBudget: 120000000,
    completedProjects: 18
  };
}

try {
  featuredProjects = await homeService.getFeaturedProjects(5);
} catch (error) {
  console.error('Error fetching projects:', error);
  featuredProjects = [];
}

try {
  articles = await homeService.getArticles(4);
} catch (error) {
  console.error('Error fetching articles:', error);
  articles = [];
}
---
<Layout title="Home | Build Watch LGU" description="Santa Cruz LGU Project Monitoring and Evaluation System - Home">
  <TopBar />
  <main class="flex flex-col items-center w-full px-4 pt-28 pb-12 bg-transparent min-h-[60vh] fade-in-home">
    {/* Hero Header with Summary & CTA */}
    <section class="w-full min-h-[60vh] bg-gradient-to-br from-[#EB3C3C] via-[#ED6F6F] to-[#EB3C3C] flex flex-col items-center justify-center py-16 px-4 text-center">
      <div class="flex flex-col items-center justify-center w-full max-w-4xl mx-auto gap-8">
        <span class="inline-flex items-center gap-2 px-4 py-1 bg-white/80 text-[#EB3C3C] font-bold rounded-full mb-4 text-sm shadow">Santa Cruz LGU</span>
        <h1 class="text-5xl md:text-6xl font-extrabold text-white drop-shadow-lg leading-tight mb-6">Project Monitoring System</h1>
        <p class="text-lg md:text-xl font-medium text-white/90 mb-8 max-w-2xl mx-auto">
          A digital platform designed to promote transparency, empower citizens, and track development projects in real-time.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
          <a href="/projects" class="px-8 py-4 bg-white text-[#EB3C3C] font-bold text-lg rounded-lg shadow hover:bg-red-100 transition">View Projects</a>
          <a href="/open-data" class="px-8 py-4 bg-[#EB3C3C] text-white font-bold text-lg rounded-lg shadow hover:bg-white hover:text-[#EB3C3C] transition border border-white">Track Progress</a>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full">
          <div class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center">
            <span class="text-4xl text-[#EB3C3C] mb-2">üìä</span>
            <div class="text-3xl font-bold text-[#EB3C3C]" id="ongoing-projects-count">{stats.ongoingProjects}</div>
            <div class="text-[#7A1F1F] font-medium">Ongoing Projects</div>
          </div>
          <div class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center">
            <span class="text-4xl text-[#EB3C3C] mb-2">üí∞</span>
            <div class="text-3xl font-bold text-[#EB3C3C]" id="total-budget">{homeService.formatBudget(stats.totalBudget)}</div>
            <div class="text-[#7A1F1F] font-medium">Total Budget</div>
          </div>
          <div class="bg-white/90 rounded-2xl shadow-lg p-6 flex flex-col items-center">
            <span class="text-4xl text-[#EB3C3C] mb-2">‚úÖ</span>
            <div class="text-3xl font-bold text-[#EB3C3C]" id="completed-projects-count">{stats.completedProjects}</div>
            <div class="text-[#7A1F1F] font-medium">Completed Projects</div>
          </div>
        </div>
        <div class="flex items-center justify-center mt-8">
          <img src="/build-watch-logo.png" alt="Build Watch Infographic" class="w-56 h-56 object-contain rounded-2xl shadow-lg border-4 border-white" />
        </div>
      </div>
    </section>
    {/* Modern Barangay Carousel Section */}
    <section class="w-full bg-gradient-to-br from-[#EB3C3C] via-[#ED6F6F] to-[#EB3C3C] py-16 px-4 relative overflow-hidden">
      {/* Background Pattern */}
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-10 left-10 w-32 h-32 bg-white rounded-full blur-3xl"></div>
        <div class="absolute bottom-10 right-10 w-40 h-40 bg-white rounded-full blur-3xl"></div>
        <div class="absolute top-1/2 left-1/4 w-24 h-24 bg-white rounded-full blur-2xl"></div>
      </div>
      
      <div class="relative z-10 flex flex-col items-center justify-center max-w-7xl mx-auto">
        {/* Section Header */}
        <div class="text-center mb-12">
          <h2 class="text-4xl md:text-5xl font-extrabold text-white mb-4 drop-shadow-lg">
            Barangays of Santa Cruz, Laguna
          </h2>
          <p class="text-white/90 text-lg max-w-2xl mx-auto">
            Explore development projects and initiatives across all 26 barangays
          </p>
        </div>

        {/* Enhanced Carousel Container */}
        <div class="w-full relative group">
          {/* Navigation Arrows */}
          <button class="absolute left-4 top-1/2 -translate-y-1/2 z-20 w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-all duration-300 opacity-0 group-hover:opacity-100 border border-white/30" id="prev-btn">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          
          <button class="absolute right-4 top-1/2 -translate-y-1/2 z-20 w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-all duration-300 opacity-0 group-hover:opacity-100 border border-white/30" id="next-btn">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>

          {/* Carousel Track */}
          <div class="flex overflow-x-auto gap-6 pb-8 scrollbar-hide max-w-6xl mx-auto px-4" id="barangay-carousel">
            {[
              {name: 'Alipit', icon: 'üèòÔ∏è', projects: 3, status: 'active'},
              {name: 'Bagumbayan', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Bubukal', icon: 'üèòÔ∏è', projects: 1, status: 'active'},
              {name: 'Calios', icon: 'üèòÔ∏è', projects: 4, status: 'active'},
              {name: 'Duhat', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Gatid', icon: 'üèòÔ∏è', projects: 3, status: 'active'},
              {name: 'Jasaan', icon: 'üèòÔ∏è', projects: 1, status: 'active'},
              {name: 'Labuin', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Malinao', icon: 'üèòÔ∏è', projects: 3, status: 'active'},
              {name: 'Oogong', icon: 'üèòÔ∏è', projects: 1, status: 'active'},
              {name: 'Pagsawitan', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Palasan', icon: 'üèòÔ∏è', projects: 4, status: 'active'},
              {name: 'Patimbao', icon: 'üèòÔ∏è', projects: 1, status: 'active'},
              {name: 'Poblacion I', icon: 'üèòÔ∏è', projects: 5, status: 'active'},
              {name: 'Poblacion II', icon: 'üèòÔ∏è', projects: 3, status: 'active'},
              {name: 'Poblacion III', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Poblacion IV', icon: 'üèòÔ∏è', projects: 4, status: 'active'},
              {name: 'Poblacion V', icon: 'üèòÔ∏è', projects: 1, status: 'active'},
              {name: 'San Jose', icon: 'üèòÔ∏è', projects: 3, status: 'active'},
              {name: 'San Juan', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'San Pablo Norte', icon: 'üèòÔ∏è', projects: 4, status: 'active'},
              {name: 'San Pablo Sur', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Santisima Cruz', icon: 'üèòÔ∏è', projects: 3, status: 'active'},
              {name: 'Santo Angel Central', icon: 'üèòÔ∏è', projects: 1, status: 'active'},
              {name: 'Santo Angel Norte', icon: 'üèòÔ∏è', projects: 2, status: 'active'},
              {name: 'Santo Angel Sur', icon: 'üèòÔ∏è', projects: 3, status: 'active'}
            ].map((bgy, index) => (
              <div class="min-w-[200px] h-48 bg-white/15 backdrop-blur-sm rounded-2xl shadow-xl flex flex-col items-center justify-center p-6 relative group/card hover:scale-105 transition-all duration-300 cursor-pointer border border-white/20 hover:border-white/40 hover:bg-white/25" 
                   key={bgy.name} 
                   data-barangay={bgy.name}
                   data-index={index}>
                
                {/* Hover Effect Overlay */}
                <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent rounded-2xl opacity-0 group-hover/card:opacity-100 transition-opacity duration-300"></div>
                
                {/* Icon Container */}
                <div class="relative z-10 w-20 h-20 bg-white/25 backdrop-blur-sm rounded-2xl flex items-center justify-center mb-4 group-hover/card:bg-white/35 transition-all duration-300 shadow-lg">
                  <span class="text-4xl">{bgy.icon}</span>
                </div>
                
                {/* Content */}
                <div class="relative z-10 text-center">
                  <div class="text-white font-bold text-lg mb-2 group-hover/card:text-xl transition-all duration-300">
                    {bgy.name}
                  </div>
                  <div class="text-white/80 text-sm font-medium">
                    {bgy.projects} Active Projects
                  </div>
                </div>
                
                {/* Status Indicator */}
                <div class="absolute top-3 right-3 w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                
                {/* Click Indicator */}
                <div class="absolute bottom-3 left-1/2 -translate-x-1/2 opacity-0 group-hover/card:opacity-100 transition-opacity duration-300">
                  <div class="text-white/60 text-xs font-medium">Click to explore</div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Carousel Indicators */}
        <div class="flex items-center justify-center gap-2 mt-8" id="carousel-indicators">
          {Array.from({length: 6}, (_, i) => (
            <button class="w-3 h-3 rounded-full bg-white/40 hover:bg-white/60 transition-colors duration-300 carousel-dot" data-index={i}></button>
          ))}
        </div>
      </div>
    </section>
    {/* About Build Watch Section */}
    <section class="w-full bg-gradient-to-r from-[#EB3C3C] to-[#ED6F6F] py-16 px-4 flex flex-col items-center justify-center">
      <div class="flex flex-col md:flex-row items-center justify-center gap-12 max-w-6xl mx-auto w-full">
        <div class="flex-1 flex items-center justify-center">
          <img src="/build-watch-logo.png" alt="Build Watch Infographic" class="w-48 h-48 object-contain" />
        </div>
        <div class="flex-1 max-w-xl text-center md:text-left">
          <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-4">About Build Watch</h2>
          <p class="text-white text-lg mb-6">Build Watch is an LGU-led transparency initiative that allows citizens to follow every phase of infrastructure and development projects happening in their communities.</p>
          <div class="flex flex-col gap-4 items-center md:items-start">
            <div class="flex items-center gap-2">
              <span class="w-4 h-4 bg-white rounded-full"></span>
              <span class="font-bold text-white">Planning</span>
              <span class="text-white">‚Üí</span>
              <span class="font-bold text-white">Implementation</span>
              <span class="text-white">‚Üí</span>
              <span class="font-bold text-white">Evaluation</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    {/* Interactive Map Section */}
    <section class="w-full bg-[#EB3C3C] py-12 px-4 flex flex-col items-center justify-center">
      <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-8 text-center">Project Locations Map</h2>
      <div class="w-full max-w-full mx-auto flex items-center justify-center">
        <ProjectMap client:only="react" />
      </div>
    </section>
    {/* Project & Program Overview Carousel */}
    <section class="w-full bg-gradient-to-br from-[#EB3C3C] via-[#ED6F6F] to-[#EB3C3C] py-12 px-4 flex flex-col items-center justify-center">
      <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-8 text-center">Project & Program Overview</h2>
      <div class="flex overflow-x-auto gap-6 pb-4 scrollbar-thin scrollbar-thumb-white/40 scrollbar-track-[#EB3C3C] max-w-6xl mx-auto">
        {featuredProjects && featuredProjects.length > 0 ? featuredProjects.map((project) => (
          <div class="min-w-[320px] bg-white/20 rounded-xl shadow-lg flex flex-col items-start p-6 relative group hover:scale-105 transition cursor-pointer" key={project.id} data-project-id={project.id}>
            <div class="w-full h-32 bg-white/40 rounded-lg mb-4 flex items-center justify-center">
              <span class="text-4xl text-white">üèóÔ∏è</span>
            </div>
            <div class="font-bold text-lg text-white mb-1">{project.name}</div>
            <div class="text-white text-sm mb-1">Location: {project.location}</div>
            <div class="text-white text-sm mb-1">Status: <span class={`inline-block px-2 py-1 rounded-full font-bold text-xs ${homeService.getStatusColor(project.status)}`}>{project.status}</span></div>
            <div class="text-white text-sm mb-1">Budget: {homeService.formatBudget(project.budget)}</div>
            <div class="text-white text-sm mb-1">Progress: {project.progress}%</div>
            <div class="text-white text-sm mb-1">Start-End: {homeService.formatDate(project.startDate)} - {homeService.formatDate(project.endDate)}</div>
            <a href={`/projects/${project.id}`} class="text-white font-bold text-sm hover:underline mt-2">View Details ‚Üí</a>
          </div>
        )) : (
          <div class="min-w-[320px] bg-white/20 rounded-xl shadow-lg flex flex-col items-center justify-center p-6">
            <div class="text-white text-center">
              <div class="text-4xl mb-4">üèóÔ∏è</div>
              <div class="font-bold text-lg mb-2">No Projects Available</div>
              <div class="text-sm">Check back later for updates</div>
            </div>
          </div>
        )}
      </div>
    </section>
    {/* Articles and Publications Carousel */}
    <section class="w-full bg-[#EB3C3C] py-12 px-4 flex flex-col items-center justify-center">
      <h2 class="text-3xl md:text-4xl font-extrabold text-white mb-8 text-center">Articles & Publications</h2>
      <div class="flex overflow-x-auto gap-6 pb-4 scrollbar-thin scrollbar-thumb-white/40 scrollbar-track-[#EB3C3C] max-w-6xl mx-auto">
        {articles && articles.length > 0 ? articles.map((article) => (
          <div class="min-w-[320px] bg-white/20 rounded-xl shadow-lg flex flex-col items-start p-6 relative group hover:scale-105 transition cursor-pointer" key={article.id} data-article-id={article.id}>
            <div class="w-full h-32 bg-white/40 rounded-lg mb-4 flex items-center justify-center">
              <span class="text-4xl text-white">üì∞</span>
            </div>
            <div class="font-bold text-lg text-white mb-1">{article.title}</div>
            <div class="text-white text-sm mb-1">Date: {homeService.formatDate(article.publishDate)}</div>
            <div class="text-white text-sm mb-1">Author: {article.author}</div>
            <div class="text-white text-sm mb-1">{article.summary}</div>
            <a href={`/news/${article.id}`} class="text-white font-bold text-sm hover:underline mt-2">Read More ‚Üí</a>
          </div>
        )) : (
          <div class="min-w-[320px] bg-white/20 rounded-xl shadow-lg flex flex-col items-center justify-center p-6">
            <div class="text-white text-center">
              <div class="text-4xl mb-4">üì∞</div>
              <div class="font-bold text-lg mb-2">No Articles Available</div>
              <div class="text-sm">Check back later for updates</div>
            </div>
          </div>
        )}
      </div>
    </section>
  </main>
  <LGUFooter />
</Layout>
<style>
  .fade-in-home {
    animation: fadeInHome 1.1s cubic-bezier(.4,0,.2,1);
  }
  @keyframes fadeInHome {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: none; }
  }
  
  /* Hide scrollbar for carousel */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  /* Enhanced hover effects */
  .group\/card:hover .group-hover\/card\:bg-white\/35 {
    background-color: rgba(255, 255, 255, 0.35);
  }
  
  /* Smooth transitions for all interactive elements */
  * {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 300ms;
  }
  
  /* Custom animation for status indicators */
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>

<script>
  import homeService from '../services/home.js';
  
  // Make homeService available globally
  window.homeService = homeService;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for project cards
    const projectCards = document.querySelectorAll('[data-project-id]');
    projectCards.forEach(card => {
      card.addEventListener('click', function() {
        const projectId = this.getAttribute('data-project-id');
        if (projectId) {
          window.location.href = `/projects/${projectId}`;
        }
      });
    });

    // Add click handlers for article cards
    const articleCards = document.querySelectorAll('[data-article-id]');
    articleCards.forEach(card => {
      card.addEventListener('click', function() {
        const articleId = this.getAttribute('data-article-id');
        if (articleId) {
          window.location.href = `/news/${articleId}`;
        }
      });
    });

    // Enhanced Barangay Carousel Functionality
    const carousel = document.getElementById('barangay-carousel');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const indicators = document.querySelectorAll('.carousel-dot');
    
    if (carousel && prevBtn && nextBtn) {
      const cardWidth = 200 + 24; // card width + gap
      const visibleCards = Math.floor(carousel.offsetWidth / cardWidth);
      let currentIndex = 0;
      const totalCards = 26; // total barangays
      const maxIndex = Math.max(0, totalCards - visibleCards);
      
      // Update indicators
      function updateIndicators() {
        indicators.forEach((dot, i) => {
          dot.classList.toggle('bg-white/60', i === Math.floor(currentIndex / 4));
          dot.classList.toggle('bg-white/40', i !== Math.floor(currentIndex / 4));
        });
      }
      
      // Scroll to index
      function scrollToIndex(index) {
        currentIndex = Math.max(0, Math.min(index, maxIndex));
        carousel.scrollTo({
          left: currentIndex * cardWidth,
          behavior: 'smooth'
        });
        updateIndicators();
      }
      
      // Navigation buttons
      prevBtn.addEventListener('click', () => scrollToIndex(currentIndex - 4));
      nextBtn.addEventListener('click', () => scrollToIndex(currentIndex + 4));
      
      // Indicator clicks
      indicators.forEach((dot, i) => {
        dot.addEventListener('click', () => scrollToIndex(i * 4));
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') scrollToIndex(currentIndex - 4);
        if (e.key === 'ArrowRight') scrollToIndex(currentIndex + 4);
      });
      
      // Auto-scroll on hover
      let autoScrollInterval;
      carousel.addEventListener('mouseenter', () => {
        autoScrollInterval = setInterval(() => {
          if (currentIndex >= maxIndex) {
            currentIndex = 0;
          } else {
            currentIndex += 1;
          }
          scrollToIndex(currentIndex);
        }, 3000);
      });
      
      carousel.addEventListener('mouseleave', () => {
        if (autoScrollInterval) {
          clearInterval(autoScrollInterval);
        }
      });
      
      // Initialize indicators
      updateIndicators();
    }

    // Add click handlers for barangay cards
    const barangayCards = document.querySelectorAll('[data-barangay]');
    barangayCards.forEach(card => {
      card.addEventListener('click', function() {
        const barangay = this.getAttribute('data-barangay');
        if (barangay) {
          // Add click animation
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = '';
            window.location.href = `/projects?location=${encodeURIComponent(barangay)}`;
          }, 150);
        }
      });
    });

    // Refresh data every 5 minutes
    setInterval(async () => {
      try {
        const stats = await homeService.getHomeStats();
        
        // Update statistics
        const ongoingCount = document.getElementById('ongoing-projects-count');
        const totalBudget = document.getElementById('total-budget');
        const completedCount = document.getElementById('completed-projects-count');
        
        if (ongoingCount) ongoingCount.textContent = stats.ongoingProjects;
        if (totalBudget) totalBudget.textContent = homeService.formatBudget(stats.totalBudget);
        if (completedCount) completedCount.textContent = stats.completedProjects;
        
      } catch (error) {
        console.error('Error refreshing home data:', error);
      }
    }, 5 * 60 * 1000); // 5 minutes
  });
</script> 