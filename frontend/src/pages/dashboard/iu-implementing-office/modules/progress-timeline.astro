---
export const prerender = false;
import Layout from '../../../../layouts/Layout.astro';
import IUImplementingOfficeLayout from '../../../../components/IUImplementingOfficeLayout.astro';
import ProjectCard from '../../../../components/ProjectCard.astro';
import ProjectDetailsModal from '../../../../components/ProjectDetailsModal.astro';
import MilestoneSubmissionCard from '../../../../components/MilestoneSubmissionCard.astro';
import MilestoneSubmissionModal from '../../../../components/MilestoneSubmissionModal.astro';

const API_URL = 'http://localhost:3000/api';
let userData = null;
let projects = [];
let selectedProject = null;
let projectUpdates = [];
let loading = true;
let error = '';

// Try to fetch progress timeline data from API
try {
  const token = Astro.cookies.get('token')?.value || '';
  if (token) {
    // Fetch user data for authentication
    const userRes = await fetch(`${API_URL}/auth/profile`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (userRes.ok) {
      const userDataResponse = await userRes.json();
      if (userDataResponse.success && userDataResponse.user) {
        userData = userDataResponse.user;
      }
    }

    // Fetch projects for this Implementing Office
    const timestamp = new Date().getTime();
    const projectsRes = await fetch(`${API_URL}/projects?_t=${timestamp}`, {
      headers: { 
        'Authorization': `Bearer ${token}`
      }
    });
    if (projectsRes.ok) {
      const data = await projectsRes.json();
      if (data.success) {
        projects = data.projects;
      }
    }
  }
} catch (err) {
  console.error('Error fetching progress timeline data:', err);
  error = 'Failed to fetch progress timeline data.';
}

loading = false;
---

<Layout title="Progress Timeline and Submission Update | Implementing Office Dashboard">
  <style>
    /* Enhanced Global Styles */
    .project-card {
      animation: cardSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    .project-card:nth-child(1) { animation-delay: 0.1s; }
    .project-card:nth-child(2) { animation-delay: 0.2s; }
    .project-card:nth-child(3) { animation-delay: 0.3s; }
    .project-card:nth-child(4) { animation-delay: 0.4s; }
    .project-card:nth-child(5) { animation-delay: 0.5s; }
    .project-card:nth-child(6) { animation-delay: 0.6s; }

    @keyframes cardSlideIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced global animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity: 0;
    }

    /* Enhanced transitions for all elements */
    * {
      transition-property: transform, box-shadow, filter, backdrop-filter, color, background-color, border-color;
    }
    
    /* Progress bar animation */
    .progress-bar-fill {
      transform-origin: left;
      animation: fillProgress 2s ease-out forwards;
    }
    
    @keyframes fillProgress {
      from {
        width: 0%;
      }
      to {
        width: var(--progress-width);
      }
    }

    /* Dashboard Progress Bar Animation */
    .dashboard-progress-bar-fill {
      transform-origin: left;
      animation: fillDashboardProgress 2s ease-out forwards;
    }
    
    @keyframes fillDashboardProgress {
      from {
        width: 0%;
      }
      to {
        width: var(--dashboard-progress-width);
      }
    }
    
    /* Timeline Styles */
    .timeline-milestone {
      position: absolute;
      height: 100%;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 2;
    }
    
    .timeline-milestone.completed {
      background: linear-gradient(45deg, #10b981, #059669);
    }
    
    .timeline-milestone.in_progress {
      background: linear-gradient(45deg, #3b82f6, #2563eb);
    }
    
    .timeline-milestone.pending {
      background: linear-gradient(45deg, #f59e0b, #d97706);
    }
    
    .timeline-milestone.delayed {
      background: linear-gradient(45deg, #ef4444, #dc2626);
    }
    
    .timeline-milestone:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
    }
    
    .timeline-popup {
      position: fixed;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 250px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .timeline-popup.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .timeline-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 4px;
      transition: width 1s ease-in-out;
      z-index: 1;
    }
    
    .progress-indicator {
      position: absolute;
      top: 50%;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 3;
      transition: left 1s ease-in-out, transform 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transform: translateY(-50%) translateX(-50%); /* Center the indicator vertically and horizontally */
    }
    
    .progress-indicator:hover {
      transform: translateY(-50%) translateX(-50%) scale(1.2);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .timeline-popup::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: white;
      }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Enhanced UI Components - LGU-IU IOO Theme with Advanced Hover Effects */
  
  /* Icon Container Styles - LGU-IU IOO Theme with Shimmer Effects */
  .icon-container {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  
  .icon-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }
  
  .icon-container > * {
    position: relative;
    z-index: 2;
  }
  
  .icon-container:hover::before {
    left: 100%;
  }
  
  .icon-container:hover {
    transform: scale(1.1) rotate(3deg);
  }
  
  .icon-container-small {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
  }
  
  .icon-container-small::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }
  
  .icon-container-small > * {
    position: relative;
    z-index: 2;
  }
  
  .icon-container-small:hover::before {
    left: 100%;
  }
  
  .icon-container-small:hover {
    transform: scale(1.1) rotate(3deg);
  }

  /* Modern Profile Card Styles - LGU-IU IOO Theme */
  .profile-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.5s ease-out;
    position: relative;
    overflow: hidden;
  }
  
  .profile-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.08), transparent);
    transition: left 0.6s ease-out;
    z-index: 1;
  }
  
  .profile-card > * {
    position: relative;
    z-index: 2;
  }
  
  .profile-card:hover::before {
    left: 100%;
  }
  
  .profile-card:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    transform: translateY(-2px);
    border-color: rgba(245, 158, 11, 0.2);
  }

  /* Modern Button Styles - LGU-IU IOO Theme */
  .btn-primary {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 12px;
    transition: all 0.3s ease;
    transform: translateY(0);
    box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.25);
    border: 1px solid rgba(245, 158, 11, 0.2);
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }
  
  .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }
  
  .btn-primary > * {
    position: relative;
    z-index: 2;
  }
  
  .btn-primary:hover::before {
    left: 100%;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.4);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 12px;
    transition: all 0.3s ease;
    transform: translateY(0);
    box-shadow: 0 4px 6px -1px rgba(107, 114, 128, 0.25);
    border: 1px solid rgba(107, 114, 128, 0.2);
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }
  
  .btn-secondary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }
  
  .btn-secondary > * {
    position: relative;
    z-index: 2;
  }
  
  .btn-secondary:hover::before {
    left: 100%;
  }
  
  .btn-secondary:hover {
    background: linear-gradient(135deg, #4b5563, #374151);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(107, 114, 128, 0.4);
  }

  .btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 12px;
    transition: all 0.3s ease;
    transform: translateY(0);
    box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.25);
    border: 1px solid rgba(16, 185, 129, 0.2);
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }
  
  .btn-success::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }
  
  .btn-success > * {
    position: relative;
    z-index: 2;
  }
  
  .btn-success:hover::before {
    left: 100%;
  }
  
  .btn-success:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
  }

  /* Small Button Variants */
  .btn-sm {
    padding: 8px 16px;
    font-size: 14px;
  }

  /* Submission Filter Button Styles - Professional Design Standards */
  .filter-pending {
    position: relative;
    overflow: hidden;
  }

  .filter-pending::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }

  .filter-pending:hover::before {
    left: 100%;
  }

  .filter-pending:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.4);
  }

  .filter-under-review {
    position: relative;
    overflow: hidden;
  }

  .filter-under-review::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }

  .filter-under-review:hover::before {
    left: 100%;
  }

  .filter-under-review:hover {
    background: linear-gradient(135deg, #0284c7, #0369a1);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(2, 132, 199, 0.4);
  }

  .filter-validated {
    position: relative;
    overflow: hidden;
  }

  .filter-validated::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }

  .filter-validated:hover::before {
    left: 100%;
  }

  .filter-validated:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(5, 150, 105, 0.4);
  }

  .filter-rejected {
    position: relative;
    overflow: hidden;
  }

  .filter-rejected::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }

  .filter-rejected:hover::before {
    left: 100%;
  }

  .filter-rejected:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.4);
  }

  /* Summary Card Enhanced Hover Effects */
  .summary-card {
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .summary-card:hover {
    transform: translateY(-2px);
  }

  /* Enhanced Scrollbar Styles for Project Cards */
  .scrollbar-thin::-webkit-scrollbar {
    height: 8px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(245, 158, 11, 0.1);
    border-radius: 4px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(245, 158, 11, 0.6);
    border-radius: 4px;
    transition: background 0.3s ease;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(245, 158, 11, 0.8);
  }

  /* Shimmer Animation for Filter Buttons */
  @keyframes shimmer {
    0% {
      background-position: -200px 0;
    }
    100% {
      background-position: calc(200px + 100%) 0;
    }
  }

  .submission-filter-btn {
    position: relative;
    overflow: hidden;
  }

  .submission-filter-btn.active {
    background-image: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    background-size: 200px 100%;
    background-repeat: no-repeat;
  }

  /* Collapsible Section Animation */
  .section-content {
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
    max-height: 2000px; /* Start expanded */
    opacity: 1;
  }

  /* Timeline View Button Styles */
  .timeline-view-btn.active {
    background: linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6)) !important;
    color: white !important;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }

  /* Submission History & Analytics Collapsible Section Styles */
  .section-content {
    max-height: 2000px;
    opacity: 1;
    overflow: hidden;
    transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
  }

  .section-content.collapsed {
    max-height: 0;
    opacity: 0;
    transition: max-height 0.3s ease-in, opacity 0.2s ease-in;
  }

  /* Timeline Tab Button Styles */
  .timeline-tab-button {
    color: #6B7280;
    background-color: transparent;
  }

  .timeline-tab-button.active {
    background: linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6));
    color: white;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }

  .timeline-tab-button:not(.active):hover {
    background-color: rgba(245, 158, 11, 0.1);
    color: rgb(217, 119, 6);
  }

  /* Submission Tab Button Styles - Individual Color Themes */
  .submission-tab-button {
    color: #6B7280;
    background-color: transparent;
  }

  /* All Submissions Tab - Gold Theme */
  .submission-tab-button#allSubmissionsTab.active {
    background: linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6));
    color: white;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }

  /* Pending Review Tab - Brown with Gold Accent */
  .submission-tab-button#pendingReviewTab.active {
    background: linear-gradient(135deg, rgb(245, 158, 11), rgb(160, 82, 45));
    color: white;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }

  /* Approved Tab - Green Gradient */
  .submission-tab-button#approvedTab.active {
    background: linear-gradient(135deg, rgb(16, 185, 129), rgb(5, 150, 105));
    color: white;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
  }

  /* Needs Revision Tab - Red Gradient */
  .submission-tab-button#needsRevisionTab.active {
    background: linear-gradient(135deg, rgb(239, 68, 68), rgb(220, 38, 38));
    color: white;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
  }

  /* Under Review by Secretariat Tab - Light Blue with Blue Accent */
  .submission-tab-button#underReviewTab.active {
    background: linear-gradient(135deg, rgb(59, 130, 246), rgb(29, 78, 216));
    color: white;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
  }

  /* Validated by Secretariat Tab - Green Gradient with Light Green Accent */
  .submission-tab-button#validatedTab.active {
    background: linear-gradient(135deg, rgb(16, 185, 129), rgb(34, 197, 94));
    color: white;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
  }

  /* Individual Hover Effects for Each Tab */
  .submission-tab-button#allSubmissionsTab:not(.active):hover {
    background-color: rgba(245, 158, 11, 0.1);
    color: rgb(217, 119, 6);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
  }

  .submission-tab-button#pendingReviewTab:not(.active):hover {
    background-color: rgba(160, 82, 45, 0.1);
    color: rgb(160, 82, 45);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(160, 82, 45, 0.2);
  }

  .submission-tab-button#approvedTab:not(.active):hover {
    background-color: rgba(16, 185, 129, 0.1);
    color: rgb(5, 150, 105);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
  }

  .submission-tab-button#needsRevisionTab:not(.active):hover {
    background-color: rgba(239, 68, 68, 0.1);
    color: rgb(220, 38, 38);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
  }

  .submission-tab-button#underReviewTab:not(.active):hover {
    background-color: rgba(59, 130, 246, 0.1);
    color: rgb(29, 78, 216);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
  }

  .submission-tab-button#validatedTab:not(.active):hover {
    background-color: rgba(34, 197, 94, 0.1);
    color: rgb(22, 163, 74);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
  }

  /* Enhanced Project Timeline Styles - LGU-IU IOO Theme */
  .section-content {
    max-height: 2000px;
    opacity: 1;
    overflow: hidden;
    transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
  }

  .section-content.collapsed {
    max-height: 0;
    opacity: 0;
    transition: max-height 0.3s ease-in, opacity 0.2s ease-in;
  }

  .section-content.expanded {
    max-height: 2000px;
    opacity: 1;
  }

  /* Timeline Section Container */
  .timeline-section-container {
    background: linear-gradient(135deg, rgba(249, 250, 251, 0.8), rgba(234, 179, 8, 0.1));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(234, 179, 8, 0.2);
  }

  /* Timeline Progress Line Animation */
  @keyframes progressFlow {
    0% { width: 0%; }
    100% { width: var(--progress-width); }
  }

  #progressLine {
    animation: progressFlow 2s ease-out forwards;
  }

  /* Milestone Dot Hover Effects */
  .milestone-dot {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .milestone-dot:hover {
    transform: translate(-50%, -50%) scale(1.3);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    z-index: 10;
  }

  /* Toggle Chevron Animation */
  .toggle-chevron svg {
    transition: transform 0.3s ease;
  }

  .toggle-chevron:hover {
    transform: scale(1.1) rotate(3deg);
  }

  /* Enhanced Button Styles for LGU-IU IOO Theme */
  .btn-warning {
    background: linear-gradient(135deg, rgb(245, 158, 11), rgb(217, 119, 6));
    color: white;
    border: 1px solid rgb(217, 119, 6);
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }

  .btn-warning:hover {
    background: linear-gradient(135deg, rgb(217, 119, 6), rgb(180, 83, 9));
    border-color: rgb(180, 83, 9);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
  }

  /* Gold Scrollbar Theme for Timeline */
  .timeline-section-container::-webkit-scrollbar {
    height: 8px;
  }

  .timeline-section-container::-webkit-scrollbar-track {
    background: #fef3c7;
    border-radius: 4px;
  }

  .timeline-section-container::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #eab308, #ca8a04);
    border-radius: 4px;
  }

  .timeline-section-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(90deg, #ca8a04, #a16207);
  }

  /* Gold Button Theme for LGU-IU IOO */
  .btn-gold {
    background: linear-gradient(135deg, rgb(234, 179, 8), rgb(202, 138, 4));
    color: white;
    border: 1px solid rgb(202, 138, 4);
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(234, 179, 8, 0.3);
    position: relative;
    overflow: hidden;
  }

  .btn-gold::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease-out;
    z-index: 1;
  }

  .btn-gold > * {
    position: relative;
    z-index: 2;
  }

  .btn-gold:hover::before {
    left: 100%;
  }

  .btn-gold:hover {
    background: linear-gradient(135deg, rgb(202, 138, 4), rgb(161, 98, 7));
    border-color: rgb(161, 98, 7);
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }

  /* Timeline Loading Animation */
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  /* Timeline Legend Enhancements */
  .timeline-section-container .bg-white {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
  }

  /* Responsive Timeline Adjustments */
  @media (max-width: 768px) {
    .timeline-section-container {
      padding: 1rem;
    }
    
    #dateRuler,
    #percentageRuler {
      font-size: 0.75rem;
    }
    
    .milestone-dot {
      width: 12px;
      height: 12px;
    }
  }

  /* MILESTONE COLLAPSIBLE FIX - Override previous section-content rules */
  .section-content[id$="-content"] {
    max-height: 0 !important;
    overflow: hidden !important;
    opacity: 0 !important;
    transition: max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease, transform 0.3s ease !important;
    transform: translateY(-10px) !important;
  }

  .section-content[id$="-content"].expanded {
    max-height: none !important; /* Allow unlimited height */
    opacity: 1 !important;
    transform: translateY(0) !important;
    overflow: visible !important;
    transition: max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease, transform 0.3s ease !important;
    height: auto !important; /* Ensure natural height */
  }

  /* Icon rotation animation for milestones */
  .milestone-icon {
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1) !important;
  }

  .milestone-icon.rotated {
    transform: rotate(180deg) !important;
  }

  /* Chevron rotation for section headers - Matching submit-update.astro */
  .toggle-chevron {
    transition: transform 0.3s ease !important;
  }

  .toggle-chevron.rotated {
    transform: rotate(180deg) !important;
  }

  .toggle-chevron svg {
    transition: transform 0.3s ease !important;
  }

  /* Ensure milestone content containers have proper height */
  .section-content[id$="-content"] .p-6 {
    min-height: auto !important;
    height: auto !important;
  }

  /* Override any height constraints on milestone containers */
  .section-content[id$="-content"].expanded .p-6 {
    max-height: none !important;
    overflow: visible !important;
    height: auto !important;
  }

  /* Ensure milestone card containers don't restrict height */
  .section-content[id$="-content"].expanded {
    min-height: auto !important;
  }

  /* Override any parent container height constraints */
  #projectMilestonesContainer .section-content[id$="-content"].expanded {
    max-height: none !important;
    height: auto !important;
    overflow: visible !important;
  }

  /* Ensure all milestone content divs expand properly */
  .section-content[id$="-content"].expanded > div {
    max-height: none !important;
    height: auto !important;
  }

  /* Simple collapsible sections - Matching submit-update.astro exactly */
  .section-content:not(.expanded) {
    max-height: 0 !important;
    opacity: 0 !important;
    transform: translateY(-10px) !important;
    overflow: hidden !important;
    transition: max-height 0.3s ease-in, opacity 0.2s ease-in, transform 0.3s ease-in !important;
  }

  .section-content.expanded {
    max-height: 6000px !important;
    opacity: 1 !important;
    transform: translateY(0) !important;
    overflow: visible !important;
    transition: max-height 0.5s ease-out, opacity 0.3s ease-out, transform 0.3s ease-out !important;
  }

  /* Keep milestone containers flexible when expanded */
  .section-content.expanded #projectMilestonesContainer {
    max-height: none !important;
    height: auto !important;
    overflow: visible !important;
  }
</style>
  <IUImplementingOfficeLayout>
    <!-- Page Header - LGU-IU IOO Theme -->
    <div class="bg-white border-b border-gray-200 px-8 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-3">
            <div class="icon-container bg-gradient-to-br from-amber-500 to-amber-600 shadow-xl">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-amber-600 bg-clip-text text-transparent">Progress Timeline and Submission Update</h1>
              <p class="text-sm text-gray-600">Implementing Office - Project Progress Monitoring and EIU Submission Review</p>
            </div>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-sm text-gray-600">Active Projects</p>
            <p class="text-xs text-black font-semibold" id="headerProjectCount">0 Projects Available</p>
          </div>
          <div class="w-4 h-4 bg-amber-500 rounded-full animate-pulse shadow-lg"></div>
        </div>
      </div>
    </div>

    <main class="bg-gradient-to-br from-gray-50 via-amber-50 to-white min-h-screen px-8 py-8">
      <!-- Action Buttons -->
      <div class="flex items-center justify-end gap-3 mb-8">
        <button onclick="exportProgressReport()" class="btn-success btn-sm inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Export Report
        </button>
        <button onclick="loadProgressTimeline()" class="btn-primary btn-sm inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh Data
        </button>
      </div>

      <!-- Enhanced Summary Cards - LGU-IU IOO Theme -->
      <div class="space-y-6 mb-8">
        <!-- Top Row: Primary Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Total Projects - LGU-IU IOO primary color theme -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('total')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Total Projects</p>
                <p class="text-2xl font-bold text-black" id="totalProjectsCount">0</p>
                <p class="text-xs text-amber-600 mt-1">All assigned projects</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-amber-500 to-amber-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Pending Submissions - Professional Light Gold -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('pending')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Pending Submissions</p>
                <p class="text-2xl font-bold text-black" id="pendingSubmissionsCount">0</p>
                <p class="text-xs text-orange-600 mt-1">Awaiting review</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-orange-500 to-orange-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Completed Reviews - Professional Light Green -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('completed')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Completed Reviews</p>
                <p class="text-2xl font-bold text-black" id="completedReviewsCount">0</p>
                <p class="text-xs text-green-600 mt-1">Successfully reviewed</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-green-500 to-green-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Delayed Projects - Professional Light Red -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('delayed')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Delayed Projects</p>
                <p class="text-2xl font-bold text-black" id="delayedProjectsCount">0</p>
                <p class="text-xs text-red-600 mt-1">Behind schedule</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-red-500 to-red-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom Row: Status Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Ongoing Projects - Professional Blue -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('ongoing')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Ongoing Projects</p>
                <p class="text-2xl font-bold text-black" id="ongoingProjectsCount">0</p>
                <p class="text-xs text-blue-600 mt-1">In progress</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-blue-500 to-blue-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Needs Revision - Professional Orange -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('revision')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Needs Revision</p>
                <p class="text-2xl font-bold text-black" id="needsRevisionCount">0</p>
                <p class="text-xs text-purple-600 mt-1">Requires updates</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-purple-500 to-purple-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Average Progress - LGU-IU IOO primary color theme -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('progress')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Average Progress (%)</p>
                <p class="text-2xl font-bold text-black" id="averageProgressPercent">0</p>
                <p class="text-xs text-amber-600 mt-1">Overall completion</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-amber-500 to-amber-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- Total Budget Monitored - Professional Teal -->
          <div class="profile-card p-6 cursor-pointer summary-card" onclick="filterByCard('budget')">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600">Total Budget Monitored (â‚±)</p>
                <p class="text-2xl font-bold text-black" id="totalBudgetMonitored">0</p>
                <p class="text-xs text-teal-600 mt-1">Under supervision</p>
              </div>
              <div class="icon-container bg-gradient-to-br from-teal-500 to-teal-600">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7 6V4h2v2h6a3 3 0 0 1 0 6h-6v2h8v2h-8v2H7v-2H5v-2h2v-2H5V8h2V6h0zm2 2v4h6a1 1 0 0 0 0-2H9V8h6a1 1 0 0 0 0-2H9z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Project Selection & Content Section -->
      <div class="profile-card p-8 mb-8">
        <!-- Enhanced Filters Section -->
        <div class="mb-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-black">Filters & Project Selection</h3>
          </div>
          
          <div class="bg-gradient-to-br from-gray-50 to-gray-100/50 rounded-2xl p-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">Search Projects</label>
                <div class="relative">
                  <input 
                    type="text" 
                    id="projectSearchInput" 
                    placeholder="Search by project name..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 bg-white hover:shadow-md"
                  >
                  <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>
              
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">Status</label>
                <select 
                  id="statusFilter" 
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 bg-white hover:shadow-md"
                >
                  <option value="">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="ongoing">Ongoing</option>
                  <option value="delayed">Delayed</option>
                  <option value="completed">Completed</option>
                </select>
              </div>
              
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">Priority</label>
                <select 
                  id="priorityFilter" 
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 bg-white hover:shadow-md"
                >
                  <option value="">All Priorities</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              
              <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">Sort By</label>
                <select 
                  id="sortFilter" 
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 bg-white hover:shadow-md"
                >
                  <option value="name">Project Name</option>
                  <option value="date">Due Date</option>
                  <option value="progress">Progress</option>
                  <option value="priority">Priority</option>
                </select>
              </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 mt-6">
              <button onclick="applyFilters()" class="btn-primary inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                </svg>
                Apply Filters
              </button>
              <button onclick="clearFilters()" class="btn-secondary inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Clear Filters
              </button>
            </div>
          </div>
        </div>

        <!-- Project Selection Section -->
        <div class="mb-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
            </div>
            <div>
              <h3 class="text-xl font-bold text-black">Select Project for Progress Timeline</h3>
              <p class="text-gray-600">Choose a project to view detailed progress monitoring and submission reviews</p>
            </div>
          </div>
          
          <div class="bg-gradient-to-br from-amber-50 to-gray-50 rounded-2xl p-6 border border-amber-200">
            <!-- Horizontal Scrolling Project Cards -->
            <div class="relative">
              <div class="flex overflow-x-auto gap-6 pb-4 scrollbar-thin scrollbar-thumb-amber-300 scrollbar-track-amber-100" id="projectsGrid">
                <!-- Project cards will be inserted here by JavaScript -->
              </div>
              <!-- Scroll indicators -->
              <button id="scrollLeft" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white shadow-lg rounded-full p-2 z-10 transition-all duration-200 hover:scale-110 hidden">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button id="scrollRight" class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-white/90 hover:bg-white shadow-lg rounded-full p-2 z-10 transition-all duration-200 hover:scale-110 hidden">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      {loading ? (
        <div class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#92751F]"></div>
          <span class="ml-3 text-gray-600">Loading progress timeline...</span>
        </div>
      ) : error ? (
        <div class="text-center py-12">
          <p class="text-red-600 mb-4">{error}</p>
          <button onclick="loadProgressTimeline()" class="px-4 py-2 bg-[#92751F] text-white rounded-lg hover:bg-[#7A6219] transition-all">
            Try Again
          </button>
        </div>
      ) : projects.length === 0 ? (
        <div class="text-center py-12">
          <svg class="w-24 h-24 text-gray-400 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
          <h3 class="text-xl font-semibold text-gray-800 mb-2">No Projects Available</h3>
          <p class="text-gray-600 mb-6">You don't have any projects to update. Create a project first to start monitoring progress.</p>
          <button onclick="window.location.href='/dashboard/iu-implementing-office/modules/project-management'" class="px-6 py-3 bg-[#92751F] text-white rounded-lg hover:bg-[#7A6219] transition-colors flex items-center gap-2 mx-auto">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Create New Project
          </button>
        </div>
      ) : (
        <!-- Redundant Selected Project Info section removed - consolidated into Project Management Dashboard -->

        <!-- Project Management Dashboard -->
        <div id="projectManagementDashboard" class="profile-card mb-8" style="display: none;">
          <!-- Dashboard Header -->
          <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="icon-container-small bg-white/20 hover:bg-white/30">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold">Project Management Dashboard</h3>
                  <p class="text-white/80 text-sm">Monitor and manage project progress</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="refreshProjectData()" class="icon-container-small bg-white/10 hover:bg-white/20 transition-all duration-300">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Dashboard Content -->
          <div class="p-6">
            <!-- Project Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <!-- Overall Progress -->
              <div class="bg-gradient-to-br from-blue-50 to-cyan-100 rounded-xl p-6 border border-blue-200 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                  <span class="text-2xl font-bold text-blue-800" id="overallProgress">0.00%</span>
                </div>
                <h4 class="font-semibold text-blue-800 mb-1">Overall Progress</h4>
                <p class="text-blue-600 text-sm">Total project completion</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2 overflow-hidden">
                  <div 
                    class="h-2 rounded-full transition-all duration-2000 ease-out dashboard-progress-bar-fill"
                    id="overallProgressBar" 
                    style="width: 0%"
                    data-progress="0"
                    data-progress-color="bg-gray-500"
                  ></div>
                </div>
              </div>

              <!-- Timeline Progress -->
              <div class="bg-gradient-to-br from-purple-50 to-indigo-100 rounded-xl p-6 border border-purple-200 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <span class="text-2xl font-bold text-purple-800" id="timelineProgress">0.0%</span>
                </div>
                <h4 class="font-semibold text-purple-800 mb-1">Timeline Progress</h4>
                <p class="text-purple-600 text-sm">Overall timeline completion</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2 overflow-hidden">
                  <div 
                    class="h-2 rounded-full transition-all duration-2000 ease-out dashboard-progress-bar-fill"
                    id="timelineProgressBar" 
                    style="width: 0%"
                    data-progress="0"
                    data-progress-color="bg-gray-500"
                  ></div>
                </div>
              </div>

              <!-- Budget Progress -->
              <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-6 border border-green-200 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M7 6V4h2v2h6a3 3 0 0 1 0 6h-6v2h8v2h-8v2H7v-2H5v-2h2v-2H5V8h2V6h0zm2 2v4h6a1 1 0 0 0 0-2H9V8h6a1 1 0 0 0 0-2H9z"/>
                    </svg>
                  </div>
                  <span class="text-2xl font-bold text-green-800" id="budgetProgress">0.0%</span>
                </div>
                <h4 class="font-semibold text-green-800 mb-1">Budget Progress</h4>
                <p class="text-green-600 text-sm">Budget utilization</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2 overflow-hidden">
                  <div 
                    class="h-2 rounded-full transition-all duration-2000 ease-out dashboard-progress-bar-fill"
                    id="budgetProgressBar" 
                    style="width: 0%"
                    data-progress="0"
                    data-progress-color="bg-gray-500"
                  ></div>
                </div>
              </div>

              <!-- Physical Progress -->
              <div class="bg-gradient-to-br from-orange-50 to-red-100 rounded-xl p-6 border border-orange-200 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                  <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                  </div>
                  <span class="text-2xl font-bold text-orange-800" id="physicalProgress">0.0%</span>
                </div>
                <h4 class="font-semibold text-orange-800 mb-1">Physical Progress</h4>
                <p class="text-orange-600 text-sm">Physical completion</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2 overflow-hidden">
                  <div 
                    class="h-2 rounded-full transition-all duration-2000 ease-out dashboard-progress-bar-fill"
                    id="physicalProgressBar" 
                    style="width: 0%"
                    data-progress="0"
                    data-progress-color="bg-gray-500"
                  ></div>
                </div>
              </div>
            </div>

            <!-- Project Information -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <!-- Basic Information -->
              <div class="bg-gray-50 rounded-xl p-6">
                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Project Information
                </h4>
                <div class="space-y-3" id="projectBasicInfo">
                  <!-- Will be populated by JavaScript -->
                </div>
              </div>

              <!-- Status and Milestones -->
              <div class="bg-gray-50 rounded-xl p-6">
                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                  </svg>
                  Status & Milestones
                </h4>
                <div class="space-y-3" id="projectStatusInfo">
                  <!-- Will be populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-3">
              <button onclick="viewProjectDetails()" class="btn-gold btn-sm inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                View
              </button>
              <button onclick="viewProjectTimeline()" class="btn-gold btn-sm inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                View Timeline
              </button>
              <button onclick="viewSubmission()" class="btn-gold btn-sm inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                View Submission
              </button>
              <button onclick="viewSubmissionHistory()" class="btn-gold btn-sm inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                View Submission History
              </button>
            </div>

            <!-- Enhanced Project Timeline Section - Inside Dashboard -->
            <div class="mt-8 pt-6 border-t border-gray-200">
              <div class="profile-card border border-yellow-200">
                <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 px-6 py-4 border-b border-yellow-200 cursor-pointer hover:from-yellow-100 hover:to-yellow-200 transition-all duration-300 group" 
                     onclick="toggleProjectSection('timeline')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                      <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600 group-hover:from-yellow-600 group-hover:to-yellow-700">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="text-lg font-bold text-black group-hover:text-yellow-800 transition-colors duration-300">Project Timeline</h4>
                        <p class="text-sm text-gray-600">Visual timeline representation of project milestones</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <button onclick="event.stopPropagation(); refreshProjectTimeline()" class="btn-gold btn-sm inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                      </button>
                      <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 toggle-chevron hover:from-amber-600 hover:to-amber-700 hover:scale-110 hover:rotate-3 transition-all duration-300 border-2 border-amber-400 hover:border-amber-300 rounded-xl" data-section="timeline">
                        <svg class="w-4 h-4 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="timelineSection" class="section-content">
                  <div class="p-6">
                    <!-- Modern Timeline Container -->
                    <div id="modernTimelineContainer" class="relative">
                      <!-- Timeline Loading State -->
                      <div id="timelineLoading" class="flex items-center justify-center py-12">
                        <div class="flex items-center gap-3">
                          <div class="animate-spin rounded-full h-6 w-6 border-2 border-yellow-500 border-t-transparent"></div>
                          <span class="text-gray-600 font-medium">Loading timeline...</span>
                        </div>
                      </div>
                      
                      <!-- Modern Timeline Track -->
                      <div id="modernTimeline" class="hidden">
                        <!-- Project Dates Header -->
                        <div class="flex justify-between items-start mb-6">
                          <div class="flex flex-col space-y-2 text-sm text-gray-600">
                            <div>
                              <span class="font-semibold">Start:</span>
                              <span id="timelineStartDate" class="ml-1">Loading...</span>
                            </div>
                            <div>
                              <span class="font-semibold">Actual:</span>
                              <span id="timelineActualDate" class="ml-1">Loading...</span>
                            </div>
                          </div>
                          <div class="text-center">
                            <div id="projectNameDisplay" class="text-lg font-bold text-gray-900 mb-1">Loading...</div>
                            <div id="projectProgressDisplay" class="text-sm font-semibold text-yellow-600">0.0%</div>
                          </div>
                          <div class="flex flex-col space-y-2 text-sm text-gray-600">
                            <div>
                              <span class="font-semibold">Target:</span>
                              <span id="timelineTargetDate" class="ml-1">Loading...</span>
                            </div>
                            <div>
                              <span class="font-semibold">Days:</span>
                              <span id="timelineExpectedDays" class="ml-1">Loading...</span>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Timeline SVG Container -->
                        <div class="timeline-section-container relative bg-gradient-to-r from-gray-50 to-yellow-50 rounded-2xl p-8 border border-gray-200">
                          <!-- Date Ruler (Above Timeline) -->
                          <div class="relative mb-4">
                            <!-- Date Markers Container -->
                            <div id="dateRuler" class="relative" style="min-height: 32px;">
                              <!-- Dynamic date markers will be inserted here -->
                            </div>
                            
                            <!-- Date Ruler Line (same length as main timeline) -->
                            <div class="absolute bottom-0 left-8 right-8 h-px bg-gradient-to-r from-gray-300 via-yellow-300 to-gray-300"></div>
                          </div>
                          
                          <div class="relative h-20">
                            <!-- Connecting Line Background -->
                            <div class="absolute top-1/2 left-8 right-8 h-1 bg-gray-200 rounded-full transform -translate-y-1/2"></div>
                            
                            <!-- Animated Progress Line -->
                            <div id="progressLine" class="absolute top-1/2 left-8 h-1 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-full transform -translate-y-1/2 transition-all duration-1000 ease-out" style="width: 0%"></div>
                            
                            <!-- Timeline Milestones Container -->
                            <div id="timelineMilestonesContainer" class="absolute inset-0">
                              <!-- Milestone dots will be inserted here -->
                            </div>
                            
                            <!-- Vertical Connectors Container -->
                            <div id="verticalConnectors" class="absolute inset-0 pointer-events-none">
                              <!-- Dynamic vertical connectors will be generated here -->
                            </div>
                          </div>
                          
                          <!-- Enhanced Ruler-Style Percentage Indicators (5% intervals) -->
                          <div class="relative mt-6">
                            <!-- Ruler Line -->
                            <div class="absolute top-0 left-8 right-8 h-px bg-gradient-to-r from-gray-300 via-yellow-300 to-gray-300"></div>
                            
                            <!-- Percentage Markers Container (Dynamic 5% intervals) -->
                            <div id="percentageRuler" class="relative" style="min-height: 32px;">
                              <!-- Percentage markers will be generated dynamically -->
                            </div>
                          </div>
                          
                          <!-- Dynamic Milestone Position Indicators -->
                          <div id="milestonePercentageIndicators" class="relative mt-4" style="min-height: 24px;">
                            <!-- Dynamic percentage indicators for milestones will be inserted here -->
                          </div>
                        </div>
                        
                        <!-- Timeline Legend -->
                        <div class="mt-6 flex items-center justify-center gap-6 text-sm bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                          <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-green-500 rounded-full shadow-sm"></div>
                            <span class="font-medium text-gray-700">Completed</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-blue-500 rounded-full shadow-sm animate-pulse"></div>
                            <span class="font-medium text-gray-700">Ongoing</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-yellow-500 rounded-full border-2 border-yellow-600 bg-transparent shadow-sm"></div>
                            <span class="font-medium text-gray-700">Pending</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-red-500 rounded-full shadow-sm animate-pulse"></div>
                            <span class="font-medium text-gray-700">Delayed</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Milestone Summary Section - Collapsible -->
              <div class="profile-card border border-yellow-200 mt-6">
                <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 px-6 py-4 border-b border-yellow-200 cursor-pointer hover:from-yellow-100 hover:to-yellow-200 transition-all duration-300 group" 
                     onclick="toggleProjectSection('milestoneSummary')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                      <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600 group-hover:from-yellow-600 group-hover:to-yellow-700">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="text-lg font-bold text-black group-hover:text-yellow-800 transition-colors duration-300">Milestone Summary</h4>
                        <p class="text-sm text-gray-600">Overview of milestone status and budget allocation</p>
                      </div>
                    </div>
                    <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 toggle-chevron hover:from-amber-600 hover:to-amber-700 hover:scale-110 hover:rotate-3 transition-all duration-300 border-2 border-amber-400 hover:border-amber-300 rounded-xl" data-section="milestoneSummary">
                      <svg class="w-4 h-4 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                </div>
                
                                 <div id="milestoneSummarySection" class="section-content">
                   <div class="p-6">
                     <div id="milestoneSummaryContainer">
                       <!-- Milestone summary cards will be displayed here -->
                     </div>
                   </div>
                 </div>
               </div>

              <!-- Project Milestones Section - Collapsible -->
              <div class="profile-card border border-yellow-200 mt-6">
                <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 px-6 py-4 border-b border-yellow-200 cursor-pointer hover:from-yellow-100 hover:to-yellow-200 transition-all duration-300 group" 
                     onclick="toggleProjectSection('projectMilestones')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                      <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600 group-hover:from-yellow-600 group-hover:to-yellow-700">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                      </div>
                      <div>
                        <div class="flex items-center gap-3">
                          <h4 class="text-lg font-bold text-black group-hover:text-yellow-800 transition-colors duration-300">Project Milestones</h4>
                          <span id="totalMilestonesCounter" class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-xl" style="display: none;">0</span>
                        </div>
                        <p class="text-sm text-gray-600">View detailed information for all project milestones</p>
                      </div>
                    </div>
                    <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 toggle-chevron hover:from-amber-600 hover:to-amber-700 hover:scale-110 hover:rotate-3 transition-all duration-300 border-2 border-amber-400 hover:border-amber-300 rounded-xl" data-section="projectMilestones">
                      <svg class="w-4 h-4 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                </div>
                
                <div id="projectMilestonesSection" class="section-content">
                  <div class="p-6">
                    <div id="projectMilestonesContainer">
                      <!-- Project milestone cards will be displayed here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>




        <!-- Submission Review Center -->
        <div id="submissionReviewCenter" class="profile-card border border-yellow-200 mb-8" style="display: none;">
          <!-- Header -->
          <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 px-6 py-4 border-b border-yellow-200 cursor-pointer hover:from-yellow-100 hover:to-yellow-200 transition-all duration-300 group" 
               onclick="toggleSubmissionReviewCenter()" data-section="submissionReview">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 group-hover:from-amber-600 group-hover:to-amber-700">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-black group-hover:text-amber-800 transition-colors duration-300 flex items-center gap-3">
                    <span>Submission Review Center</span>
                    <span id="submissionNotificationBadge" class="hidden px-2 py-1 bg-red-500 text-white text-xs rounded-full font-medium animate-pulse">
                      <span id="submissionBadgeCount">0</span>
                    </span>
                  </h3>
                  <p class="text-sm text-gray-600">Review and process EIU milestone submissions</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="inline-flex items-center gap-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white rounded-lg px-4 py-2 shadow-sm hover:shadow-md transition-all duration-300 font-medium" id="submissionCount">
                  <div class="flex items-center gap-2">
                    <span class="bg-white/20 backdrop-blur-sm text-white text-sm font-bold px-3 py-1 rounded-full transition-all duration-300 hover:bg-white/30 min-w-[28px] text-center">0</span>
                    <span class="font-semibold text-sm">Submissions</span>
                  </div>
                </div>
                <button onclick="event.stopPropagation(); refreshSubmissions()" class="btn-gold btn-sm inline-flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Refresh
                </button>
                <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 toggle-chevron hover:from-amber-600 hover:to-amber-700 transition-all duration-200" data-section="submissionReview">
                  <svg class="w-5 h-5 text-white transition-transform duration-300 chevron-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Collapsible Content -->
          <div id="submissionReviewContent" class="section-content expanded transition-all duration-500 ease-in-out overflow-hidden">
            <div class="p-6 space-y-6">
              <!-- Filter Tabs - Single Row Design -->
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                  </div>
                  <h4 class="text-lg font-bold text-black">Filter Submissions</h4>
                </div>
                <div class="flex items-center bg-gray-100 rounded-xl p-1 overflow-x-auto">
                  <button onclick="filterSubmissions('all')" id="allSubmissionsTab" class="submission-tab-button active inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7l2 2-2 2m0 8l2-2-2-2"></path>
                    </svg>
                    All Submissions
                  </button>
                  <button onclick="filterSubmissions('pending_review')" id="pendingReviewTab" class="submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Pending Review
                  </button>
                  <button onclick="filterSubmissions('approved')" id="approvedTab" class="submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Approved
                  </button>
                  <button onclick="filterSubmissions('needs_revision')" id="needsRevisionTab" class="submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Needs Revision
                  </button>
                  <button onclick="filterSubmissions('under_review')" id="underReviewTab" class="submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Under Review by Secretariat
                  </button>
                  <button onclick="filterSubmissions('validated')" id="validatedTab" class="submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Validated by Secretariat
                  </button>
                </div>
              </div>

              <!-- Enhanced Submissions Container with Loading State -->
              <div id="submissionsContainer" class="space-y-4 min-h-[200px]">
                <!-- Loading State -->
                <div id="submissionsLoading" class="flex items-center justify-center py-12">
                  <div class="text-center">
                    <div class="inline-flex items-center px-6 py-4 bg-gradient-to-r from-amber-100 to-yellow-100 rounded-2xl border border-amber-200 shadow-sm">
                      <div class="animate-spin rounded-full h-6 w-6 border-2 border-amber-500 border-t-transparent mr-3"></div>
                      <span class="text-amber-700 font-semibold">Loading milestone submissions...</span>
                    </div>
                  </div>
                </div>
                <!-- Empty State -->
                <div id="submissionsEmpty" class="hidden text-center py-16">
                  <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-amber-100 to-yellow-100 rounded-2xl flex items-center justify-center">
                    <svg class="w-12 h-12 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                  </div>
                  <h3 class="text-xl font-bold text-gray-700 mb-2">No Submissions Yet</h3>
                  <p class="text-gray-500 mb-4">EIU milestone submissions will appear here for your review</p>
                  <div class="text-sm text-amber-600 bg-amber-50 border border-amber-200 rounded-lg p-3 max-w-md mx-auto">
                    <strong>Tip:</strong> Submissions are automatically fetched when EIU personnel submit milestone updates
                  </div>
                </div>
                <!-- Submissions will be rendered here dynamically -->
              </div>
            </div>
          </div>
        </div>

        <!-- Submission History & Analytics -->
        <div class="profile-card border border-yellow-200 mb-8">
          <!-- Header -->
          <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 px-6 py-4 border-b border-yellow-200 cursor-pointer hover:from-yellow-100 hover:to-yellow-200 transition-all duration-300 group" 
               onclick="toggleProjectSection('submissionHistory')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 group-hover:from-amber-600 group-hover:to-amber-700">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-black group-hover:text-amber-800 transition-colors duration-300">Submission History & Analytics</h3>
                  <p class="text-sm text-gray-600">Track your milestone submissions and performance metrics</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <button onclick="event.stopPropagation(); exportSubmissionReport()" class="btn-warning btn-sm inline-flex items-center gap-2 hover:bg-amber-600 hover:border-amber-600 transition-all duration-200">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Export Report
                </button>
                <button onclick="event.stopPropagation(); refreshSubmissionHistory()" class="btn-gold btn-sm inline-flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  Refresh Data
                </button>
                <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600 toggle-chevron hover:from-amber-600 hover:to-amber-700 transition-all duration-200" data-section="submissionHistory">
                  <svg class="w-5 h-5 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Collapsible Content -->
          <div id="submissionHistorySection" class="section-content">
            <div class="p-6">
            <!-- Enhanced History Summary -->
            <div id="historySummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <!-- Total Submissions Card -->
              <div class="profile-card p-6 hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Total Submissions</p>
                    <p class="text-2xl font-bold text-black" id="analyticsTotal">0</p>
                    <p class="text-xs text-amber-600 mt-1">Milestone updates</p>
                  </div>
                  <div class="icon-container bg-gradient-to-br from-amber-500 to-amber-600">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                  </div>
                </div>
              </div>
              
              <!-- Pending Review Card -->
              <div class="profile-card p-6 hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Pending Review</p>
                    <p class="text-2xl font-bold text-black" id="analyticsPending">0</p>
                    <p class="text-xs text-orange-600 mt-1">Awaiting decision</p>
                  </div>
                  <div class="icon-container bg-gradient-to-br from-orange-500 to-orange-600">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                </div>
              </div>
              
              <!-- Approved Updates Card -->
              <div class="profile-card p-6 hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Approved</p>
                    <p class="text-2xl font-bold text-black" id="analyticsApproved">0</p>
                    <p class="text-xs text-green-600 mt-1">Successfully finished</p>
                  </div>
                  <div class="icon-container bg-gradient-to-br from-green-500 to-green-600">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                </div>
              </div>
              
              <!-- Rejected Updates Card -->
              <div class="profile-card p-6 hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-gray-600">Needs Revision</p>
                    <p class="text-2xl font-bold text-black" id="analyticsRejected">0</p>
                    <p class="text-xs text-red-600 mt-1">Needs revision</p>
                  </div>
                  <div class="icon-container bg-gradient-to-br from-red-500 to-red-600">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Analytics Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <!-- EIU Submission Trend Chart -->
              <div class="profile-card p-6 hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                  <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                  </div>
                  <h4 class="text-lg font-bold text-black">EIU Submission Trend</h4>
                </div>
                <div id="submissionTrendChart" class="h-48 flex items-center justify-center bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl border border-amber-200">
                  <div class="text-center">
                    <svg class="w-12 h-12 text-amber-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <p class="text-amber-600 text-sm font-medium">Submission trend will appear after updates</p>
                  </div>
                </div>
              </div>
              
              <!-- Review Completion Curve Chart -->
              <div class="profile-card p-6 hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                  <div class="icon-container-small bg-gradient-to-br from-green-500 to-green-600">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                  <h4 class="text-lg font-bold text-black">Review Completion Curve</h4>
                </div>
                <div id="reviewCurveChart" class="h-48 flex items-center justify-center bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200">
                  <div class="text-center">
                    <svg class="w-12 h-12 text-green-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p class="text-green-600 text-sm font-medium">Review curve will appear after submissions</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Timeline View Toggle -->
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-3">
                <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <h4 class="text-lg font-bold text-black">Submission Timeline</h4>
              </div>
              <div class="flex items-center bg-gray-100 rounded-xl p-1">
                <button id="listViewBtn" class="timeline-tab-button active inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                  </svg>
                  List View
                </button>
                <button id="timelineViewBtn" class="timeline-tab-button inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Timeline View
                </button>
              </div>
            </div>
            
            <!-- Chronological Timeline View -->
            <div id="submissionTimelineView" class="hidden">
              <div class="relative">
                <div class="absolute left-8 top-0 bottom-0 w-1 bg-gradient-to-b from-amber-200 via-amber-300 to-amber-400 rounded-full"></div>
                <div id="submissionTimelineContainer" class="space-y-8 pl-4">
                  <!-- Timeline items will be inserted here -->
                </div>
              </div>
            </div>
            
            <!-- Submissions List View -->
            <div id="submissionTimeline" class="space-y-4">
              <!-- Empty State -->
              <div class="text-center py-8 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm">No submissions yet</p>
                <p class="text-xs text-gray-400 mt-1">Submit your first milestone update to see detailed analytics, trends, and submission history appear here.</p>
                <div class="flex items-center justify-center gap-6 text-sm text-gray-500 mt-6">
                  <div class="flex items-center gap-2 px-3 py-2 bg-amber-50 rounded-lg border border-amber-200">
                    <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <span class="text-amber-700 font-medium">Submission Trends</span>
                  </div>
                  <div class="flex items-center gap-2 px-3 py-2 bg-amber-50 rounded-lg border border-amber-200">
                    <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="text-amber-700 font-medium">Review Analytics</span>
                  </div>
                  <div class="flex items-center gap-2 px-3 py-2 bg-amber-50 rounded-lg border border-amber-200">
                    <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="text-amber-700 font-medium">Export Reports</span>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>

      )}
      </div>
    </main>
  </IUImplementingOfficeLayout>

  <!-- Include MilestoneSubmissionModal -->
  <MilestoneSubmissionModal />
</Layout>

<script>
  // Make API_URL available to client-side JavaScript
  const API_URL = 'http://localhost:3000/api';
  let selectedProject = null;
  let projectUpdates = [];
  let projects = [];

  // Function to render projects grid
  function renderProjectsGrid(projectsData) {
    const projectsGrid = document.getElementById('projectsGrid');
    if (!projectsGrid) return;

    projectsGrid.innerHTML = '';

    projectsData.forEach(project => {
      // Use new field names from backend
      const overallProgress = parseFloat(project.progress?.overall || project.progress?.overallProgress || project.overallProgress || 0);
      const timelineProgress = parseFloat(project.progress?.timeline || project.progress?.internalTimeline || project.progress?.timelineProgress || project.timelineProgress || 0);
      const budgetProgress = parseFloat(project.progress?.budget || project.progress?.internalBudget || project.progress?.budgetProgress || project.budgetProgress || 0);
      const physicalProgress = parseFloat(project.progress?.physical || project.progress?.internalPhysical || project.progress?.physicalProgress || project.physicalProgress || 0);
      
      // Determine project status based on the three main statuses
      const projectStatus = project.status || 'pending';
      let statusText, statusClass;
      
      // Check for delayed milestones first
      let actualStatus = projectStatus;
      if (actualStatus !== 'completed' && actualStatus !== 'complete' && project.milestones && Array.isArray(project.milestones)) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const hasDelayedMilestones = project.milestones.some(milestone => {
          const dueDate = milestone.dueDate || milestone.deadline || milestone.targetDate || milestone.completionDate;
          const status = milestone.status || 'pending';
          
          if (dueDate && status !== 'completed' && status !== 'under_approval' && status !== 'revision_request') {
            const milestoneDate = new Date(dueDate);
            milestoneDate.setHours(0, 0, 0, 0);
            return milestoneDate < today && status === 'pending';
          }
          return false;
        });
        
        if (hasDelayedMilestones) {
          actualStatus = 'delayed';
        }
      }
      
      if (actualStatus.toLowerCase() === 'completed') {
        statusText = 'COMPLETE';
        statusClass = 'bg-green-100 text-green-700';
      } else if (actualStatus === 'delayed') {
        statusText = 'DELAYED';
        statusClass = 'bg-red-100 text-red-700 animate-pulse';
      } else if (project.approvedBySecretariat === true) {
        statusText = 'ONGOING';
        statusClass = 'bg-blue-100 text-blue-700';
      } else {
        statusText = 'PENDING';
        statusClass = 'bg-yellow-100 text-yellow-700';
      }

      const projectCard = document.createElement('div');
      projectCard.className = 'group project-card bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden transition-all duration-300 cursor-pointer transform hover:scale-[1.02] hover:-translate-y-1 hover:shadow-xl hover:border-amber-400 hover:shadow-amber-100 flex-shrink-0 w-96';
      projectCard.setAttribute('data-project-id', project.id);
      
      // Format budget properly
      const formatBudget = (amount) => {
        if (!amount) return 'â‚±0.00';
        const num = parseFloat(amount);
        if (isNaN(num)) return 'â‚±0.00';
        return `â‚±${num.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      };

      // Get project image with proper fallback
      const getProjectImage = (proj) => {
        if (proj.initialPhoto && proj.initialPhoto !== '' && proj.initialPhoto !== 'None') {
          return proj.initialPhoto.startsWith('http') ? proj.initialPhoto : `http://localhost:3000${proj.initialPhoto}`;
        }
        return '/projects-page-header-bg.png';
      };

      // Status color mapping
      const getStatusColor = (status) => {
        switch(status?.toLowerCase()) {
          case 'completed':
          case 'complete':
            return 'bg-green-100 text-green-700 border-green-200';
          case 'ongoing':
            return 'bg-blue-100 text-blue-700 border-blue-200';
          case 'delayed':
            return 'bg-red-100 text-red-700 border-red-200';
          case 'pending':
            return 'bg-yellow-100 text-yellow-700 border-yellow-200';
          default:
            return 'bg-gray-100 text-gray-600 border-gray-200';
        }
      };
      
      projectCard.innerHTML = `
        <!-- Project Image -->
        <div class="h-56 relative overflow-hidden">
          <img 
            src="${getProjectImage(project)}"
            alt="${project.name || project.projectName}"
            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
            loading="lazy"
            onerror="this.src='/projects-page-header-bg.png'"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
          
          <!-- Floating Status Badge -->
          <div class="absolute top-3 right-3">
            <span class="px-3 py-1 rounded-full text-xs font-semibold border backdrop-blur-sm ${getStatusColor(project.status)}">
              ${project.status || 'Not Started'}
            </span>
          </div>

          <!-- Category Badge -->
          <div class="absolute top-3 left-3">
            <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-white text-xs font-semibold border border-white/30">
              ${project.category || 'Infrastructure'}
            </span>
          </div>

          <!-- Progress Overlay -->
          <div class="absolute bottom-3 left-3 right-3">
            <div class="bg-white/90 backdrop-blur-sm rounded-lg p-2">
              <div class="flex justify-between items-center mb-1">
                <span class="text-xs font-medium text-gray-700">Overall Progress</span>
                <span class="text-xs font-bold text-gray-900">${overallProgress.toFixed(1)}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div 
                  class="h-2 rounded-full transition-all duration-2000 ease-out progress-bar-fill"
                  style="width: 0%"
                  data-progress="${overallProgress}"
                  data-progress-color="${overallProgress >= 0 && overallProgress <= 25 ? 'bg-red-500' : overallProgress >= 26 && overallProgress <= 50 ? 'bg-yellow-500' : overallProgress >= 51 && overallProgress <= 75 ? 'bg-blue-500' : overallProgress >= 76 && overallProgress <= 100 ? 'bg-green-500' : 'bg-gray-500'}"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Project Details -->
        <div class="p-6">
          <!-- Project Title -->
          <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-2">
            ${project.name || project.projectName}
          </h3>

          <!-- Project Code -->
          <div class="text-sm text-gray-500 mb-2">
            <span class="font-medium">Code:</span> ${project.projectCode || 'N/A'}
          </div>

          <!-- Project Description -->
          ${project.description ? `
            <div class="text-sm text-gray-600 mb-3 line-clamp-2">
              ${project.description}
            </div>
          ` : ''}

          <!-- Key Information Grid -->
          <div class="space-y-2 mb-4">
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 font-medium">Location:</span>
              <span class="text-gray-800">${project.location || 'N/A'}</span>
            </div>
            
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 font-medium">Implementing Office:</span>
              <span class="text-gray-800 text-right">${project.implementingOfficeName || project.implementingOffice || 'N/A'}</span>
            </div>

            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 font-medium">Budget:</span>
              <span class="text-gray-800 font-semibold">${formatBudget(project.totalBudget)}</span>
            </div>

            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600 font-medium">Funding Source:</span>
              <span class="text-gray-800">${project.fundingSource?.replace('_', ' ').toUpperCase() || 'N/A'}</span>
            </div>
          </div>

          <!-- Progress Breakdown -->
          <div class="space-y-2 mb-4">
            <div class="flex justify-between items-center text-xs">
              <span class="text-gray-600">Timeline:</span>
              <span class="font-semibold text-amber-600">${timelineProgress.toFixed(1)}%</span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-gray-600">Budget:</span>
              <span class="font-semibold text-amber-600">${budgetProgress.toFixed(1)}%</span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-gray-600">Physical:</span>
              <span class="font-semibold text-amber-600">${physicalProgress.toFixed(1)}%</span>
            </div>
          </div>

          <!-- Dates -->
          <div class="space-y-2 mb-4">
            <div class="flex justify-between items-center text-xs text-gray-500">
              <span>Start: ${project.startDate || project.createdDate || 'N/A'}</span>
              <span>Target: ${project.targetCompletionDate || project.targetDateOfCompletion || project.endDate || 'N/A'}</span>
            </div>
            <div class="flex justify-between items-center text-xs text-gray-500">
              <span>Actual: ${project.completionDate || project.actualCompletionDate || 'â€“'}</span>
              <span>Days: ${project.expectedDaysOfCompletion || 'â€“'}</span>
            </div>
          </div>

          <!-- Additional Information -->
          <div class="space-y-1 mb-4">
            <!-- Category -->
            <div class="text-xs text-gray-500">
              <span class="font-medium">ðŸ—ï¸ Category:</span> ${project.category?.charAt(0).toUpperCase() + project.category?.slice(1) || 'Infrastructure'}
            </div>
            
            <!-- Priority -->
            <div class="text-xs text-gray-500">
              <span class="font-medium">âš¡ Priority:</span> 
              <span class="font-semibold ${
                project.priority === 'high' ? 'text-red-600' : 
                project.priority === 'medium' ? 'text-yellow-600' : 
                'text-green-600'
              }">
                ${project.priority?.toUpperCase() || 'MEDIUM'}
              </span>
            </div>
          </div>

          <!-- Select Project Button -->
          <button 
            class="w-full py-3 px-4 rounded-lg font-semibold text-sm transition-all duration-300 bg-amber-50 text-amber-600 hover:bg-amber-100"
            onclick="event.stopPropagation()"
          >
            Select Project
          </button>
        </div>
      `;

      // Milestones information is now included in the standardized card design

      // Add click event listener
      projectCard.addEventListener('click', function() {
        selectProject(project.id);
      });

            projectsGrid.appendChild(projectCard);
    });
    
    console.log('âœ… Finished rendering', projectsData?.length, 'project cards');
    console.log('ðŸ” projectsGrid now has', projectsGrid.children.length, 'children');
      
      // Setup horizontal scroll functionality
    setupHorizontalScroll();

    // Animate progress bars after rendering
    setTimeout(() => {
      projectsData.forEach(async project => {
        try {
          // Fetch latest progress data for this project
          const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
          const timestamp = new Date().getTime();
          const progressResponse = await fetch(`${API_URL}/projects/progress/${project.id}?_t=${timestamp}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          let progressData = null;
          if (progressResponse.ok) {
            const progressResult = await progressResponse.json();
            if (progressResult.success) {
              progressData = progressResult.data;
            }
          }
          
          // Use progress data from backend or fallback to project data
          const overallProgress = progressData?.progress?.overall || parseFloat(project.progress?.overall || project.progress?.overallProgress || project.overallProgress || 0);
          const timelineProgress = progressData?.progress?.internalTimeline || parseFloat(project.progress?.timeline || project.progress?.internalTimeline || project.progress?.timelineProgress || project.timelineProgress || 0);
          const budgetProgress = progressData?.progress?.internalBudget || parseFloat(project.progress?.budget || project.progress?.internalBudget || project.progress?.budgetProgress || project.budgetProgress || 0);
          const physicalProgress = progressData?.progress?.internalPhysical || parseFloat(project.progress?.physical || project.progress?.internalPhysical || project.progress?.physicalProgress || project.physicalProgress || 0);

          const card = document.querySelector(`[data-project-id="${project.id}"]`);
          if (card) {
            const overallBar = card.querySelector('.bg-gradient-to-r.from-amber-500');
            const timelineBar = card.querySelector('.bg-gradient-to-r.from-blue-500');
            const budgetBar = card.querySelector('.bg-gradient-to-r.from-green-500');
            const physicalBar = card.querySelector('.bg-gradient-to-r.from-purple-500');

            if (overallBar) {
              overallBar.style.transition = 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
              overallBar.style.width = `${overallProgress}%`;
            }
            if (timelineBar) {
              timelineBar.style.transition = 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
              timelineBar.style.width = `${timelineProgress}%`;
            }
            if (budgetBar) {
              budgetBar.style.transition = 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
              budgetBar.style.width = `${budgetProgress}%`;
            }
            if (physicalBar) {
              physicalBar.style.transition = 'width 1.5s cubic-bezier(0.4, 0, 0.2, 1)';
              physicalBar.style.width = `${physicalProgress}%`;
            }
          }
        } catch (error) {
          console.error('Error animating progress for project:', project.id, error);
        }
      });
    }, 100);
  }

  // Global functions
  window.loadProgressTimeline = function() {
    console.log('Refreshing progress timeline...');
    loadProjects();
  };

  window.viewProjectDetails = function(projectId) {
    console.log('Viewing project details:', projectId);
    // Navigate to project details page
    window.location.href = `/project/${projectId}`;
  };

  window.toggleSecretariatNote = function(updateId) {
    console.log('toggleSecretariatNote called with updateId:', updateId);
    const noteSection = document.getElementById(`secretariat-note-${updateId}`);
    if (noteSection) {
      noteSection.classList.toggle('hidden');
      console.log('Note section toggled, hidden:', noteSection.classList.contains('hidden'));
    } else {
      console.log('Note section not found for updateId:', updateId);
    }
  }
  
  console.log('Global functions defined');

  // Load projects data
  async function loadProjects() {
    try {
      console.log('Loading projects data...');
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const timestamp = new Date().getTime();
      
      const response = await fetch(`${API_URL}/projects?_t=${timestamp}`, {
        headers: { 
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          projects = data.projects;
          console.log('Projects loaded:', projects.length);
          allProjects = projects; // Store for filtering
    renderProjectsGrid(projects);
    updateSummaryCards(projects);
    initializeSearchAndFilter();
    initializeStatusLifecycleMonitoring();
          
          // DO NOT auto-select any project - let user choose manually
          console.log('Projects loaded, waiting for user selection');
        } else {
          console.error('Failed to load projects:', data.message);
        }
      } else {
        console.error('Failed to fetch projects:', response.status);
      }
    } catch (error) {
      console.error('Error loading projects:', error);
    }
  }

  // Project selection functionality
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Progress Timeline page loaded');
    
    // Try to use server-side projects first, fallback to API
    if (window.initialProjectsData && window.initialProjectsData.length > 0) {
      console.log('Using server-side projects:', window.initialProjectsData.length);
      projects = window.initialProjectsData;
      allProjects = window.initialProjectsData;
      
      // Render projects immediately
      renderProjectsGrid(window.initialProjectsData);
      updateSummaryCards(window.initialProjectsData);
      initializeSearchAndFilter();
      initializeStatusLifecycleMonitoring();
      
      // Export enhanced timeline functions to window
      window.toggleProjectSection = toggleProjectSection;
      window.loadModernTimeline = loadModernTimeline;
      window.refreshProjectTimeline = refreshProjectTimeline;
      window.toggleMilestoneCard = toggleMilestoneCard;
      
      // Ensure all sections are collapsed by default
      setTimeout(() => {
        // Ensure dashboard is hidden
        const dashboard = document.getElementById('projectManagementDashboard');
        if (dashboard) {
          dashboard.style.display = 'none';
          console.log('âœ… Dashboard hidden by default');
        }
        
        // Simply ensure no sections have expanded class by default
        const sections = ['timeline', 'milestoneSummary', 'projectMilestones', 'submissionHistory', 'submissionReview'];
        sections.forEach(sectionName => {
          const section = document.getElementById(sectionName + 'Section');
          const chevron = document.querySelector(`[data-section="${sectionName}"]`);
          if (section) {
            section.classList.remove('expanded');
            console.log(`âœ… Section ${sectionName} collapsed by default`);
          }
          if (chevron) {
            chevron.classList.remove('rotated');
          }
        });
        
        // Force collapse all milestones
        forceCollapseAllMilestones();
        
        console.log('âœ… All sections properly collapsed on initialization');
      }, 100);
      
      // DO NOT auto-select any project - let user choose manually
      console.log('Server-side projects loaded, waiting for user selection');
    
    // Setup analytics section event listeners
    setupAnalyticsEventListeners();
    } else {
      console.log('No server-side projects, loading from API...');
      loadProjects();
      // Setup analytics section event listeners
      setupAnalyticsEventListeners();
    }
    
    // Check for project parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const projectParam = urlParams.get('project');
    if (projectParam) {
      console.log('Project parameter found in URL:', projectParam);
      // Wait a bit for projects to load, then select
      setTimeout(() => selectProject(projectParam), 500);
    }
  });

  // Select project and load details
  async function selectProject(projectId) {
    try {
      console.log('selectProject called with ID:', projectId);
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const timestamp = new Date().getTime();
      const response = await fetch(`http://localhost:3000/api/projects/${projectId}?_t=${timestamp}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      console.log('Project API response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        console.log('Project API response data:', data);
        
        if (data.success) {
          selectedProject = data.project;
          
          // Fetch progress data and merge it with the project
          try {
            const progressResponse = await fetch(`http://localhost:3000/api/projects/progress/${projectId}?_t=${timestamp}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (progressResponse.ok) {
              const progressData = await progressResponse.json();
              if (progressData.success) {
                selectedProject.progress = progressData.data.progress;
              }
            }
          } catch (error) {
            console.error('Error fetching progress data:', error);
          }
          
          console.log('Selected project with progress:', selectedProject);
          
          // Update Project Management Dashboard
          updateProjectManagementDashboard(selectedProject);
          
          // Show Submission Review Center
          showSubmissionReviewCenter();
          
          // Load milestone submissions for this specific project
          loadMilestoneSubmissions();
          
          // Show Submission History & Analytics
          showSubmissionHistoryAnalytics();
          
          await displayProjectUpdates(data.project);
          loadProjectUpdates(projectId);
          
          // Update active state
          document.querySelectorAll('.project-card').forEach(card => {
            card.classList.remove('ring-2', 'ring-[#92751F]');
          });
          const activeCard = document.querySelector(`[data-project-id="${projectId}"]`);
          if (activeCard) {
            activeCard.classList.add('ring-2', 'ring-[#92751F]');
            console.log('Updated active card styling');
          }
        } else {
          console.error('Project API returned success: false');
        }
      } else {
        console.error('Project API request failed with status:', response.status);
      }
    } catch (error) {
      console.error('Error fetching project details:', error);
    }
  }

  // Load project updates with enhanced EIU milestone data
  async function loadProjectUpdates(projectId) {
    try {
      console.log('Loading project updates for project:', projectId);
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const timestamp = new Date().getTime();
      
      // Fetch project progress data using the new ProgressCalculationService
      const progressResponse = await fetch(`http://localhost:3000/api/projects/progress/${projectId}?_t=${timestamp}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      let progressData = null;
      if (progressResponse.ok) {
        const progressResult = await progressResponse.json();
        if (progressResult.success) {
          progressData = progressResult.data;
        }
      }
      
      // Fetch project updates and milestones as fallback
      const [updatesResponse, milestonesResponse] = await Promise.all([
        fetch(`http://localhost:3000/api/projects/${projectId}/updates?_t=${timestamp}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch(`http://localhost:3000/api/projects/${projectId}/milestones?_t=${timestamp}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        })
      ]);
      
      let updates = [];
      let milestones = [];
      
      if (updatesResponse.ok) {
        const updatesData = await updatesResponse.json();
        if (updatesData.success) {
          updates = updatesData.updates || [];
        }
      }
      
      if (milestonesResponse.ok) {
        const milestonesData = await milestonesResponse.json();
        if (milestonesData.success) {
          milestones = milestonesData.milestones || [];
        }
      }
      
      // Create a map of milestones for quick lookup
      const milestonesMap = {};
      milestones.forEach(milestone => {
        milestonesMap[milestone.id] = milestone;
      });
      
      // Extract milestone updates from project updates
      const milestoneUpdates = [];
      updates.forEach(update => {
        if (update.milestoneUpdates && update.updateType === 'milestone') {
          try {
            const milestoneData = typeof update.milestoneUpdates === 'string' 
              ? JSON.parse(update.milestoneUpdates) 
              : update.milestoneUpdates;
            
            console.log('Parsed milestone data:', milestoneData);
            
            if (Array.isArray(milestoneData)) {
              milestoneData.forEach(milestoneUpdate => {
                console.log('Individual milestone update:', milestoneUpdate);
                // Get the original milestone data for planned dates and budget
                const originalMilestone = milestonesMap[milestoneUpdate.milestoneId];
                
                milestoneUpdates.push({
                  ...milestoneUpdate,
                  submittedBy: update.submittedBy,
                  submittedByRole: update.submittedByRole,
                  submittedAt: update.submittedAt,
                  status: update.status,
                  updateId: update.id,
                  updateType: 'milestone',
                  id: update.id, // Use the project update ID for the milestone update
                  isExtractedMilestone: true, // Flag to identify extracted milestone updates
                  milestoneId: milestoneUpdate.milestoneId, // Keep the original milestone ID
                  // Add planned milestone data
                  plannedStartDate: originalMilestone?.plannedStartDate || originalMilestone?.timelineStartDate,
                  plannedEndDate: originalMilestone?.plannedEndDate || originalMilestone?.timelineEndDate,
                  plannedBudget: originalMilestone?.plannedBudget || originalMilestone?.budgetPlanned,
                  milestoneTitle: originalMilestone?.title,
                  milestoneWeight: originalMilestone?.weight
                });
              });
            } else if (milestoneData && typeof milestoneData === 'object') {
              // Handle single milestone update object
              console.log('Single milestone update object:', milestoneData);
              // Get the original milestone data for planned dates and budget
              const originalMilestone = milestonesMap[milestoneData.milestoneId];
              
              milestoneUpdates.push({
                ...milestoneData,
                submittedBy: update.submittedBy,
                submittedByRole: update.submittedByRole,
                submittedAt: update.submittedAt,
                status: update.status,
                updateId: update.id,
                updateType: 'milestone',
                id: update.id,
                isExtractedMilestone: true, // Flag to identify extracted milestone updates
                milestoneId: milestoneData.milestoneId, // Keep the original milestone ID
                // Add planned milestone data
                plannedStartDate: originalMilestone?.plannedStartDate || originalMilestone?.timelineStartDate,
                plannedEndDate: originalMilestone?.plannedEndDate || originalMilestone?.timelineEndDate,
                plannedBudget: originalMilestone?.plannedBudget || originalMilestone?.budgetPlanned,
                milestoneTitle: originalMilestone?.title,
                milestoneWeight: originalMilestone?.weight
              });
            }
          } catch (error) {
            console.error('Error parsing milestone updates:', error);
          }
        }
      });
      
      // Filter out duplicate milestone updates - only keep the extracted ones
      const filteredUpdates = updates.filter(update => {
        // If it's a milestone update without the extracted flag, filter it out
        if (update.updateType === 'milestone' && !update.isExtractedMilestone) {
          return false;
        }
        return true;
      });
      
      // Add milestone updates to the filtered updates array
      updates = [...filteredUpdates, ...milestoneUpdates];
      
      projectUpdates = updates;
      console.log('Project updates loaded:', projectUpdates.length, 'total updates');
      console.log('Updates with milestone data:', updates.filter(u => u.milestoneUpdates).length);
      console.log('First update submitter data:', updates[0]?.submitter);
      console.log('First update submittedBy:', updates[0]?.submittedBy);
      
      displayUpdates(projectUpdates);
    } catch (error) {
      console.error('Error fetching project updates:', error);
    }
  }

  // Display project updates
  async function displayProjectUpdates(project, progressData = null) {
    console.log('displayProjectUpdates called with project:', project);
    console.log('Project object keys:', Object.keys(project));
    
    // Handle nested project structure from API response
    const actualProject = project.project || project;
    console.log('Actual project data:', actualProject);
    console.log('Project name:', actualProject.name);
    console.log('Project approvedBySecretariat:', actualProject.approvedBySecretariat);
    console.log('Project progress:', project.progress);
    console.log('Project progress keys:', project.progress ? Object.keys(project.progress) : 'No progress object');
    
    // Fetch progress data if not provided
    let localProgressData = progressData;
    if (!localProgressData && selectedProject && selectedProject.id) {
      try {
        const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
        const timestamp = new Date().getTime();
        const progressResponse = await fetch(`${API_URL}/projects/progress/${selectedProject.id}?_t=${timestamp}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (progressResponse.ok) {
          const progressResult = await progressResponse.json();
          if (progressResult.success) {
            localProgressData = progressResult.data;
          }
        }
      } catch (error) {
        console.error('Error fetching progress data:', error);
      }
    }
    
    // Show selected project info
    const milestonesSection = document.getElementById('milestonesSection');
    const updatesHistory = document.getElementById('updatesHistory');
    
    // selectedProjectInfo section removed - info now shown in Project Management Dashboard
    
    if (milestonesSection) {
      milestonesSection.style.display = 'block';
      console.log('Milestones section shown');
    } else {
      console.error('milestonesSection element not found');
    }
    
    if (updatesHistory) {
      updatesHistory.style.display = 'block';
      console.log('Updates history section shown');
    } else {
      console.error('updatesHistory element not found');
    }
    
    // Project info now updated in Project Management Dashboard section
    
    // Update project status based on the three main statuses
    const projectStatus = actualProject.status || 'pending';
    let statusText, statusClass;
    
    console.log('Status determination:', {
      projectStatus: projectStatus,
      approvedBySecretariat: actualProject.approvedBySecretariat,
      approvedBySecretariatType: typeof actualProject.approvedBySecretariat,
      isApproved: actualProject.approvedBySecretariat === true,
      isApprovedTruthy: !!actualProject.approvedBySecretariat
    });
    
    // Status now shown in Project Management Dashboard - updated by updateProjectManagementDashboard()

    // Update progress bars using calculated progress from ProgressCalculationService
    const overallProgress = localProgressData?.progress?.overall || parseFloat(project.progress?.overall || project.progress?.overallProgress || project.overallProgress || 0);
    // Use internal division progress (percentage within each division) instead of contribution to overall
    const timelineProgress = localProgressData?.progress?.internalTimeline || parseFloat(project.progress?.timeline || project.progress?.internalTimeline || project.progress?.timelineProgress || project.timelineProgress || 0);
    const budgetProgress = localProgressData?.progress?.internalBudget || parseFloat(project.progress?.budget || project.progress?.internalBudget || project.progress?.budgetProgress || project.budgetProgress || 0);
    const physicalProgress = localProgressData?.progress?.internalPhysical || parseFloat(project.progress?.physical || project.progress?.internalPhysical || project.progress?.physicalProgress || project.physicalProgress || 0);
    
    // Progress elements moved to Project Management Dashboard - updated by updateProjectManagementDashboard()

    // Show review section (no longer need to check for pending approval)
    const reviewSection = document.getElementById('eiuUpdatesReview');
    
    if (reviewSection) {
      reviewSection.style.display = 'block';
      console.log('Review section shown');
    } else {
      console.log('Review section element not found');
    }
    
    // Update automatic progress summary
    updateAutomaticProgress(project);

    // Display milestones if available
    console.log('Checking for milestones in project:', project);
    console.log('Project milestones:', project.milestones);
    console.log('Milestones type:', typeof project.milestones);
    
    // Handle different milestone data structures
    let milestonesArray = null;
    if (project.milestones) {
      if (Array.isArray(project.milestones)) {
        // Direct array structure
        milestonesArray = project.milestones;
        console.log('Milestones is direct array, length:', milestonesArray.length);
      } else if (project.milestones.milestones && Array.isArray(project.milestones.milestones)) {
        // Object with milestones array inside
        milestonesArray = project.milestones.milestones;
        console.log('Milestones is object with array inside, length:', milestonesArray.length);
      } else {
        console.log('Milestones structure not recognized:', project.milestones);
      }
    }
    
    if (milestonesArray && milestonesArray.length > 0) {
      console.log('Displaying milestones:', milestonesArray);
      displayMilestones(milestonesArray, localProgressData);
    } else {
      console.log('No milestones found or milestones array is empty');
      // Try to fetch milestones separately if not included
      if (selectedProject && selectedProject.id) {
        console.log('Attempting to fetch milestones separately...');
        fetchMilestonesSeparately(selectedProject.id, localProgressData);
      }
    }
    
    // Load horizontal timeline for the selected project
    if (selectedProject && selectedProject.id) {
      console.log('Loading horizontal timeline for project:', selectedProject.id);
      setTimeout(() => {
        loadProjectTimeline();
      }, 500); // Small delay to ensure DOM is ready
    }
  }

  // Fetch milestones separately if not included in project data
  async function fetchMilestonesSeparately(projectId, progressData = null) {
    try {
      console.log('Fetching milestones separately for project:', projectId);
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const timestamp = new Date().getTime();
      const response = await fetch(`http://localhost:3000/api/projects/${projectId}/milestones?_t=${timestamp}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log('Separate milestones API response:', data);
        if (data.success && data.milestones && data.milestones.length > 0) {
          console.log('Milestones fetched separately:', data.milestones);
          displayMilestones(data.milestones, progressData);
          
          // Load horizontal timeline after milestones are fetched
          setTimeout(() => {
            loadProjectTimeline();
          }, 500);
        } else {
          console.log('No milestones found in separate API call');
          displayNoMilestonesMessage();
          
          // Still try to load timeline even if no milestones
          setTimeout(() => {
            loadProjectTimeline();
          }, 500);
        }
      } else {
        console.error('Failed to fetch milestones separately:', response.status);
        displayNoMilestonesMessage();
        
        // Still try to load timeline even if API fails
        setTimeout(() => {
          loadProjectTimeline();
        }, 500);
      }
    } catch (error) {
      console.error('Error fetching milestones separately:', error);
      displayNoMilestonesMessage();
    }
  }

  // Display no milestones message
  function displayNoMilestonesMessage() {
    const milestonesContainer = document.getElementById('milestonesContainer');
    if (milestonesContainer) {
      milestonesContainer.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <p class="text-gray-500 text-lg font-medium">No milestones configured</p>
          <p class="text-gray-400 text-sm mt-2">This project does not have any milestones configured yet.</p>
        </div>
      `;
    }
  }

  // Helper function to calculate milestone progress
  function calculateMilestoneProgress(milestone, progressData) {
    if (!progressData || !progressData.milestones) {
      return milestone.progress || 0;
    }
    
    // Check if progressData.milestones is an array before using find
    if (!Array.isArray(progressData.milestones)) {
      console.log('progressData.milestones is not an array:', progressData.milestones);
      return milestone.progress || 0;
    }
    
    // Find the milestone in the progress data
    const milestoneProgress = progressData.milestones.find(m => m.id === milestone.id);
    if (milestoneProgress) {
      return milestoneProgress.progress || 0;
    }
    
    // Calculate based on division statuses
    let approvedDivisions = 0;
    let totalDivisions = 0;
    
    if (milestone.timelineStatus) {
      totalDivisions++;
      if (milestone.timelineStatus === 'approved') approvedDivisions++;
    }
    if (milestone.budgetStatus) {
      totalDivisions++;
      if (milestone.budgetStatus === 'approved') approvedDivisions++;
    }
    if (milestone.physicalStatus) {
      totalDivisions++;
      if (milestone.physicalStatus === 'approved') approvedDivisions++;
    }
    
    if (totalDivisions === 0) return 0;
    return Math.round((approvedDivisions / totalDivisions) * 100);
  }

  // Helper function to get status class
  function getStatusClass(status) {
    if (!status) return 'bg-gray-100 text-gray-700';
    
    switch (status.toLowerCase()) {
      case 'completed':
      case 'approved':
        return 'bg-green-100 text-green-700'; // Completed/Validated by Secretariat
      case 'ongoing':
      case 'submitted':
        return 'bg-blue-100 text-blue-700'; // Updated by EIU, pending validation by Secretariat
      case 'pending':
        return 'bg-yellow-100 text-yellow-700'; // Not yet updated/submitted by EIU
      case 'delayed':
        return 'bg-red-100 text-red-700 animate-pulse'; // Overdue by due date
      case 'need_revision':
      case 'revision_requested':
      case 'rejected':
        return 'bg-red-100 text-red-700'; // Requested by Secretariat, waiting for update
      default:
        return 'bg-gray-100 text-gray-700';
    }
  }

  // Function to update project status badge with delayed detection (similar to submit-update.astro)
  function updateProjectStatusWithMilestones() {
    if (!selectedProject) return;
    
    console.log('ðŸ” Updating project status with milestone data:', {
      projectName: selectedProject.name,
      baseStatus: selectedProject.status,
      milestonesCount: selectedProject.milestones?.length || 0
    });
    
    // Start with the project's base status
    let actualStatus = selectedProject.status || 'pending';
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Check for delayed milestones (same logic as submit-update.astro - only exclude completed projects)
    if (actualStatus !== 'completed' && actualStatus !== 'complete' && selectedProject.milestones && Array.isArray(selectedProject.milestones)) {
      console.log('ðŸ” Checking milestones for delays...');
      
      let delayedCount = 0;
      const hasDelayedMilestones = selectedProject.milestones.some(milestone => {
        const dueDate = milestone.dueDate || milestone.deadline || milestone.targetDate || milestone.completionDate;
        const status = milestone.status || 'pending';
        
        console.log('ðŸ” Processing milestone:', {
          title: milestone.title,
          dueDate: dueDate,
          status: status,
          hasDate: !!dueDate,
          statusCheck: status !== 'completed' && status !== 'under_approval' && status !== 'revision_request'
        });
        
                  if (dueDate && status !== 'completed' && status !== 'under_approval' && status !== 'revision_request') {
            const milestoneDate = new Date(dueDate);
            milestoneDate.setHours(0, 0, 0, 0);
            const isOverdue = milestoneDate < today;
            const isPending = status === 'pending';
            const isAlreadyDelayed = status === 'delayed';
            const isDelayed = (isOverdue && isPending) || isAlreadyDelayed;
          
                      console.log('ðŸ” Milestone delay analysis:', {
              title: milestone.title,
              dueDate: dueDate,
              status: status,
              milestoneDate: milestoneDate.toDateString(),
              today: today.toDateString(),
              isOverdue: isOverdue,
              isPending: isPending,
              isAlreadyDelayed: isAlreadyDelayed,
              isDelayed: isDelayed
            });
          
          if (isDelayed) {
            delayedCount++;
            console.log('ðŸš¨ Found delayed milestone:', milestone.title);
          }
          
          return isDelayed;
        }
        return false;
      });
      
      console.log('ðŸ” Delay detection result:', {
        totalMilestones: Array.isArray(selectedProject.milestones) ? selectedProject.milestones.length : 0,
        delayedCount: delayedCount,
        hasDelayedMilestones: hasDelayedMilestones
      });
      
      if (hasDelayedMilestones) {
        actualStatus = 'delayed';
        console.log('âœ… Status changed to DELAYED due to overdue milestones');
      } else {
        console.log('â„¹ï¸ No delayed milestones found, keeping original status');
      }
    }
    
    // Determine display text and class
    let statusText, statusClass;
    if (actualStatus.toLowerCase() === 'completed') {
      statusText = 'COMPLETE';
      statusClass = 'bg-green-100 text-green-700';
    } else if (actualStatus === 'delayed') {
      statusText = 'DELAYED';
      statusClass = 'bg-red-100 text-red-700 animate-pulse';
    } else if (selectedProject.approvedBySecretariat === true || selectedProject.approvedBySecretariat === 'true') {
      statusText = 'ONGOING';
      statusClass = 'bg-blue-100 text-blue-700';
    } else {
      statusText = 'PENDING';
      statusClass = 'bg-yellow-100 text-yellow-700';
    }
    
    console.log('ðŸ” Final status for badge:', {
      actualStatus: actualStatus,
      statusText: statusText,
      statusClass: statusClass
    });
    
    // Status badge moved to Project Management Dashboard - updated by updateProjectManagementDashboard()
    console.log('âœ… Status will be updated in Project Management Dashboard:', statusText);
  }

  // Display milestones with progress data
  function displayMilestones(milestones, progressData = null) {
    const milestonesContainer = document.getElementById('milestonesContainer');
    if (!milestonesContainer) return;

    console.log('Displaying milestones with full details:', milestones);
    console.log('Progress data:', progressData);
    console.log('Progress data type:', typeof progressData);
    console.log('Progress data keys:', progressData ? Object.keys(progressData) : 'null');
    if (progressData && progressData.milestones) {
      console.log('Progress data milestones type:', typeof progressData.milestones);
      console.log('Progress data milestones is array:', Array.isArray(progressData.milestones));
      console.log('Progress data milestones:', progressData.milestones);
    }

    // Process milestones to check for delayed status
    const processedMilestones = milestones.map(milestone => {
      let status = milestone.status || 'pending';
      
      // Check if milestone is overdue and should be marked as delayed
      const dueDate = milestone.dueDate || milestone.deadline || milestone.targetDate || milestone.completionDate;
      if (dueDate && status !== 'completed' && status !== 'under_approval' && status !== 'revision_request') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const milestoneDate = new Date(dueDate);
        milestoneDate.setHours(0, 0, 0, 0);
        
        if (milestoneDate < today && status === 'pending') {
          status = 'delayed';
          console.log(`ðŸš¨ Milestone "${milestone.title}" is overdue (due: ${dueDate}, today: ${today.toDateString()}), marking as delayed`);
        }
      }
      
      return { ...milestone, status };
    });

    milestonesContainer.innerHTML = processedMilestones.map(milestone => `
      <div class="border border-gray-200 rounded-lg p-6 mb-4">
        <!-- Milestone Header -->
        <div class="flex items-center justify-between mb-4">
          <div>
            <h4 class="text-lg font-semibold text-gray-800">${milestone.title}</h4>
            <p class="text-sm text-gray-600">Milestone ID: ${milestone.id}</p>
          </div>
          <span class="px-3 py-1 text-sm font-medium rounded-full ${getStatusClass(milestone.status)}">${milestone.status || 'pending'}</span>
        </div>

        <!-- Basic Milestone Info -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mb-4">
          <div class="bg-gray-50 p-3 rounded-lg">
            <span class="text-gray-600 block text-xs">Total Weight</span>
            <span class="font-semibold text-lg">${milestone.weight}%</span>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <span class="text-gray-600 block text-xs">Planned Budget</span>
            <span class="font-semibold text-lg">â‚±${(milestone.plannedBudget || 0).toLocaleString()}</span>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <span class="text-gray-600 block text-xs">Progress</span>
            <span class="font-semibold text-lg">${calculateMilestoneProgress(milestone, progressData)}%</span>
          </div>
        </div>

        <!-- Milestone Dates Info -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
            <span class="text-blue-600 block text-xs font-medium">Start Date</span>
            <span class="font-semibold text-blue-800">${milestone.timelineStartDate || milestone.startDate || 'â€“'}</span>
          </div>
          <div class="bg-green-50 p-3 rounded-lg border border-green-200">
            <span class="text-green-600 block text-xs font-medium">Target Completion Date</span>
            <span class="font-semibold text-green-800">${milestone.timelineEndDate || milestone.dueDate || milestone.targetDate || 'â€“'}</span>
          </div>
          <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
            <span class="text-purple-600 block text-xs font-medium">Actual Completion Date</span>
            <span class="font-semibold text-purple-800">${milestone.completionDate || milestone.actualCompletionDate || 'â€“'}</span>
          </div>
          <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
            <span class="text-orange-600 block text-xs font-medium">Expected Days</span>
            <span class="font-semibold text-orange-800">${milestone.expectedDaysOfCompletion ? milestone.expectedDaysOfCompletion + ' days' : 'â€“'}</span>
          </div>
        </div>

        <!-- Three Divisions Section -->
        <div class="mb-4">
          <h5 class="font-semibold text-gray-800 mb-3">Three-Division Configuration</h5>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <!-- Timeline Division -->
            <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h6 class="font-semibold text-blue-800">Timeline Division</h6>
              </div>
              <div class="space-y-2 text-sm">
                <div><span class="text-gray-600">Weight:</span> <span class="font-medium">${milestone.timelineWeight || 33.33}%</span></div>
                <div><span class="text-gray-600">Start:</span> <span class="font-medium">${milestone.timelineStartDate || '-'}</span></div>
                <div><span class="text-gray-600">Target:</span> <span class="font-medium">${milestone.timelineEndDate || milestone.targetCompletionDate || '-'}</span></div>
                <div><span class="text-gray-600">Actual:</span> <span class="font-medium">${milestone.completionDate || milestone.actualCompletionDate || 'â€“'}</span></div>
                <div><span class="text-gray-600">Days:</span> <span class="font-medium">${milestone.expectedDaysOfCompletion ? milestone.expectedDaysOfCompletion + ' days' : 'â€“'}</span></div>
                <div><span class="text-gray-600">Status:</span> 
                  <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(milestone.timelineStatus)}">${milestone.timelineStatus || 'pending'}</span>
                </div>
                ${milestone.timelineDescription ? `
                  <div class="mt-2 p-2 bg-white rounded border">
                    <span class="text-gray-600 text-xs">Description:</span>
                    <p class="text-xs mt-1">${milestone.timelineDescription}</p>
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- Budget Division -->
            <div class="border border-green-200 rounded-lg p-4 bg-green-50">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
                <h6 class="font-semibold text-green-800">Budget Division</h6>
              </div>
              <div class="space-y-2 text-sm">
                <div><span class="text-gray-600">Weight:</span> <span class="font-medium">${milestone.budgetWeight || 33.33}%</span></div>
                <div><span class="text-gray-600">Planned:</span> <span class="font-medium">â‚±${(milestone.budgetPlanned || 0).toLocaleString()}</span></div>
                <div><span class="text-gray-600">Status:</span> 
                  <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(milestone.budgetStatus)}">${milestone.budgetStatus || 'pending'}</span>
                </div>
                ${milestone.budgetBreakdown ? `
                  <div class="mt-2 p-2 bg-white rounded border">
                    <span class="text-gray-600 text-xs">Breakdown:</span>
                    <p class="text-xs mt-1">${milestone.budgetBreakdown}</p>
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- Physical Division -->
            <div class="border border-orange-200 rounded-lg p-4 bg-orange-50">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h6 class="font-semibold text-orange-800">Physical Division</h6>
              </div>
              <div class="space-y-2 text-sm">
                <div><span class="text-gray-600">Weight:</span> <span class="font-medium">${milestone.physicalWeight || 33.33}%</span></div>
                <div><span class="text-gray-600">Proof Type:</span> <span class="font-medium">${milestone.physicalProofType || 'form'}</span></div>
                <div><span class="text-gray-600">Status:</span> 
                  <span class="px-2 py-1 text-xs rounded-full ${
                    milestone.physicalStatus === 'completed' ? 'bg-green-100 text-green-700' :
                    milestone.physicalStatus === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                    milestone.physicalStatus === 'approved' ? 'bg-purple-100 text-purple-700' :
                    'bg-gray-100 text-gray-700'
                  }">${milestone.physicalStatus || 'pending'}</span>
                </div>
                ${milestone.physicalDescription ? `
                  <div class="mt-2 p-2 bg-white rounded border">
                    <span class="text-gray-600 text-xs">Description:</span>
                    <p class="text-xs mt-1">${milestone.physicalDescription}</p>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>

        <!-- Description and Progress -->
        ${milestone.description ? `
          <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <span class="text-gray-600 font-medium">Description:</span>
            <p class="text-sm mt-1">${milestone.description}</p>
          </div>
        ` : ''}
        
        <!-- Progress Bar -->
        <div class="flex items-center justify-between">
          <div class="flex-1 mr-4">
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div class="bg-[#92751F] h-3 rounded-full transition-all duration-300" style="width: ${calculateMilestoneProgress(milestone, progressData)}%"></div>
            </div>
          </div>
          <span class="text-sm font-semibold">${calculateMilestoneProgress(milestone, progressData)}% Complete</span>
        </div>

        <!-- Additional Info -->
        <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-gray-600">
          <div><span class="font-medium">Order:</span> ${milestone.order || 0}</div>
          <div><span class="font-medium">Priority:</span> ${milestone.priority || 'medium'}</div>
          <div><span class="font-medium">Completed:</span> ${milestone.completedDate || 'Not completed'}</div>
          <div><span class="font-medium">Validated:</span> ${milestone.validationDate || 'Not validated'}</div>
        </div>
      </div>
    `).join('');
  }

  // Display updates with enhanced EIU milestone structure
  function displayUpdates(updates) {
    console.log('Displaying updates:', updates);
    const updatesContainer = document.getElementById('updatesContainer');
    if (!updatesContainer) {
      console.error('Updates container not found!');
      return;
    }

    if (!updates || updates.length === 0) {
      updatesContainer.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="text-gray-500 text-lg font-medium">No milestone updates available</p>
          <p class="text-gray-400 text-sm mt-2">Milestone updates from EIU personnel will appear here once submitted.</p>
        </div>
      `;
      updateCompilationStatus();
      return;
    }

    updatesContainer.innerHTML = updates.map(update => {
      const isMilestoneUpdate = update.updateType === 'milestone' || update.milestoneId;
      const updateDate = new Date(update.createdAt || update.submittedAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <div class="border border-gray-200 rounded-lg p-6 mb-6 hover:shadow-md transition-shadow">
          <!-- Update Header -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-full bg-blue-100">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-gray-800">${isMilestoneUpdate ? 'Milestone Update' : (update.title || 'Project Update')}</h4>
                <p class="text-sm text-gray-600">Submitted by ${update.submitter?.name || update.submittedBy || 'EIU Personnel'}</p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-700">${update.status || 'submitted'}</span>
              

            </div>
          </div>

          <!-- Update Metadata -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
            <div class="bg-gray-50 p-3 rounded-lg">
              <span class="text-gray-600 block text-xs">Submission Date</span>
              <span class="font-medium">${updateDate}</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <span class="text-gray-600 block text-xs">Update Type</span>
              <span class="font-medium">${isMilestoneUpdate ? 'Milestone' : (update.updateType || 'General')}</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <span class="text-gray-600 block text-xs">Progress</span>
              <span class="font-medium">${update.currentProgress || update.progress || 0}%</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <span class="text-gray-600 block text-xs">Status</span>
              <span class="font-medium">${update.status || 'submitted'}</span>
            </div>
          </div>

          ${isMilestoneUpdate ? generateMilestoneUpdateContent(update) : generateGeneralUpdateContent(update)}
        </div>
      `;
    }).join('');
    
    // Update compilation status after displaying updates
    updateCompilationStatus();
  }

  // Generate milestone update content with three divisions
  function generateMilestoneUpdateContent(update) {
    console.log('generateMilestoneUpdateContent called with update:', update);
    
    // Extract the actual milestone data from the update
    let milestoneData = null;
    
    if (update.milestoneUpdates) {
      // If this is a project update with milestoneUpdates field
      try {
        const parsed = typeof update.milestoneUpdates === 'string' 
          ? JSON.parse(update.milestoneUpdates) 
          : update.milestoneUpdates;
        
        if (Array.isArray(parsed) && parsed.length > 0) {
          milestoneData = parsed[0]; // Get the first milestone update
        } else if (typeof parsed === 'object') {
          milestoneData = parsed;
        }
      } catch (error) {
        console.error('Error parsing milestone updates:', error);
      }
    } else {
      // If this is already a milestone update object
      milestoneData = update;
    }
    
    console.log('Milestone data for display:', milestoneData);
    
    // If no milestone data found, show empty state
    if (!milestoneData) {
      return `
        <div class="mb-4">
          <h5 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            Three-Division Milestone Update
          </h5>
          <p class="text-gray-500 text-sm">No milestone data available</p>
        </div>
      `;
    }
    
    return `
      <!-- Three Divisions Review -->
      <div class="mb-4">
        <h5 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          Three-Division Milestone Update
          ${milestoneData.milestoneTitle ? `<span class="text-sm font-normal text-gray-600">- ${milestoneData.milestoneTitle}</span>` : ''}
        </h5>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Timeline Division -->
          <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
            <div class="flex items-center mb-3">
              <svg class="w-4 h-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <h6 class="font-semibold text-blue-800">Timeline Division</h6>
            </div>
            <div class="space-y-2 text-sm">
              ${milestoneData.plannedStartDate ? `
                <div class="bg-white p-2 rounded border">
                  <span class="text-gray-600 text-xs">Planned Start Date:</span>
                  <p class="font-medium text-sm text-blue-700">${new Date(milestoneData.plannedStartDate).toLocaleDateString()}</p>
                </div>
              ` : ''}
              ${milestoneData.plannedEndDate ? `
                <div class="bg-white p-2 rounded border">
                  <span class="text-gray-600 text-xs">Planned Due Date:</span>
                  <p class="font-medium text-sm text-blue-700">${new Date(milestoneData.plannedEndDate).toLocaleDateString()}</p>
                </div>
              ` : ''}
              ${milestoneData.timeline?.description ? `
                <div class="bg-white p-3 rounded border">
                  <span class="text-gray-600 text-xs">Activities & Deliverables:</span>
                  <p class="text-sm mt-1">${milestoneData.timeline.description}</p>
                </div>
              ` : '<p class="text-gray-500 text-sm">No timeline updates provided</p>'}
            </div>
          </div>

          <!-- Budget Division -->
          <div class="border border-green-200 rounded-lg p-4 bg-green-50">
            <div class="flex items-center mb-3">
              <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
              </svg>
              <h6 class="font-semibold text-green-800">Budget Division</h6>
            </div>
            <div class="space-y-2 text-sm">
              ${milestoneData.plannedBudget ? `
                <div class="bg-white p-2 rounded border">
                  <span class="text-gray-600 text-xs">Planned Budget:</span>
                  <p class="font-medium text-green-700">â‚±${parseFloat(milestoneData.plannedBudget).toLocaleString()}</p>
                </div>
              ` : ''}
              <div class="bg-white p-2 rounded border">
                <span class="text-gray-600 text-xs">Used Budget:</span>
                <p class="font-medium text-gray-500">
                  â‚±${parseFloat(milestoneData.budget?.amount || 0).toLocaleString()}
                </p>
              </div>
              ${milestoneData.budget?.breakdown ? `
                <div class="bg-white p-3 rounded border">
                  <span class="text-gray-600 text-xs">Budget Breakdown:</span>
                  <p class="text-sm mt-1">${milestoneData.budget.breakdown}</p>
                </div>
              ` : ''}
              ${!milestoneData.budget?.breakdown && !milestoneData.plannedBudget ? 
                '<p class="text-gray-500 text-sm">No budget breakdown provided</p>' : ''}
            </div>
          </div>

          <!-- Physical Division -->
          <div class="border border-orange-200 rounded-lg p-4 bg-orange-50">
            <div class="flex items-center mb-3">
              <svg class="w-4 h-4 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              <h6 class="font-semibold text-orange-800">Physical Division</h6>
            </div>
            <div class="space-y-2 text-sm">
              ${milestoneData.physical?.description ? `
                <div class="bg-white p-3 rounded border">
                  <span class="text-gray-600 text-xs">Progress Requirements:</span>
                  <p class="text-sm mt-1">${milestoneData.physical.description}</p>
                </div>
              ` : '<p class="text-gray-500 text-sm">No physical updates provided</p>'}
              
              ${milestoneData.uploadedFiles && milestoneData.uploadedFiles.length > 0 ? `
                <div class="bg-white p-3 rounded border">
                  <span class="text-gray-600 text-xs">Supporting Documents (${milestoneData.uploadedFiles.length} files):</span>
                  <div class="mt-2 space-y-1">
                    ${milestoneData.uploadedFiles.map((file, index) => `
                      <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
                        <div class="flex items-center gap-2">
                          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                          </svg>
                          <span class="text-sm text-gray-700 truncate max-w-xs">
                            ${file.originalName || file.name || `Document ${index + 1}`}
                          </span>
                        </div>
                        <button onclick="downloadFile('${file.filename || file.name}', '${file.originalName || file.name}')" 
                                class="px-2 py-1 text-xs bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors">
                          Download
                        </button>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Notes -->
      ${milestoneData.notes ? `
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <span class="text-gray-600 font-medium">Additional Notes:</span>
          <p class="text-sm mt-2">${milestoneData.notes}</p>
        </div>
      ` : ''}

      <!-- Review Actions -->
      ${update.status === 'submitted' ? `
        <div class="border-t border-gray-200 pt-4">
          <!-- Note to Secretariat Section -->
          <div class="mb-4">
            <button onclick="toggleSecretariatNote('${update.id}')" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 mb-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              Note to Secretariat
            </button>
            <div id="secretariat-note-${update.id}" class="hidden">
              <textarea id="secretariat-note-text-${update.id}" rows="3" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Add a note for the Secretariat admin..."></textarea>
            </div>
          </div>
          
          <div class="flex justify-end gap-3">
            <button onclick="approveUpdate('${update.id}')" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Approve Update
            </button>
            <button onclick="rejectUpdate('${update.id}')" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Reject Update
            </button>
          </div>
        </div>
      ` : ''}
    `;
  }

  // Generate general update content
  function generateGeneralUpdateContent(update) {
    return `
      <div class="mb-4">
        <span class="text-gray-600">Description:</span>
        <p class="text-sm mt-1">${update.description || 'No description provided'}</p>
      </div>
      ${update.remarks ? `
        <div class="bg-gray-50 p-3 rounded-lg">
          <span class="text-gray-600">Additional Notes:</span>
          <p class="text-sm mt-1">${update.remarks}</p>
        </div>
      ` : ''}
    `;
  }

  // Download file function
  function downloadFile(filename, originalName) {
    try {
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const downloadUrl = `http://localhost:3000/api/uploads/download/${filename}`;
      
      // Create a temporary link element
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = originalName || filename;
      
      // Add authorization header
      if (token) {
        link.setAttribute('data-token', token);
      }
      
      // Trigger download
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log('Download initiated for:', originalName || filename);
    } catch (error) {
      console.error('Error downloading file:', error);
      alert('Error downloading file. Please try again.');
    }
  }



  // Update automatic progress summary
  function updateAutomaticProgress(project) {
    // Handle nested project structure from API response
    const actualProject = project.project || project;
    
    // Use calculated progress from ProgressCalculationService
    const overallProgress = parseFloat(project.progress?.overall || project.progress?.overallProgress || actualProject.automatedProgress || 0);
    const timelineProgress = parseFloat(project.progress?.timeline || project.progress?.timelineProgress || actualProject.timelineProgress || 0);
    const budgetProgress = parseFloat(project.progress?.budget || project.progress?.budgetProgress || actualProject.budgetProgress || 0);
    const physicalProgress = parseFloat(project.progress?.physical || project.progress?.physicalProgress || actualProject.physicalProgress || 0);
    
    // Update display
    const autoOverallElement = document.getElementById('autoOverallProgress');
    const autoTimelineElement = document.getElementById('autoTimelineProgress');
    const autoBudgetElement = document.getElementById('autoBudgetProgress');
    const autoPhysicalElement = document.getElementById('autoPhysicalProgress');
    
    if (autoOverallElement) autoOverallElement.textContent = `${overallProgress.toFixed(2)}%`;
    if (autoTimelineElement) autoTimelineElement.textContent = `${timelineProgress.toFixed(2)}%`;
    if (autoBudgetElement) autoBudgetElement.textContent = `${budgetProgress.toFixed(2)}%`;
    if (autoPhysicalElement) autoPhysicalElement.textContent = `${physicalProgress.toFixed(2)}%`;
  }

  // Approve update
  async function approveUpdate(updateId) {
    if (!confirm('Are you sure you want to approve this milestone update?')) {
      return;
    }

    try {
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      
      // Get Secretariat note if provided
      const secretariatNote = document.getElementById(`secretariat-note-text-${updateId}`)?.value || '';
      
      const response = await fetch(`http://localhost:3000/api/projects/project-updates/${updateId}/approve`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'iu_approved',
          iuReviewRemarks: 'Approved by Implementing Office',
          secretariatNote: secretariatNote
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          alert('Milestone update approved successfully!');
          // Refresh updates and project data
          if (selectedProject) {
            loadProjectUpdates(selectedProject.id);
            selectProject(selectedProject.id);
          }
        } else {
          alert('Error approving update: ' + data.error);
        }
      } else {
        alert('Error approving update. Please try again.');
      }
    } catch (error) {
      console.error('Error approving update:', error);
      alert('Error approving update. Please try again.');
    }
  }

  // Reject update
  async function rejectUpdate(updateId) {
    const remarks = prompt('Please provide rejection remarks:');
    if (!remarks) {
      alert('Rejection remarks are required.');
      return;
    }

    try {
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const response = await fetch(`http://localhost:3000/api/projects/project-updates/${updateId}/reject`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'iu_rejected',
          iuReviewRemarks: remarks
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          alert('Milestone update rejected successfully!');
          // Refresh updates and project data
          if (selectedProject) {
            loadProjectUpdates(selectedProject.id);
            selectProject(selectedProject.id);
          }
        } else {
          alert('Error rejecting update: ' + data.error);
        }
      } else {
        alert('Error rejecting update. Please try again.');
      }
    } catch (error) {
      console.error('Error rejecting update:', error);
      alert('Error rejecting update. Please try again.');
    }
  }

  // Compile and submit to Secretariat with professional report generation
  async function compileAndSubmitToSecretariat() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }

    // Validate that all three divisions are complete
    const approvedUpdates = projectUpdates.filter(update => update.status === 'iu_approved');
    const milestoneUpdates = approvedUpdates.filter(update => 
      update.updateType === 'milestone' || update.milestoneId
    );

    if (milestoneUpdates.length === 0) {
      alert('No approved milestone updates found. Please approve milestone updates first.');
      return;
    }

    // Generate professional compilation report
    const compilationReport = generateProfessionalReport(milestoneUpdates);
    
    if (!compilationReport.isValid) {
      alert(compilationReport.errorMessage);
      return;
    }

    if (!confirm('Are you sure you want to compile and submit this professional progress report to the Secretariat?')) {
      return;
    }

    try {
      const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      const response = await fetch(`http://localhost:3000/api/projects/${selectedProject.id}/compile-and-submit`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          compiledReport: compilationReport.report,
          reportSummary: compilationReport.summary,
          submittedAt: new Date().toISOString(),
          compilationDetails: {
            totalUpdates: milestoneUpdates.length,
            timelineComplete: compilationReport.timelineComplete,
            budgetComplete: compilationReport.budgetComplete,
            physicalComplete: compilationReport.physicalComplete,
            overallProgress: compilationReport.overallProgress
          }
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          alert('Professional progress report compiled and submitted to Secretariat successfully!');
          // Refresh project data
          selectProject(selectedProject.id);
        } else {
          alert('Error submitting to Secretariat: ' + data.error);
        }
      } else {
        alert('Error submitting to Secretariat. Please try again.');
      }
    } catch (error) {
      console.error('Error submitting to Secretariat:', error);
      alert('Error submitting to Secretariat. Please try again.');
    }
  }

  // Generate professional compilation report
  function generateProfessionalReport(milestoneUpdates) {
    const report = {
      isValid: false,
      errorMessage: '',
      report: '',
      summary: {},
      timelineComplete: false,
      budgetComplete: false,
      physicalComplete: false,
      overallProgress: 0
    };

    try {
      // Analyze milestone updates
      let timelineData = [];
      let budgetData = [];
      let physicalData = [];
      let totalProgress = 0;
      let updateCount = 0;

      milestoneUpdates.forEach(update => {
        const milestoneData = update.milestoneUpdates || update;
        
        // Collect Timeline Division data
        if (milestoneData.timeline?.description) {
          timelineData.push({
            description: milestoneData.timeline.description,
            submittedBy: update.submitter?.name || update.submittedBy || 'EIU Personnel',
            submittedAt: update.createdAt || update.submittedAt
          });
        }

        // Collect Budget Division data
        if (milestoneData.budget?.amount || milestoneData.budget?.breakdown) {
          budgetData.push({
            amount: milestoneData.budget.amount || 0,
            breakdown: milestoneData.budget.breakdown || '',
            submittedBy: update.submitter?.name || update.submittedBy || 'EIU Personnel',
            submittedAt: update.createdAt || update.submittedAt
          });
        }

        // Collect Physical Division data
        if (milestoneData.physical?.description || milestoneData.uploadedFiles) {
          physicalData.push({
            description: milestoneData.physical?.description || '',
            attachments: milestoneData.uploadedFiles || [],
            submittedBy: update.submitter?.name || update.submittedBy || 'EIU Personnel',
            submittedAt: update.createdAt || update.submittedAt
          });
        }

        totalProgress += parseFloat(update.currentProgress || update.progress || 0);
        updateCount++;
      });

      // Validate completeness
      report.timelineComplete = timelineData.length > 0;
      report.budgetComplete = budgetData.length > 0;
      report.physicalComplete = physicalData.length > 0;
      report.overallProgress = updateCount > 0 ? totalProgress / updateCount : 0;

      if (!report.timelineComplete || !report.budgetComplete || !report.physicalComplete) {
        report.errorMessage = 'All three divisions (Timeline, Budget, Physical) must be complete before compilation.';
        return report;
      }

      // Generate professional report
      const currentDate = new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      report.report = `
PROGRESS COMPILATION REPORT
Project: ${selectedProject.name}
Project Code: ${selectedProject.projectCode}
Compilation Date: ${currentDate}
Implementing Office: ${selectedProject.implementingOffice || 'Municipal Engineer Office'}

EXECUTIVE SUMMARY
Overall Progress: ${report.overallProgress.toFixed(2)}%
Total Approved Updates: ${milestoneUpdates.length}
Compilation Status: COMPLETE

TIMELINE DIVISION COMPILATION
Status: âœ… COMPLETE
Updates Received: ${timelineData.length}
${timelineData.map((item, index) => `
Update ${index + 1}:
- Activities & Deliverables: ${item.description}
- Submitted by: ${item.submittedBy}
- Date: ${new Date(item.submittedAt).toLocaleDateString()}
`).join('')}

BUDGET DIVISION COMPILATION
Status: âœ… COMPLETE
Updates Received: ${budgetData.length}
Total Budget Utilized: â‚±${budgetData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0).toLocaleString()}
${budgetData.map((item, index) => `
Update ${index + 1}:
- Used Budget: â‚±${parseFloat(item.amount || 0).toLocaleString()}
- Breakdown: ${item.breakdown || 'No breakdown provided'}
- Submitted by: ${item.submittedBy}
- Date: ${new Date(item.submittedAt).toLocaleDateString()}
`).join('')}

PHYSICAL DIVISION COMPILATION
Status: âœ… COMPLETE
Updates Received: ${physicalData.length}
Total Attachments: ${physicalData.reduce((sum, item) => sum + (item.attachments?.length || 0), 0)}
${physicalData.map((item, index) => `
Update ${index + 1}:
- Progress Requirements: ${item.description || 'No description provided'}
- Supporting Documents: ${item.attachments?.length || 0} files
- Submitted by: ${item.submittedBy}
- Date: ${new Date(item.submittedAt).toLocaleDateString()}
`).join('')}

COMPILATION VERIFICATION
âœ… Timeline Division: Complete with ${timelineData.length} updates
âœ… Budget Division: Complete with ${budgetData.length} updates  
âœ… Physical Division: Complete with ${physicalData.length} updates
âœ… All divisions validated and approved by Implementing Office
âœ… Ready for Secretariat review and final approval

This compilation report has been generated automatically based on approved EIU milestone updates and validated by the Implementing Office for submission to the Secretariat.
      `.trim();

      report.summary = {
        projectName: selectedProject.name,
        projectCode: selectedProject.projectCode,
        compilationDate: currentDate,
        overallProgress: report.overallProgress.toFixed(2) + '%',
        totalUpdates: milestoneUpdates.length,
        timelineUpdates: timelineData.length,
        budgetUpdates: budgetData.length,
        physicalUpdates: physicalData.length,
        totalBudget: budgetData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0),
        totalAttachments: physicalData.reduce((sum, item) => sum + (item.attachments?.length || 0), 0)
      };

      report.isValid = true;
      return report;

    } catch (error) {
      console.error('Error generating professional report:', error);
      report.errorMessage = 'Error generating compilation report. Please try again.';
      return report;
    }
  }

  // Update compilation status with enhanced three-division validation and revision handling
  function updateCompilationStatus() {
    // First, check if project is under Secretariat review - if so, disable compilation
    if (selectedProject && (selectedProject.workflowStatus === 'compiled_for_secretariat' || selectedProject.workflowStatus === 'iu_approved')) {
      document.getElementById('timelineStatus').textContent = 'â³ Under Secretariat Review';
      document.getElementById('budgetStatus').textContent = 'â³ Under Secretariat Review';
      document.getElementById('physicalStatus').textContent = 'â³ Under Secretariat Review';
      disableCompileButton();
      return;
    }

    if (!projectUpdates || projectUpdates.length === 0) {
      document.getElementById('timelineStatus').textContent = 'â³ Pending EIU Updates';
      document.getElementById('budgetStatus').textContent = 'â³ Pending EIU Updates';
      document.getElementById('physicalStatus').textContent = 'â³ Pending EIU Updates';
      disableCompileButton();
      return;
    }

    // Find approved milestone updates
    const approvedUpdates = projectUpdates.filter(update => update.status === 'iu_approved');
    const milestoneUpdates = approvedUpdates.filter(update => 
      update.updateType === 'milestone' || update.milestoneId
    );

    console.log('Compilation status check:', {
      totalUpdates: projectUpdates.length,
      approvedUpdates: approvedUpdates.length,
      milestoneUpdates: milestoneUpdates.length,
      projectWorkflowStatus: selectedProject?.workflowStatus
    });

    // Check each division separately with revision status handling
    let timelineStatus = { hasData: false, status: 'â³ Pending EIU Updates', needsRevision: false };
    let budgetStatus = { hasData: false, status: 'â³ Pending EIU Updates', needsRevision: false };
    let physicalStatus = { hasData: false, status: 'â³ Pending EIU Updates', needsRevision: false };

    milestoneUpdates.forEach(update => {
      const milestoneData = update.milestoneUpdates || update;
      
      // Check Timeline Division
      if (milestoneData.timeline?.description && milestoneData.timeline.description.trim() !== '') {
        if (milestoneData.timelineStatus === 'revision_requested') {
          timelineStatus = { hasData: true, status: 'âš ï¸ Revision Requested by Secretariat', needsRevision: true };
        } else if (milestoneData.timelineStatus === 'rejected') {
          timelineStatus = { hasData: true, status: 'âŒ Rejected by Secretariat', needsRevision: false };
        } else if (milestoneData.timelineStatus === 'approved') {
          timelineStatus = { hasData: true, status: 'âœ… Updated & Approved', needsRevision: false };
        } else {
          timelineStatus = { hasData: true, status: 'âœ… Updated & Approved', needsRevision: false };
        }
      }
      
      // Check Budget Division
      if ((milestoneData.budget?.amount && parseFloat(milestoneData.budget.amount) > 0) ||
          (milestoneData.budget?.breakdown && milestoneData.budget.breakdown.trim() !== '')) {
        if (milestoneData.budgetStatus === 'revision_requested') {
          budgetStatus = { hasData: true, status: 'âš ï¸ Revision Requested by Secretariat', needsRevision: true };
        } else if (milestoneData.budgetStatus === 'rejected') {
          budgetStatus = { hasData: true, status: 'âŒ Rejected by Secretariat', needsRevision: false };
        } else if (milestoneData.budgetStatus === 'approved') {
          budgetStatus = { hasData: true, status: 'âœ… Updated & Approved', needsRevision: false };
        } else {
          budgetStatus = { hasData: true, status: 'âœ… Updated & Approved', needsRevision: false };
        }
      }
      
      // Check Physical Division
      if ((milestoneData.physical?.description && milestoneData.physical.description.trim() !== '') ||
          (milestoneData.uploadedFiles && milestoneData.uploadedFiles.length > 0)) {
        if (milestoneData.physicalStatus === 'revision_requested') {
          physicalStatus = { hasData: true, status: 'âš ï¸ Revision Requested by Secretariat', needsRevision: true };
        } else if (milestoneData.physicalStatus === 'rejected') {
          physicalStatus = { hasData: true, status: 'âŒ Rejected by Secretariat', needsRevision: false };
        } else if (milestoneData.physicalStatus === 'approved') {
          physicalStatus = { hasData: true, status: 'âœ… Updated & Approved', needsRevision: false };
        } else {
          physicalStatus = { hasData: true, status: 'âœ… Updated & Approved', needsRevision: false };
        }
      }
    });

    // Update status display
    document.getElementById('timelineStatus').textContent = timelineStatus.status;
    document.getElementById('budgetStatus').textContent = budgetStatus.status;
    document.getElementById('physicalStatus').textContent = physicalStatus.status;

    // Enable/disable compile button based on all three divisions being complete and no revisions needed
    const allDivisionsComplete = timelineStatus.hasData && budgetStatus.hasData && physicalStatus.hasData;
    const anyRevisionNeeded = timelineStatus.needsRevision || budgetStatus.needsRevision || physicalStatus.needsRevision;
    
    console.log('Division completion status:', {
      timeline: timelineStatus.hasData,
      budget: budgetStatus.hasData,
      physical: physicalStatus.hasData,
      allComplete: allDivisionsComplete,
      anyRevisionNeeded: anyRevisionNeeded,
      projectWorkflowStatus: selectedProject?.workflowStatus
    });

    if (allDivisionsComplete && !anyRevisionNeeded) {
      enableCompileButton();
    } else {
      disableCompileButton();
    }
  }

  // Enable compile button
  function enableCompileButton() {
    const compileButton = document.querySelector('button[onclick="compileAndSubmitToSecretariat()"]');
    if (compileButton) {
      compileButton.disabled = false;
      compileButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
      compileButton.classList.add('bg-green-600', 'hover:bg-green-700');
      compileButton.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Compile & Submit to Secretariat
      `;
    }
  }

  // Disable compile button
  function disableCompileButton() {
    const compileButton = document.querySelector('button[onclick="compileAndSubmitToSecretariat()"]');
    if (compileButton) {
      compileButton.disabled = true;
      compileButton.classList.add('bg-gray-400', 'cursor-not-allowed');
      compileButton.classList.remove('bg-green-600', 'hover:bg-green-700');
      
      // Show appropriate message based on project status
      let buttonText = 'Complete All Divisions First';
      let icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>`;
      
      if (selectedProject) {
        if (selectedProject.workflowStatus === 'compiled_for_secretariat' || selectedProject.workflowStatus === 'iu_approved') {
          buttonText = 'Under Secretariat Review';
          icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>`;
        } else if (!projectUpdates || projectUpdates.length === 0) {
          buttonText = 'Waiting for EIU Updates';
          icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>`;
        }
      }
      
      compileButton.innerHTML = `
        ${icon}
        ${buttonText}
      `;
    }
  }

  // Refresh updates function
  function refreshUpdates() {
    if (selectedProject) {
      console.log('Refreshing updates for project:', selectedProject.id);
      loadProjectUpdates(selectedProject.id);
    } else {
      console.log('No project selected for refresh');
    }
  }

  // Load progress timeline function
  function loadProgressTimeline() {
    window.location.reload();
  }

  // ===== HORIZONTAL TIMELINE FUNCTIONS =====
  
  // Load timeline for the selected project
  async function loadProjectTimeline() {
    if (!selectedProject) return;
    
    try {
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      if (!token) return;
      
      console.log('Loading timeline for project:', selectedProject.id);
      
      const response = await fetch(`${API_URL}/projects/${selectedProject.id}/milestones`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.milestones) {
          // Store milestones in selectedProject for status detection
          selectedProject.milestones = data.milestones;
          await renderProjectTimeline(selectedProject, data.milestones);
          
          // Update project status after milestones are loaded
          setTimeout(() => {
            updateProjectStatusWithMilestones();
          }, 100);
        } else {
          console.log('No milestones found for project');
          hideTimelineSection();
        }
      } else {
        console.error('Failed to load milestones:', response.status);
        hideTimelineSection();
      }
    } catch (error) {
      console.error('Error loading project timeline:', error);
      hideTimelineSection();
    }
  }
  
  // Render timeline for a project
  async function renderProjectTimeline(project, milestones) {
    const timelineSection = document.getElementById('horizontalTimelineSection');
    const timelineContainer = document.getElementById('projectTimelineContainer');
    const startDateSpan = document.getElementById('timelineStartDate');
    const targetDateSpan = document.getElementById('timelineTargetDate');
    const actualDateSpan = document.getElementById('timelineActualDate');
    const expectedDaysSpan = document.getElementById('timelineExpectedDays');
    
    if (!timelineSection || !timelineContainer || !startDateSpan || !targetDateSpan || !actualDateSpan || !expectedDaysSpan) {
      console.error('Timeline elements not found');
      return;
    }
    
    // Show timeline section
    timelineSection.style.display = 'block';
    
    // Update date labels
    if (project.startDate) {
      startDateSpan.textContent = new Date(project.startDate).toLocaleDateString();
    }
    if (project.targetCompletionDate || project.targetDateOfCompletion || project.endDate) {
      targetDateSpan.textContent = new Date(project.targetCompletionDate || project.targetDateOfCompletion || project.endDate).toLocaleDateString();
    }
    
    // Update actual completion date
    if (project.completionDate || project.actualCompletionDate) {
      actualDateSpan.textContent = new Date(project.completionDate || project.actualCompletionDate).toLocaleDateString();
    } else {
      actualDateSpan.textContent = 'â€“';
    }
    
    // Update expected days
    if (project.expectedDaysOfCompletion) {
      expectedDaysSpan.textContent = `${project.expectedDaysOfCompletion} days`;
    } else {
      expectedDaysSpan.textContent = 'â€“';
    }
    
    // Get timeline container
    const milestonesContainer = timelineContainer.querySelector('.timeline-milestones');
    if (!milestonesContainer) return;
    
    // Clear existing milestones
    milestonesContainer.innerHTML = '';
    
    if (!project.startDate || (!project.targetCompletionDate && !project.targetDateOfCompletion && !project.endDate)) {
      console.log('Project missing start or target completion date');
      return;
    }
    
    // Fetch progress data if not available
    let progressData = project.progress;
    if (!progressData) {
      try {
        const token = document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
        const timestamp = new Date().getTime();
        const progressResponse = await fetch(`http://localhost:3000/api/projects/progress/${project.id}?_t=${timestamp}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (progressResponse.ok) {
          const progressResult = await progressResponse.json();
          if (progressResult.success) {
            progressData = progressResult.data.progress;
          }
        }
      } catch (error) {
        console.error('Error fetching progress data in renderProjectTimeline:', error);
      }
    }
    
    // Use overall progress data from the project object (already available)
    const timelineProgress = progressData?.overall || 0;
    

    
    // Create progress bar element
    const progressBar = document.createElement('div');
    progressBar.className = 'timeline-progress-bar';
    progressBar.style.width = '0%'; // Start at 0%
    progressBar.style.zIndex = '1'; // Ensure it's above the track but below milestones
    progressBar.style.position = 'absolute';
    progressBar.style.top = '0';
    progressBar.style.left = '0';
    progressBar.style.height = '100%';
    progressBar.style.backgroundColor = '#3b82f6';
    progressBar.style.borderRadius = '4px';
    progressBar.style.transition = 'width 1s ease-in-out';
    
              milestonesContainer.appendChild(progressBar);
          
          // Create progress indicator icon
          const progressIndicator = document.createElement('div');
          progressIndicator.className = 'progress-indicator';
          progressIndicator.innerHTML = `
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
          `;
          progressIndicator.style.position = 'absolute';
          progressIndicator.style.top = '50%';
          progressIndicator.style.left = '0%';
          progressIndicator.style.width = '20px';
          progressIndicator.style.height = '20px';
          progressIndicator.style.backgroundColor = '#1d4ed8';
          progressIndicator.style.borderRadius = '50%';
          progressIndicator.style.border = '2px solid white';
          progressIndicator.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          progressIndicator.style.zIndex = '3';
          progressIndicator.style.transition = 'left 1s ease-in-out, transform 0.2s ease';
          progressIndicator.style.cursor = 'pointer';
          progressIndicator.style.display = 'flex';
          progressIndicator.style.alignItems = 'center';
          progressIndicator.style.justifyContent = 'center';
          progressIndicator.style.color = 'white';
          progressIndicator.style.transform = 'translateY(-50%) translateX(-50%)';
          
          // Add hover tooltip with detailed information
          const tooltipText = `
            Project: ${project.name}
            Overall Progress: ${timelineProgress.toFixed(2)}%
            Timeline Progress: 50%
            Budget Progress: ${progressData?.budget || 0}%
            Physical Progress: ${progressData?.physical || 0}%
            Status: ${project.status || 'ONGOING'}
          `.trim();
          

          

          
          progressIndicator.setAttribute('title', tooltipText);
          
          milestonesContainer.appendChild(progressIndicator);
          
          // Animate the progress bar and indicator
          setTimeout(() => {
            progressBar.style.width = `${timelineProgress}%`;
            // Position indicator at the end of the progress bar, centered
            progressIndicator.style.left = `${timelineProgress}%`;
          }, 100);
    
              // Update progress text
          const progressText = document.getElementById('horizontalTimelineProgressText');
          if (progressText) {
            progressText.textContent = `Overall Progress: ${timelineProgress.toFixed(2)}%`;
          }
    

    
    const projectStart = new Date(project.startDate);
    const projectEnd = new Date(project.targetCompletionDate || project.targetDateOfCompletion || project.endDate);
    const totalDuration = projectEnd - projectStart;
    
    console.log('Rendering timeline with milestones:', milestones.length);
    
    milestones.forEach(milestone => {
      // Use milestone due date as the timeline position
      if (milestone.dueDate) {
        const milestoneDate = new Date(milestone.dueDate);
        const position = ((milestoneDate - projectStart) / totalDuration) * 100;
        
        // Check if milestone is overdue and should be marked as delayed
        let status = milestone.status || 'pending';
        const dueDate = milestone.dueDate || milestone.deadline || milestone.targetDate || milestone.completionDate;
        if (dueDate && status !== 'completed' && status !== 'under_approval' && status !== 'revision_request') {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const checkDate = new Date(dueDate);
          checkDate.setHours(0, 0, 0, 0);
          
          if (checkDate < today && status === 'pending') {
            status = 'delayed';
          }
        }
        
        // Ensure position is within bounds
        const clampedPosition = Math.max(0, Math.min(100, position));
        
        const milestoneElement = document.createElement('div');
        milestoneElement.className = `timeline-milestone ${status}`;
        milestoneElement.style.left = `${clampedPosition}%`;
        milestoneElement.style.width = '8px'; // Fixed width for milestone markers
        milestoneElement.style.marginLeft = '-4px'; // Center the marker
        milestoneElement.setAttribute('data-milestone', JSON.stringify(milestone));
        
        // Add hover popup
        milestoneElement.addEventListener('mouseenter', (e) => showTimelinePopup(e, milestone));
        milestoneElement.addEventListener('mouseleave', hideTimelinePopup);
        
        milestonesContainer.appendChild(milestoneElement);
      }
    });
  }
  
  // Show timeline popup
  function showTimelinePopup(event, milestone) {
    const popup = document.createElement('div');
    popup.className = 'timeline-popup';
    popup.innerHTML = `
      <div class="font-semibold text-gray-800 mb-2">${milestone.title}</div>
      <div class="text-sm text-gray-600 mb-1">${milestone.description || 'No description'}</div>
      <div class="text-xs text-gray-500">
        <div>Due Date: ${milestone.dueDate ? new Date(milestone.dueDate).toLocaleDateString() : 'Not set'}</div>
        <div>Status: ${milestone.status ? milestone.status.replace('_', ' ') : 'Pending'}</div>
        <div>Weight: ${milestone.weight || 0}%</div>
        <div>Budget: â‚±${parseFloat(milestone.plannedBudget || 0).toLocaleString()}</div>
      </div>
    `;
    
    document.body.appendChild(popup);
    
    const rect = event.target.getBoundingClientRect();
    popup.style.left = `${rect.left + rect.width / 2 - popup.offsetWidth / 2}px`;
    popup.style.top = `${rect.top - popup.offsetHeight - 10}px`;
    
    setTimeout(() => popup.classList.add('show'), 10);
  }
  
  // Hide timeline popup
  function hideTimelinePopup() {
    const popup = document.querySelector('.timeline-popup');
    if (popup) {
      popup.classList.remove('show');
      setTimeout(() => popup.remove(), 300);
    }
  }
  
  // Hide timeline section
  function hideTimelineSection() {
    const timelineSection = document.getElementById('horizontalTimelineSection');
    if (timelineSection) {
      timelineSection.style.display = 'none';
    }
  }
  
  // Old refreshProjectTimeline function removed - using enhanced version below



  // View project details function
  // viewProjectDetails function moved to action buttons section to avoid duplicate

  // Submission History & Analytics now uses the standard toggleProjectSection function

  // Setup event listeners for analytics section
  function setupAnalyticsEventListeners() {
    console.log('ðŸ”§ Setting up analytics event listeners...');
    
    // Timeline view buttons
    const listViewBtn = document.getElementById('listViewBtn');
    const timelineViewBtn = document.getElementById('timelineViewBtn');
    
    if (listViewBtn) {
      listViewBtn.addEventListener('click', () => toggleTimelineView('list'));
      console.log('âœ… List view button event listener added');
    } else {
      console.warn('âš ï¸ List view button not found');
    }
    
    if (timelineViewBtn) {
      timelineViewBtn.addEventListener('click', () => toggleTimelineView('timeline'));
      console.log('âœ… Timeline view button event listener added');
    } else {
      console.warn('âš ï¸ Timeline view button not found');
    }
    
    // Export and refresh buttons
    const exportBtn = document.querySelector('button[class*="btn-warning"]');
    const refreshBtn = document.querySelector('button[class*="btn-primary-alt"]');
    
    if (exportBtn) {
      exportBtn.removeAttribute('onclick');
      exportBtn.addEventListener('click', exportSubmissionReport);
      console.log('âœ… Export button event listener added');
    }
    
    if (refreshBtn) {
      refreshBtn.removeAttribute('onclick');
      refreshBtn.addEventListener('click', refreshSubmissionHistory);
      console.log('âœ… Refresh button event listener added');
    }
  }

  // Timeline view toggle functionality - REMOVED DUPLICATE (function moved to analytics section)

  // Setup horizontal scroll functionality for project cards
  function setupHorizontalScroll() {
    const projectsGrid = document.getElementById('projectsGrid');
    const scrollLeftBtn = document.getElementById('scrollLeft');
    const scrollRightBtn = document.getElementById('scrollRight');
    
    if (!projectsGrid || !scrollLeftBtn || !scrollRightBtn) return;
    
    // Check if scroll buttons should be visible
    function updateScrollButtons() {
      const scrollWidth = projectsGrid.scrollWidth;
      const clientWidth = projectsGrid.clientWidth;
      const scrollLeft = projectsGrid.scrollLeft;
      
      if (scrollWidth > clientWidth) {
        scrollLeftBtn.classList.toggle('hidden', scrollLeft === 0);
        scrollRightBtn.classList.toggle('hidden', scrollLeft >= scrollWidth - clientWidth - 10);
      } else {
        scrollLeftBtn.classList.add('hidden');
        scrollRightBtn.classList.add('hidden');
      }
    }
    
    // Scroll functionality - updated for larger cards
    scrollLeftBtn.addEventListener('click', () => {
      projectsGrid.scrollBy({ left: -408, behavior: 'smooth' }); // Card width (384px) + gap (24px)
    });
    
    scrollRightBtn.addEventListener('click', () => {
      projectsGrid.scrollBy({ left: 408, behavior: 'smooth' }); // Card width (384px) + gap (24px)
    });
    
    // Update buttons on scroll
    projectsGrid.addEventListener('scroll', updateScrollButtons);
    
    // Update buttons on resize
    window.addEventListener('resize', updateScrollButtons);
    
    // Initial update
    setTimeout(updateScrollButtons, 100);
  }

  // Update summary cards with current data
  function updateSummaryCards(projectsData) {
    const totalProjects = projectsData.length;
    const pendingSubmissions = projectsData.filter(p => p.hasPendingSubmissions || p.status === 'pending_submission').length;
    const completedReviews = projectsData.filter(p => p.status === 'completed' || p.status === 'approved').length;
    const delayedProjects = projectsData.filter(p => p.status === 'delayed' || p.hasDelayedMilestones).length;

    document.getElementById('totalProjectsCount').textContent = totalProjects;
    document.getElementById('pendingSubmissionsCount').textContent = pendingSubmissions;
    document.getElementById('completedReviewsCount').textContent = completedReviews;
    document.getElementById('delayedProjectsCount').textContent = delayedProjects;
  }

  // Search and filter functionality
  let allProjects = [];
  
  function initializeSearchAndFilter() {
    const searchInput = document.getElementById('projectSearchInput');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    
    if (searchInput) {
      searchInput.addEventListener('input', filterProjects);
    }
    if (statusFilter) {
      statusFilter.addEventListener('change', filterProjects);
    }
    if (priorityFilter) {
      priorityFilter.addEventListener('change', filterProjects);
    }
  }
  
  function filterProjects() {
    const searchTerm = document.getElementById('projectSearchInput')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const priorityFilter = document.getElementById('priorityFilter')?.value || '';
    
    let filteredProjects = allProjects.filter(project => {
      const matchesSearch = !searchTerm || 
        project.name?.toLowerCase().includes(searchTerm) ||
        project.projectCode?.toLowerCase().includes(searchTerm) ||
        project.status?.toLowerCase().includes(searchTerm);
      
      const matchesStatus = !statusFilter || project.status === statusFilter;
      const matchesPriority = !priorityFilter || project.priority === priorityFilter;
      
      return matchesSearch && matchesStatus && matchesPriority;
    });
    
    renderProjectsGrid(filteredProjects);
    updateSummaryCards(filteredProjects);
  }
  
  function clearFilters() {
    document.getElementById('projectSearchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    renderProjectsGrid(allProjects);
    updateSummaryCards(allProjects);
  }

  // Project Management Dashboard functions
  function updateProjectManagementDashboard(project) {
    if (!project) {
      document.getElementById('projectManagementDashboard').style.display = 'none';
      return;
    }

    console.log('ðŸ“‹ Showing Project Management Dashboard for:', project.name);
    document.getElementById('projectManagementDashboard').style.display = 'block';
    
    // Auto-scroll to the dashboard with smooth animation - matching submit-update.astro
    setTimeout(() => {
      const dashboard = document.getElementById('projectManagementDashboard');
      if (dashboard) {
        console.log('ðŸŽ¯ Auto-scrolling to Project Management Dashboard');
        dashboard.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }
    }, 300);
    
    // Check and update project status before displaying
    checkProjectDelayedStatus(project.id);
    
    // Load timeline if timeline section exists and is expanded
    if (document.getElementById('timelineSection')) {
      const timelineSection = document.getElementById('timelineSection');
      if (timelineSection.classList.contains('expanded')) {
        loadModernTimeline(true);
      }
    }

    // Update progress cards - use actual project overall progress instead of averaging divisions
    const timelineProgress = parseFloat(project.progress?.timeline || project.timelineProgress || 0);
    const budgetProgress = parseFloat(project.progress?.budget || project.budgetProgress || 0);
    const physicalProgress = parseFloat(project.progress?.physical || project.physicalProgress || 0);
    const overallProgress = parseFloat(project.progress?.overall || project.progress?.overallProgress || project.overallProgress || 0);

    document.getElementById('overallProgress').textContent = `${overallProgress.toFixed(2)}%`;
    document.getElementById('timelineProgress').textContent = `${timelineProgress.toFixed(1)}%`;
    document.getElementById('budgetProgress').textContent = `${budgetProgress.toFixed(1)}%`;
    document.getElementById('physicalProgress').textContent = `${physicalProgress.toFixed(1)}%`;

    // Animate progress bars with dynamic colors
    setTimeout(() => {
      animateDashboardProgressBars([
        { element: 'overallProgressBar', progress: overallProgress },
        { element: 'timelineProgressBar', progress: timelineProgress },
        { element: 'budgetProgressBar', progress: budgetProgress },
        { element: 'physicalProgressBar', progress: physicalProgress }
      ]);
    }, 100);

    // Update basic information
    const projectBasicInfo = document.getElementById('projectBasicInfo');
    projectBasicInfo.innerHTML = `
      <div class="flex justify-between">
        <span class="text-gray-600">Project Name:</span>
        <span class="font-medium">${project.name || project.projectName || 'N/A'}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Project Code:</span>
        <span class="font-medium">${project.projectCode || 'N/A'}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Total Budget:</span>
        <span class="font-medium text-green-600">â‚±${parseFloat(project.totalBudget || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Start Date:</span>
        <span class="font-medium">${project.startDate ? new Date(project.startDate).toLocaleDateString() : 'N/A'}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Target Completion Date:</span>
        <span class="font-medium">${project.targetCompletionDate || project.targetDateOfCompletion || project.endDate ? new Date(project.targetCompletionDate || project.targetDateOfCompletion || project.endDate).toLocaleDateString() : 'N/A'}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Actual Completion Date:</span>
        <span class="font-medium">${project.completionDate || project.actualCompletionDate ? new Date(project.completionDate || project.actualCompletionDate).toLocaleDateString() : 'â€“'}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Expected Days:</span>
        <span class="font-medium">${project.expectedDaysOfCompletion ? project.expectedDaysOfCompletion + ' days' : 'â€“'}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Priority:</span>
        <span class="font-medium ${
          project.priority === 'high' ? 'text-red-600' : 
          project.priority === 'medium' ? 'text-yellow-600' : 
          'text-green-600'
        }">${project.priority?.toUpperCase() || 'MEDIUM'}</span>
      </div>
    `;

    // Update status information
    const projectStatusInfo = document.getElementById('projectStatusInfo');
    
    // Ensure milestones is an array
    const milestones = Array.isArray(project.milestones) ? project.milestones : [];
    const totalMilestones = milestones.length;
    const completedMilestones = milestones.filter(m => m.status === 'completed').length;
    const delayedMilestones = milestones.filter(m => {
      const dueDate = new Date(m.dueDate || m.deadline);
      return dueDate < new Date() && m.status !== 'completed';
    }).length;

    // Get the updated project status after checking for delays
    const updatedProject = allProjects.find(p => p.id === project.id) || project;
    let actualStatus = updatedProject.status || updatedProject.projectStatus || updatedProject.workflowStatus || 'pending';
    
    // If there are delayed milestones and status hasn't been updated, force it to delayed
    if (delayedMilestones > 0 && actualStatus !== 'completed' && actualStatus !== 'delayed') {
      actualStatus = 'delayed';
      // Update the project status in the array
      if (updatedProject.id) {
        updateProjectStatus(updatedProject.id, 'delayed', 'Milestone(s) past due date');
      }
    }
    
    // Status determination complete

    projectStatusInfo.innerHTML = `
      <div class="flex justify-between">
        <span class="text-gray-600">Status:</span>
        <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(actualStatus)}">
          ${actualStatus.toUpperCase()}
        </span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Total Milestones:</span>
        <span class="font-medium">${totalMilestones}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Completed:</span>
        <span class="font-medium text-green-600">${completedMilestones}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Delayed:</span>
        <span class="font-medium text-red-600">${delayedMilestones}</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Overall Progress:</span>
        <span class="font-bold text-blue-600">${overallProgress.toFixed(1)}%</span>
      </div>
    `;
  }

  function refreshProjectData() {
    if (selectedProject) {
      // Refresh the current project data
      selectProject(selectedProject.id);
    }
  }

  function exportProjectReport() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }
    // Implement export functionality
    alert('Export functionality will be implemented in the next phase.');
  }

  function viewProjectTimeline() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }
    // Expand and show the enhanced timeline section
    const timelineSection = document.getElementById('timelineSection');
    if (timelineSection) {
      // Expand the timeline section if not already expanded
      if (!timelineSection.classList.contains('expanded')) {
        toggleProjectSection('timeline');
      }
      // Scroll to the timeline section
      setTimeout(() => {
        timelineSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  }

  function viewProjectDetails() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }
    // Open ProjectDetailsModal component
    if (window.showProjectDetailsModal) {
      window.showProjectDetailsModal(selectedProject.id);
    } else {
      console.error('ProjectDetailsModal not available');
      alert('Unable to load project details. Please refresh the page.');
    }
  }

  function viewSubmission() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }
    // Navigate to submission view or show submission modal
    alert('View Submission functionality will be implemented in the next phase.');
  }

  function viewSubmissionHistory() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }
    // Show the Submission History & Analytics section
    const analyticsSection = document.querySelector('.profile-card:has(#submissionHistoryContent)');
    if (analyticsSection) {
      analyticsSection.scrollIntoView({ behavior: 'smooth' });
      // Expand the section if it's collapsed
      const content = document.getElementById('submissionHistoryContent');
      if (content && content.style.maxHeight === '0px') {
        toggleSubmissionHistorySection();
      }
    } else {
      alert('Submission history section not found.');
    }
  }

  function manageMilestones() {
    if (!selectedProject) {
      alert('Please select a project first.');
      return;
    }
    // Implement milestone management
    alert('Milestone management will be implemented in the next phase.');
  }

  function getStatusColor(status) {
    switch(status?.toLowerCase()) {
      case 'completed':
      case 'complete':
        return 'bg-green-100 text-green-700 border-green-200';
      case 'ongoing':
        return 'bg-blue-100 text-blue-700 border-blue-200';
      case 'delayed':
        return 'bg-red-100 text-red-700 border-red-200';
      case 'pending':
        return 'bg-yellow-100 text-yellow-700 border-yellow-200';
      default:
        return 'bg-gray-100 text-gray-600 border-gray-200';
    }
  }

  // Submission Review Center functions
  let milestoneSubmissions = []; // Global storage for milestone submissions
  let currentSubmissionFilter = 'all';

  function showSubmissionReviewCenter() {
    document.getElementById('submissionReviewCenter').style.display = 'block';
    updateSubmissionCount(); // Initialize with 0 count
    loadMilestoneSubmissions();
  }

  async function loadMilestoneSubmissions() {
    console.log('ðŸ“‹ Loading milestone submissions from EIU updates...');
    
    // Always clear existing submissions first when loading for a new project
    const container = document.getElementById('submissionsContainer');
    if (container) {
      container.innerHTML = '';
    }
    
    try {
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      if (!token) {
        console.warn('âš ï¸ No authentication token found');
        showEmptySubmissionsState();
        return;
      }

      // Check if we have a selected project
      if (!selectedProject || !selectedProject.id) {
        console.warn('âš ï¸ No project selected for milestone submissions');
        showEmptySubmissionsState();
        return;
      }

      // Show loading state
      showSubmissionsLoading();

      // Fetch milestone submissions for the specific project only
      console.log('ðŸ” Fetching submissions for project ID:', selectedProject.id, 'Type:', typeof selectedProject.id);
      console.log('ðŸ” Full selectedProject object:', selectedProject);
      console.log('ðŸ” API URL being called:', `${API_URL}/milestones/milestone-submissions?projectId=${selectedProject.id}`);
      const response = await fetch(`${API_URL}/milestones/milestone-submissions?projectId=${selectedProject.id}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      console.log('ðŸ“¡ API Response status:', response.status, response.statusText);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ API Error Response:', errorText);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('ðŸ“¦ EIU submissions received for project:', selectedProject.id, data);
      console.log('ðŸ“¦ Raw API response:', JSON.stringify(data, null, 2));
      console.log('ðŸ“¦ Response success:', data.success, 'submissions array:', data.submissions, 'submissions length:', data.submissions?.length);

      if (data.success && data.submissions) {
        // Store all submissions globally for filtering (don't filter here)
        milestoneSubmissions = data.submissions;

        console.log('ðŸ“‹ All milestone submissions for project:', selectedProject.id, milestoneSubmissions.length);
        console.log('ðŸ“‹ Submissions data:', milestoneSubmissions);
        
        if (milestoneSubmissions.length > 0) {
          displayMilestoneSubmissions(milestoneSubmissions);
          updateSubmissionCountBadge(milestoneSubmissions.length);
        } else {
          console.log('ðŸ“ No submissions found - showing empty state');
          showEmptySubmissionsState();
        }
      } else {
        console.log('ðŸ“ No submissions found for project:', selectedProject.id);
        console.log('ðŸ“ API response success:', data.success, 'submissions:', data.submissions);
        showEmptySubmissionsState();
      }
      
    } catch (error) {
      console.error('âŒ Error loading milestone submissions:', error);
      console.error('âŒ Error stack:', error.stack);
      showEmptySubmissionsState();
      
      // Show user-friendly error message
      if (window.showNotification) {
        window.showNotification('Failed to load milestone submissions. Please try again.', 'error');
      }
    }
  }

  // Display milestone submissions with enhanced UI
  function displayMilestoneSubmissions(submissions) {
    console.log('ðŸŽ¨ Displaying milestone submissions:', submissions.length);
    
    // Store submissions globally for filtering
    milestoneSubmissions = submissions;
    
    // Reset filter to 'all' when displaying new submissions
    currentSubmissionFilter = 'all';
    
    // Reset filter buttons to show 'All Submissions' as active
    document.querySelectorAll('.submission-tab-button').forEach(btn => {
      btn.className = 'submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap';
    });
    
    const allButton = document.getElementById('allSubmissionsTab');
    if (allButton) {
      allButton.className = 'submission-tab-button active inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap';
    }
    
    // Hide loading and empty states
    hideSubmissionsLoading();
    hideEmptySubmissionsState();
    
    // Use renderSubmissions to display with filtering capability
    renderSubmissions();
    
    console.log('âœ… Milestone submissions displayed successfully');
  }

  function renderSubmissions() {
    console.log('ðŸŽ¨ renderSubmissions called with:', {
      totalSubmissions: milestoneSubmissions.length,
      currentFilter: currentSubmissionFilter,
      containerExists: !!document.getElementById('submissionsContainer')
    });
    
    const container = document.getElementById('submissionsContainer');
    if (!container) {
      console.error('âŒ submissionsContainer not found!');
      return;
    }

    const filteredSubmissions = milestoneSubmissions.filter(submission => {
      if (currentSubmissionFilter === 'all') return true;
      return submission.status === currentSubmissionFilter;
    });

    console.log('ðŸ” Filtered submissions:', {
      originalCount: milestoneSubmissions.length,
      filteredCount: filteredSubmissions.length,
      filter: currentSubmissionFilter
    });

    if (filteredSubmissions.length === 0) {
      console.log('ðŸ“ No filtered submissions - showing empty message');
      container.innerHTML = `
        <div class="text-center py-12 text-gray-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="text-lg font-medium mb-2">No ${currentSubmissionFilter === 'all' ? '' : currentSubmissionFilter.replace('_', ' ')} Submissions</p>
          <p class="text-sm">EIU milestone submissions will appear here for your review</p>
        </div>
      `;
      return;
    }

    console.log('ðŸŽ¨ Rendering', filteredSubmissions.length, 'submission cards');
    
    try {
      const cardsHtml = filteredSubmissions.map((submission, index) => {
        console.log(`ðŸŽ¨ Rendering card ${index + 1}:`, {
          id: submission.id,
          projectId: submission.projectId,
          milestoneId: submission.milestoneId,
          status: submission.status
        });
        return renderMilestoneSubmissionCard(submission);
      }).join('');
      
      container.innerHTML = cardsHtml;
      console.log('âœ… Cards rendered successfully, container innerHTML length:', container.innerHTML.length);
      
      // Initialize photo slideshows after rendering cards
      setTimeout(() => {
        initializePhotoSlideshows();
      }, 100);
      
    } catch (error) {
      console.error('âŒ Error rendering submission cards:', error);
      console.error('âŒ Error stack:', error.stack);
    }
  }

  function renderMilestoneSubmissionCard(submission) {
    const submissionDate = new Date(submission.submittedAt || submission.createdAt);
    const project = submission.project || {};
    const milestone = submission.milestone || {};
    const submitter = submission.submitterInfo || submission.submitter || {};
    
    // Debug: Log submission data to understand structure
    console.log('ðŸ” Rendering submission card:', {
      submissionId: submission.id,
      files: submission.files,
      photoEvidence: submission.photoEvidence,
      physical: submission.physical,
      project: project,
      milestone: milestone
    });
    
    // Enhanced status colors with better visual hierarchy
    const statusColors = {
      'pending_review': 'bg-gradient-to-r from-yellow-50 to-amber-50 text-yellow-800 border-yellow-300 shadow-yellow-100',
      'under_review': 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-800 border-purple-300 shadow-purple-100',
      'approved': 'bg-gradient-to-r from-green-50 to-emerald-50 text-green-800 border-green-300 shadow-green-100',
      'needs_revision': 'bg-gradient-to-r from-red-50 to-rose-50 text-red-800 border-red-300 shadow-red-100',
      'rejected': 'bg-gradient-to-r from-gray-50 to-slate-50 text-gray-800 border-gray-300 shadow-gray-100'
    };

    const statusTexts = {
      'pending_review': 'Pending Review',
      'under_review': 'Under Review',
      'approved': 'Approved',
      'needs_revision': 'Needs Revision',
      'rejected': 'Rejected'
    };

    // Format currency
    const formatCurrency = (amount) => {
      if (!amount) return 'â‚±0.00';
      return `â‚±${parseFloat(amount).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    };

    // Format dates
    const formatDate = (date) => {
      if (!date) return 'â€“';
      return new Date(date).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    };

    // Format progress percentage
    const formatProgress = (progress) => {
      if (!progress) return '0%';
      return `${parseFloat(progress).toFixed(1)}%`;
    };

    return `
      <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100 group hover:border-amber-200">
        <!-- Enhanced Header with Photo Evidence -->
        <div class="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 border-b border-amber-100 relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
          
          <!-- Photo Evidence Section - Moved to Milestone Update Details as Background Slideshow -->
          ${submission.photoEvidence || submission.files?.length ? '' : ''}

          <!-- Project Header -->
          <div class="p-6 relative z-10">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-4 mb-4">
                  <div class="icon-container bg-gradient-to-br from-amber-500 to-orange-600 shadow-xl">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-xl font-bold text-gray-800 group-hover:text-amber-700 transition-colors duration-300 mb-1">
                      ${project.name || 'Project Name Not Available'}
                    </h3>
                    <div class="flex items-center gap-4 text-sm">
                      <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-semibold">
                        ${project.projectCode || 'No Code'}
                      </span>
                      <span class="text-gray-600 font-medium">
                        Submission: ${submissionDate.toLocaleDateString('en-US', { 
                          month: 'short', 
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex flex-col items-end gap-3">
                <span class="px-4 py-2 rounded-xl text-sm font-bold border shadow-md ${statusColors[submission.status] || statusColors['pending_review']}">
                  ${statusTexts[submission.status] || 'Pending Review'}
                </span>
                <div class="flex items-center gap-2 text-xs text-gray-500 bg-white/70 backdrop-blur-sm px-3 py-1 rounded-lg border">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                  </svg>
                  ID: #${submission.id}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Content Section -->
        <div class="p-6 space-y-6">
          <!-- Project Information Grid -->
          <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-5 border border-gray-100">
            <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Project Information
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Project Description</label>
                <div class="text-sm text-gray-800 leading-relaxed">${project.description || 'No description available'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Total Budget</label>
                <div class="text-lg font-bold text-green-600">${formatCurrency(project.totalBudget)}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Overall Progress</label>
                <div class="flex items-center gap-3">
                  <div class="flex-1 bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${project.overallProgress || 0}%"></div>
                  </div>
                  <span class="text-sm font-bold text-blue-600">${formatProgress(project.overallProgress)}</span>
                </div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Start Date</label>
                <div class="text-sm font-semibold text-gray-800">${formatDate(project.startDate)}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Target Completion Date</label>
                <div class="text-sm font-semibold text-gray-800">${formatDate(project.targetCompletionDate || project.targetDateOfCompletion || project.endDate)}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Actual Completion Date</label>
                <div class="text-sm font-semibold text-gray-800">${formatDate(project.completionDate || project.actualCompletionDate) || 'â€“'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Expected Days</label>
                <div class="text-sm font-semibold text-gray-800">${project.expectedDaysOfCompletion ? project.expectedDaysOfCompletion + ' days' : 'â€“'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Submitted By</label>
                                <div class="text-sm font-semibold text-gray-800">${(() => {
                  // First, try to get EIU data from the selected project (which has complete data)
                  if (selectedProject && selectedProject.eiuPersonnel) {
                    const eiuName = selectedProject.eiuPersonnel.name || selectedProject.eiuPersonnel.fullName;
                    if (eiuName && eiuName !== 'EIU User') {
                      return eiuName;
                    }
                  }
                  
                  // Fallback to submission data
                  if (submission.submitterInfo?.fullName && submission.submitterInfo.fullName !== 'EIU User') {
                    return submission.submitterInfo.fullName;
                  } else if (submission.submitter?.name && submission.submitter.name !== 'EIU User') {
                    return submission.submitter.name;
                  }
                  
                  return 'EIU Personnel';
                })()}</div>
                <div class="text-xs text-gray-500 mt-1">${(() => {
                  // First, try to get company data from the selected project (which has complete data)
                  if (selectedProject && selectedProject.eiuPersonnel) {
                    const company = selectedProject.eiuPersonnel.externalCompanyName || selectedProject.eiuPersonnel.company || selectedProject.eiuPersonnel.department;
                    if (company && company !== 'External Partner') {
                      return company;
                    }
                  }
                  
                  // Fallback to submission data
                  if (submission.submitterInfo?.company && submission.submitterInfo.company !== 'External Partner') {
                    return submission.submitterInfo.company;
                  } else if (submission.submitter?.organization) {
                    return submission.submitter.organization;
                  }
                  
                  return 'EIU';
                })()}</div>
              </div>
            </div>
          </div>

          <!-- Milestone Update Section - Enhanced with Photo Slideshow Background -->
          <div class="relative rounded-xl p-5 border-2 border-amber-200 shadow-sm overflow-hidden" id="milestone-section-${submission.id}">
            <!-- Photo Evidence Slideshow Background -->
            ${(() => {
              // Check multiple possible sources for photo evidence
              let photoFiles = [];
              
              // Check submission.photoEvidence (JSON field from MilestoneSubmission model)
              if (submission.photoEvidence && Array.isArray(submission.photoEvidence)) {
                photoFiles = submission.photoEvidence;
              }
              
              // Check submission.files
              if (photoFiles.length === 0 && submission.files && Array.isArray(submission.files)) {
                photoFiles = submission.files.filter(file => file.type?.startsWith('image/') || file.name?.match(/\.(jpg|jpeg|png|gif)$/i));
              }
              
              // Check submission.physical.photoEvidence
              if (photoFiles.length === 0 && submission.physical?.photoEvidence) {
                if (Array.isArray(submission.physical.photoEvidence)) {
                  photoFiles = submission.physical.photoEvidence;
                } else if (typeof submission.physical.photoEvidence === 'string') {
                  photoFiles = [{ url: submission.physical.photoEvidence, name: 'photo.jpg' }];
                }
              }
              
              // Check submission.uploadedFiles for photo types
              if (photoFiles.length === 0 && submission.uploadedFiles) {
                photoFiles = submission.uploadedFiles.filter(file => 
                  file.type?.startsWith('image/') || file.name?.match(/\.(jpg|jpeg|png|gif)$/i)
                );
              }
              
              console.log('ðŸ“¸ Photo files found for submission', submission.id, ':', photoFiles);
              
              if (photoFiles.length > 0) {
                return `
                  <div class="absolute inset-0 opacity-20">
                    ${photoFiles.map((file, index) => {
                      let imageUrl = file.url || file.path || file.src || file.filePath;
                      
                      // Handle different URL formats
                      if (imageUrl && !imageUrl.startsWith('http')) {
                        if (imageUrl.startsWith('/')) {
                          imageUrl = `http://localhost:3000${imageUrl}`;
                        } else {
                          imageUrl = `http://localhost:3000/uploads/${imageUrl}`;
                        }
                      }
                      
                      return `
                        <div class="absolute inset-0 bg-cover bg-center transition-opacity duration-1000 ${index === 0 ? 'opacity-100' : 'opacity-0'}" 
                             style="background-image: url('${imageUrl}')" 
                             data-slide="${index}"
                             onerror="this.style.display='none'"></div>
                      `;
                    }).join('')}
                  </div>
                  <div class="absolute inset-0 bg-gradient-to-r from-amber-50/90 to-yellow-50/90"></div>
                `;
              } else {
                return '<div class="absolute inset-0 bg-gradient-to-r from-amber-50 to-yellow-50"></div>';
              }
            })()}
            
            <div class="relative z-10">
              <h4 class="text-lg font-bold text-amber-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                </svg>
                Milestone Update Details
                ${(() => {
                  // Count photos from all possible sources
                  let photoCount = 0;
                  
                  // Check submission.photoEvidence (JSON field from MilestoneSubmission model)
                  if (submission.photoEvidence && Array.isArray(submission.photoEvidence)) {
                    photoCount = submission.photoEvidence.length;
                  }
                  
                  if (photoCount === 0 && submission.files && Array.isArray(submission.files)) {
                    photoCount = submission.files.filter(file => file.type?.startsWith('image/') || file.name?.match(/\.(jpg|jpeg|png|gif)$/i)).length;
                  }
                  
                  if (photoCount === 0 && submission.physical?.photoEvidence) {
                    if (Array.isArray(submission.physical.photoEvidence)) {
                      photoCount = submission.physical.photoEvidence.length;
                    } else if (typeof submission.physical.photoEvidence === 'string') {
                      photoCount = 1;
                    }
                  }
                  
                  if (photoCount === 0 && submission.uploadedFiles) {
                    photoCount = submission.uploadedFiles.filter(file => 
                      file.type?.startsWith('image/') || file.name?.match(/\.(jpg|jpeg|png|gif)$/i)
                    ).length;
                  }
                  
                  return photoCount > 0 ? `
                    <span class="ml-auto text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-semibold">
                      ${photoCount} Photo${photoCount > 1 ? 's' : ''}
                    </span>
                  ` : '';
                })()}
              </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-white rounded-lg p-4 border border-amber-200 shadow-sm">
                <label class="block text-xs font-bold text-amber-600 uppercase tracking-wide mb-2">Milestone Name (Item of Work)</label>
                <div class="text-sm font-bold text-gray-800 bg-amber-50 rounded-lg p-3 border border-amber-100">
                  ${milestone.title || milestone.name || 'Milestone name not specified'}
                </div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-amber-200 shadow-sm">
                <label class="block text-xs font-bold text-amber-600 uppercase tracking-wide mb-2">Due Date</label>
                <div class="text-sm font-semibold text-gray-800">${formatDate(milestone.dueDate)}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-amber-200 shadow-sm">
                <label class="block text-xs font-bold text-amber-600 uppercase tracking-wide mb-2">Planned Budget</label>
                <div class="text-lg font-bold text-green-600">${formatCurrency(milestone.plannedBudget || milestone.budget)}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-amber-200 shadow-sm">
                <label class="block text-xs font-bold text-amber-600 uppercase tracking-wide mb-2">Weight</label>
                <div class="text-sm font-semibold text-gray-800">${milestone.weight || 'â€“'}%</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-amber-200 shadow-sm col-span-full">
                <label class="block text-xs font-bold text-amber-600 uppercase tracking-wide mb-2">Description</label>
                <div class="text-sm text-gray-700 bg-amber-50 rounded-lg p-3 border border-amber-100 leading-relaxed">
                  ${milestone.description || submission.additionalNotes || 'No description provided'}
                </div>
              </div>
            </div>
            </div>
          </div>

          <!-- Enhanced Action Buttons -->
          <div class="flex items-center justify-between pt-4 border-t-2 border-gray-100">
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-4 py-2 rounded-lg border">
                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
                <span class="font-semibold">Review Required</span>
              </div>
              <div class="text-xs text-gray-500">
                Submitted: ${submissionDate.toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button onclick="deleteSubmission('${submission.id}')" class="px-4 py-2.5 bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700 border-2 border-gray-200 rounded-xl hover:from-gray-100 hover:to-gray-200 hover:border-gray-300 transition-all duration-300 font-semibold shadow-sm hover:shadow-md">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  Delete
                </span>
              </button>
              <button onclick="rejectSubmission('${submission.id}')" class="px-5 py-2.5 bg-gradient-to-r from-red-50 to-rose-50 text-red-700 border-2 border-red-200 rounded-xl hover:from-red-100 hover:to-rose-100 hover:border-red-300 transition-all duration-300 font-semibold shadow-sm hover:shadow-md">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                  Reject
                </span>
              </button>
              <button onclick="openMilestoneSubmissionModal('${submission.id}')" class="px-6 py-2.5 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-xl hover:from-amber-600 hover:to-yellow-600 transition-all duration-300 font-bold shadow-lg hover:shadow-xl transform hover:scale-105">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Review & Approve
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Function to view photo evidence in a modal
  function viewPhotoEvidence(imageUrl) {
    if (!imageUrl) return;
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    };
    
    // Create modal content
    modal.innerHTML = `
      <div class="relative max-w-4xl max-h-full bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-amber-500 to-yellow-500 p-4 flex items-center justify-between">
          <h3 class="text-white font-bold text-lg">Photo Evidence</h3>
          <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-4">
          <img src="${imageUrl}" alt="Photo Evidence" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg object-contain">
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  // Delete submission function
  async function deleteSubmission(submissionId) {
    if (!confirm('Are you sure you want to delete this milestone submission? This action cannot be undone.')) {
      return;
    }
    
    try {
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      if (!token) {
        alert('Authentication required. Please log in again.');
        return;
      }
      
      console.log('ðŸ—‘ï¸ Deleting submission:', submissionId);
      
      const response = await fetch(`${API_URL}/milestones/milestone-submissions/${submissionId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (data.success) {
        // Remove the submission from the local array
        milestoneSubmissions = milestoneSubmissions.filter(submission => submission.id !== submissionId);
        
        // Re-render the submissions
        renderSubmissions();
        
        // Update count badge
        updateSubmissionCountBadge(milestoneSubmissions.length);
        
        // Show success notification
        if (window.showNotification) {
          window.showNotification('Milestone submission deleted successfully', 'success');
        } else {
          alert('Milestone submission deleted successfully');
        }
        
        console.log('âœ… Submission deleted successfully');
      } else {
        throw new Error(data.message || 'Failed to delete submission');
      }
      
    } catch (error) {
      console.error('âŒ Error deleting submission:', error);
      
      if (window.showNotification) {
        window.showNotification('Failed to delete submission. Please try again.', 'error');
      } else {
        alert('Failed to delete submission. Please try again.');
      }
    }
  }

  // Function to start photo slideshow for milestone cards
  function startPhotoSlideshow(submissionId) {
    const milestoneSection = document.getElementById(`milestone-section-${submissionId}`);
    if (!milestoneSection) return;
    
    const slides = milestoneSection.querySelectorAll('[data-slide]');
    if (slides.length <= 1) return; // No slideshow needed for single image
    
    let currentSlide = 0;
    
    const showSlide = (index) => {
      slides.forEach((slide, i) => {
        slide.style.opacity = i === index ? '1' : '0';
      });
    };
    
    const nextSlide = () => {
      currentSlide = (currentSlide + 1) % slides.length;
      showSlide(currentSlide);
    };
    
    // Start slideshow with 4-second intervals
    setInterval(nextSlide, 4000);
  }

  // Initialize slideshows after cards are rendered
  function initializePhotoSlideshows() {
    // Find all milestone sections with photo evidence
    document.querySelectorAll('[id^="milestone-section-"]').forEach(section => {
      const submissionId = section.id.replace('milestone-section-', '');
      startPhotoSlideshow(submissionId);
    });
  }

  function updateSubmissionCount() {
    // Count filtered submissions based on current filter
    let count = 0;
    if (currentSubmissionFilter === 'all') {
      count = milestoneSubmissions.length;
    } else {
      count = milestoneSubmissions.filter(submission => 
        submission.status === currentSubmissionFilter
      ).length;
    }
    
    const countElement = document.querySelector('#submissionCount span:first-child');
    const textElement = document.querySelector('#submissionCount span:last-child');
    
    if (countElement && textElement) {
      countElement.textContent = count;
      textElement.textContent = `Submission${count !== 1 ? 's' : ''}`;
    }
    
    // Also update the badge
    updateSubmissionCountBadge(count);
  }

  function filterSubmissions(status) {
    console.log('ðŸŽ¨ Filtering submissions by status:', status);
    currentSubmissionFilter = status;
    
    // Reset all submission tab buttons to inactive state
    document.querySelectorAll('.submission-tab-button').forEach(btn => {
      btn.className = 'submission-tab-button inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap';
    });
    
    // Find and activate the clicked button
    const activeButton = document.querySelector(`#${getTabId(status)}`);
    
    if (activeButton) {
      // Add active class to make it use the active styling from CSS
      activeButton.className = 'submission-tab-button active inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg transition-all duration-300 whitespace-nowrap';
      console.log('âœ… Filter button activated:', status);
    }
    
    renderSubmissions();
    updateSubmissionCount();
  }

  // Helper function to get tab ID from status
  function getTabId(status) {
    const statusToId = {
      'all': 'allSubmissionsTab',
      'pending_review': 'pendingReviewTab',
      'approved': 'approvedTab',
      'needs_revision': 'needsRevisionTab',
      'under_review': 'underReviewTab',
      'validated': 'validatedTab'
    };
    return statusToId[status] || 'allSubmissionsTab';
  }

  function refreshSubmissions() {
    loadMilestoneSubmissions();
  }

  // Modal functions for MilestoneSubmissionModal
  async function openMilestoneSubmissionModal(submissionId) {
    console.log('ðŸ” Opening milestone submission modal for ID:', submissionId);
    console.log('ðŸŒ API_URL:', API_URL);
    console.log('ðŸ”— Full URL:', `${API_URL}/milestones/milestone-submissions/${submissionId}`);
    
    try {
      // Fetch detailed submission data from API
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      console.log('ðŸ”‘ Token:', token ? 'Present' : 'Missing');
      
      const response = await fetch(`${API_URL}/milestones/milestone-submissions/${submissionId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      console.log('ðŸ“¡ Response status:', response.status);
      console.log('ðŸ“¡ Response ok:', response.ok);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ Response error:', errorText);
        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
      }

      const data = await response.json();
      console.log('ðŸ“‹ Raw response data:', data);
      
      if (!data.success || !data.submission) {
        throw new Error('Failed to fetch submission details - Invalid response format');
      }

      console.log('ðŸ“‹ Submission data received:', data.submission);
      console.log('ðŸ–¼ï¸ Photo Evidence structure:', data.submission.photoEvidence);
      console.log('ðŸŽ¥ Video Evidence structure:', data.submission.videoEvidence);
      console.log('ðŸ“„ Document Files structure:', data.submission.documentFiles);
      
      // Log each individual evidence item for detailed debugging
      if (data.submission.photoEvidence) {
        data.submission.photoEvidence.forEach((photo, i) => {
          console.log(`ðŸ“¸ Photo ${i}:`, photo, 'Type:', typeof photo);
        });
      }
      if (data.submission.videoEvidence) {
        data.submission.videoEvidence.forEach((video, i) => {
          console.log(`ðŸŽ¬ Video ${i}:`, video, 'Type:', typeof video);
        });
      }

      // If evidence arrays are empty or have issues, try to get fallback data
      if ((!data.submission.photoEvidence || data.submission.photoEvidence.length === 0) ||
          (!data.submission.videoEvidence || data.submission.videoEvidence.length === 0) ||
          // Also check if we have incomplete file URLs
          (data.submission.photoEvidence && data.submission.photoEvidence.some(p => {
            const url = p.url || p.src || p;
            return typeof url === 'string' && url.includes('file-') && !url.includes('.');
          })) ||
          (data.submission.videoEvidence && data.submission.videoEvidence.some(v => {
            const url = v.url || v.src || v;
            return typeof url === 'string' && url.includes('file-') && !url.includes('.');
          }))) {
        try {
          console.log('ðŸ”„ Attempting to get fallback evidence data due to incomplete URLs...');
          const fallbackResponse = await fetch(`${API_URL}/milestones/test-files`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (fallbackResponse.ok) {
            const fallbackData = await fallbackResponse.json();
            console.log('ðŸ”„ Fallback data received:', fallbackData);
            
            // Use fallback data if original data is missing or has incomplete URLs
            if (!data.submission.photoEvidence || data.submission.photoEvidence.length === 0 ||
                data.submission.photoEvidence.some(p => {
                  const url = p.url || p.src || p;
                  return typeof url === 'string' && url.includes('file-') && !url.includes('.');
                })) {
              data.submission.photoEvidence = fallbackData.fallbacks?.images || [];
              console.log('ðŸ”„ Using fallback photo evidence:', data.submission.photoEvidence);
            }
            if (!data.submission.videoEvidence || data.submission.videoEvidence.length === 0 ||
                data.submission.videoEvidence.some(v => {
                  const url = v.url || v.src || v;
                  return typeof url === 'string' && url.includes('file-') && !url.includes('.');
                })) {
              data.submission.videoEvidence = fallbackData.fallbacks?.videos || [];
              console.log('ðŸ”„ Using fallback video evidence:', data.submission.videoEvidence);
            }
          }
        } catch (fallbackError) {
          console.warn('âš ï¸ Could not get fallback data:', fallbackError);
        }
      }

      const modal = document.getElementById('milestoneSubmissionModal');
      if (!modal) {
        console.error('MilestoneSubmissionModal not found');
        return;
      }

      // Populate modal with submission data
      populateMilestoneSubmissionModal(data.submission);
      
      // Ensure download buttons are clickable after modal is populated
      setTimeout(() => {
        const downloadButtons = document.querySelectorAll('[id^="download-btn-"]');
        downloadButtons.forEach((btn, index) => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const docFiles = data.submission.documentFiles || [];
            const url = docFiles[index]?.url || docFiles[index]?.src;
            if (url) {
              console.log('ðŸ“„ Download button clicked, opening:', url);
              window.open(url, '_blank');
            }
          });
        });
        console.log('âœ… Download buttons initialized:', downloadButtons.length);
      }, 100);
      
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
    } catch (error) {
      console.error('âŒ Error opening submission modal:', error);
      console.error('âŒ Error stack:', error.stack);
      alert(`Failed to load submission details: ${error.message}`);
    }
  }

  function closeMilestoneSubmissionModal() {
    const modal = document.getElementById('milestoneSubmissionModal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
  }

  function populateMilestoneSubmissionModal(submission) {
    console.log('ðŸ” Populating comprehensive milestone submission modal:', submission);
    console.log('ðŸ“Š Submission data structure:', JSON.stringify(submission, null, 2));
    
    // Populate General Information
    const generalInfo = document.getElementById('generalInfo');
    if (generalInfo) {
      generalInfo.innerHTML = `
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Project Name</label>
          </div>
          <p class="font-bold text-gray-800 text-lg">${submission.project?.name || submission.project?.projectName || 'N/A'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Project Code</label>
          </div>
          <p class="font-bold text-gray-800 text-lg">${submission.project?.projectCode || 'N/A'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Total Budget Allocation</label>
          </div>
          <p class="font-bold text-green-600 text-xl">â‚±${formatCurrency(submission.project?.totalBudget || 0)}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Start Date</label>
          </div>
          <p class="font-bold text-gray-800">${formatDate(submission.project?.startDate) || 'N/A'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Target Completion Date</label>
          </div>
          <p class="font-bold text-gray-800">${formatDate(submission.project?.targetCompletionDate || submission.project?.targetDateOfCompletion || submission.project?.endDate) || 'N/A'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Actual Completion Date</label>
          </div>
          <p class="font-bold text-gray-800">${formatDate(submission.project?.completionDate || submission.project?.actualCompletionDate) || 'â€“'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Expected Days</label>
          </div>
          <p class="font-bold text-gray-800">${submission.project?.expectedDaysOfCompletion ? submission.project.expectedDaysOfCompletion + ' days' : 'â€“'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <label class="text-sm font-semibold text-gray-700">Current Overall Progress</label>
          </div>
          <div class="flex items-center gap-2">
            <p class="font-bold text-blue-600 text-xl">${submission.project?.overallProgress || 0}%</p>
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div class="bg-blue-500 h-2 rounded-full" style="width: ${submission.project?.overallProgress || 0}%"></div>
            </div>
          </div>
        </div>
      `;
    }

    // Populate Milestone Information
    const milestoneInfo = document.getElementById('milestoneInfo');
    if (milestoneInfo) {
      milestoneInfo.innerHTML = `
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <label class="text-sm font-semibold text-gray-700 mb-1 block">Milestone Name (Item of Work)</label>
          <p class="font-bold text-gray-800 text-lg line-clamp-2">${submission.milestone?.title || submission.milestone?.name || 'N/A'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <label class="text-sm font-semibold text-gray-700 mb-1 block">Planned Budget</label>
          <p class="font-bold text-green-600 text-xl">â‚±${formatCurrency(submission.milestone?.plannedBudget || submission.plannedBudget || 0)}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <label class="text-sm font-semibold text-gray-700 mb-1 block">Weight</label>
          <p class="font-bold text-purple-600 text-xl">${submission.milestone?.weight || 0}%</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300">
          <label class="text-sm font-semibold text-gray-700 mb-1 block">Due Date</label>
          <p class="font-bold text-gray-800">${formatDate(submission.milestone?.dueDate) || 'N/A'}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-lg transition-shadow duration-300 md:col-span-2 lg:col-span-4">
          <label class="text-sm font-semibold text-gray-700 mb-1 block">Description</label>
          <p class="font-medium text-gray-800 line-clamp-3">${submission.milestone?.description || 'No description provided'}</p>
        </div>
      `;
    }

    // Calculate correct division weights based on milestone weight
    const milestoneWeight = parseFloat(submission.milestone?.weight || 0);
    const timelineWeight = parseFloat(submission.milestone?.timelineWeight || 0);
    const budgetWeight = parseFloat(submission.milestone?.budgetWeight || 0);
    const physicalWeight = parseFloat(submission.milestone?.physicalWeight || 0);
    
    // If individual weights are not set, calculate based on milestone weight
    const calculatedTimelineWeight = timelineWeight || (milestoneWeight * 0.333);
    const calculatedBudgetWeight = budgetWeight || (milestoneWeight * 0.333);
    const calculatedPhysicalWeight = physicalWeight || (milestoneWeight * 0.334);

    // Populate Division Weight Information
    const divisionWeightInfo = document.getElementById('divisionWeightInfo');
    if (divisionWeightInfo) {
      divisionWeightInfo.innerHTML = `
        <div class="info-card bg-gradient-to-br from-purple-50 to-indigo-50 p-4 rounded-xl border border-purple-200">
          <label class="text-sm font-semibold text-purple-700 mb-1 block">Timeline Division</label>
          <p class="font-bold text-purple-600 text-xl">${calculatedTimelineWeight.toFixed(2)}%</p>
        </div>
        <div class="info-card bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-200">
          <label class="text-sm font-semibold text-green-700 mb-1 block">Budget Division</label>
          <p class="font-bold text-green-600 text-xl">${calculatedBudgetWeight.toFixed(2)}%</p>
        </div>
        <div class="info-card bg-gradient-to-br from-orange-50 to-red-50 p-4 rounded-xl border border-orange-200">
          <label class="text-sm font-semibold text-orange-700 mb-1 block">Physical Division</label>
          <p class="font-bold text-orange-600 text-xl">${calculatedPhysicalWeight.toFixed(2)}%</p>
        </div>
      `;
    }

    // Populate Timeline Information
    const timelineInfo = document.getElementById('timelineInfo');
    if (timelineInfo) {
      // Parse timeline activities from submission data
      let timelineActivities = [];
      try {
        if (submission.timelineActivitiesDeliverables) {
          // Try to parse as JSON first, then as plain text
          try {
            timelineActivities = JSON.parse(submission.timelineActivitiesDeliverables);
          } catch {
            // If not JSON, treat as plain text and create a single activity
            timelineActivities = [{
              title: 'Timeline Activities',
              description: submission.timelineActivitiesDeliverables,
              status: 'Submitted'
            }];
          }
        }
      } catch (error) {
        console.log('Error parsing timeline activities:', error);
      }

      const activitiesHtml = timelineActivities.length > 0 ? timelineActivities.map(activity => `
        <div class="bg-white/60 p-3 rounded-lg border border-purple-100 mb-2">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h5 class="font-semibold text-purple-800">${activity.title || activity.name || 'Activity'}</h5>
                ${activity.date ? `<span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full font-medium">${formatDate(activity.date)}</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mt-1">${activity.description || 'No description'}</p>
            </div>
            <div class="text-right ml-4">
              <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">${activity.status || 'Submitted'}</span>
            </div>
          </div>
        </div>
      `).join('') : '<p class="text-gray-500 italic">No timeline activities provided</p>';

      timelineInfo.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="info-card bg-white/60 p-4 rounded-xl border border-purple-100">
            <label class="text-sm font-semibold text-purple-700 mb-1 block">Start Date</label>
            <p class="font-bold text-gray-800">${formatDate(submission.timelineStartDate || submission.milestone?.timelineStartDate) || 'N/A'}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-purple-100">
            <label class="text-sm font-semibold text-purple-700 mb-1 block">Target Completion Date</label>
            <p class="font-bold text-gray-800">${formatDate(submission.timelineEndDate || submission.milestone?.timelineEndDate) || 'N/A'}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-purple-100">
            <label class="text-sm font-semibold text-purple-700 mb-1 block">Submission Date</label>
            <p class="font-bold text-purple-600">${formatDateTime(submission.submittedAt || submission.submissionDate || submission.createdAt) || 'N/A'}</p>
          </div>
        </div>
        <div class="bg-white/60 p-4 rounded-xl border border-purple-100">
          <label class="text-sm font-semibold text-purple-700 mb-3 block">Timeline Activities & Deliverables</label>
          <div class="max-h-48 overflow-y-auto">
            ${activitiesHtml}
          </div>
        </div>
      `;
    }

    // Populate Budget Information
    const budgetInfo = document.getElementById('budgetInfo');
    if (budgetInfo) {
      const plannedBudget = parseFloat(submission.milestone?.plannedBudget || submission.plannedBudget || 0);
      
      // Debug the usedBudget parsing
      console.log('ðŸ’° Budget debugging in modal:', {
        'submission.usedBudget': submission.usedBudget,
        'typeof submission.usedBudget': typeof submission.usedBudget,
        'parseFloat(submission.usedBudget)': parseFloat(submission.usedBudget),
        'submission object keys': Object.keys(submission)
      });
      
      // More robust parsing for usedBudget (handle string decimals from database)
      let usedBudget = 0;
      if (submission.usedBudget !== null && submission.usedBudget !== undefined) {
        if (typeof submission.usedBudget === 'string') {
          usedBudget = parseFloat(submission.usedBudget.replace(/[^\d.-]/g, '')) || 0;
        } else {
          usedBudget = parseFloat(submission.usedBudget) || 0;
        }
      }
      
      const remainingBudget = plannedBudget - usedBudget;
      
      // Calculate raw budget utilization percentage
      const rawBudgetUtilization = plannedBudget > 0 ? (usedBudget / plannedBudget) * 100 : 0;
      
      // Calculate Division Utilized properly - normalized against Division Weight
      // Division Utilized = (Raw Budget Utilization) * (Budget Division Weight / 100)
      const divisionUtilized = (rawBudgetUtilization * (calculatedBudgetWeight / 100)).toFixed(2);
      
      // Calculate Milestone Utilized - raw budget utilization applied to milestone weight
      const milestoneUtilized = (rawBudgetUtilization * (milestoneWeight / 100)).toFixed(2);

      console.log('ðŸ’° Budget calculations:', {
        plannedBudget,
        usedBudget,
        remainingBudget,
        rawBudgetUtilization: rawBudgetUtilization.toFixed(2),
        calculatedBudgetWeight,
        divisionUtilized,
        milestoneWeight,
        milestoneUtilized
      });

      // Format funding source properly (same as submit-update.astro)
      let fundingSource = 'LOCAL FUND'; // Default value
      if (submission.fundingSource) {
        if (submission.fundingSource === 'donor_fund') {
          fundingSource = 'MUNICIPAL DEVELOPMENT FUND';
        } else {
          fundingSource = submission.fundingSource.replace(/_/g, ' ').toUpperCase();
        }
      } else if (submission.project?.fundingSource) {
        if (submission.project.fundingSource === 'donor_fund') {
          fundingSource = 'MUNICIPAL DEVELOPMENT FUND';
        } else {
          fundingSource = submission.project.fundingSource.replace(/_/g, ' ').toUpperCase();
        }
      }

      budgetInfo.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div class="info-card bg-white/60 p-4 rounded-xl border border-green-100">
            <label class="text-sm font-semibold text-green-700 mb-1 block">Planned Budget</label>
            <p class="font-bold text-green-600 text-xl">â‚±${formatCurrency(plannedBudget)}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-green-100">
            <label class="text-sm font-semibold text-green-700 mb-1 block">Funding Source</label>
            <p class="font-bold text-gray-800">${fundingSource}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-green-100">
            <label class="text-sm font-semibold text-green-700 mb-1 block">Used Budget</label>
            <p class="font-bold text-blue-600 text-xl">â‚±${formatCurrency(usedBudget)}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-green-100">
            <label class="text-sm font-semibold text-green-700 mb-1 block">Remaining Budget</label>
            <p class="font-bold text-orange-600 text-xl">â‚±${formatCurrency(remainingBudget)}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-green-100 relative division-utilized-card">
            <label class="text-sm font-semibold text-green-700 mb-2 block flex items-center gap-2">
              Division Utilized
              <div class="relative group">
                <svg class="w-4 h-4 text-gray-400 hover:text-gray-600 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-50">
                  <div class="bg-gray-800 text-white text-xs rounded-lg p-3 whitespace-nowrap shadow-lg">
                    <div class="text-center mb-1 font-semibold">Division Utilized Calculation</div>
                    <div>â‚±${formatCurrency(usedBudget)} used Ã· â‚±${formatCurrency(plannedBudget)} total = ${rawBudgetUtilization.toFixed(2)}%</div>
                    <div>Adjusted to Budget Division Weight ${calculatedBudgetWeight.toFixed(2)}% â†’ ${divisionUtilized}%</div>
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                  </div>
                </div>
              </div>
            </label>
            <div class="mb-3">
              <div class="flex items-center justify-between mb-1">
            <p class="font-bold text-purple-600 text-xl">${divisionUtilized}%</p>
                <span class="text-xs text-gray-500">${calculatedBudgetWeight.toFixed(1)}% capacity</span>
          </div>
              <!-- Enhanced Progress Bar with Dynamic Color -->
              <div class="relative">
                <div class="w-full bg-gray-200 rounded-full h-3 mb-2 overflow-hidden relative">
                  <div class="division-progress-bar h-3 rounded-full transition-all duration-2000 ease-out relative overflow-hidden" 
                       style="width: 0%;"
                       data-target-width="${Math.min(parseFloat(divisionUtilized) / calculatedBudgetWeight * 100, 100)}"
                       data-division-percent="${divisionUtilized}"
                       data-completion-percent="${Math.min(parseFloat(divisionUtilized) / calculatedBudgetWeight * 100, 100)}">
                    <!-- Glow effect overlay -->
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse-glow" style="transform: translateX(-100%);"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center text-xs text-gray-500">
                  <span>${rawBudgetUtilization.toFixed(1)}% raw</span>
                  <span class="text-center flex-1">
                    ${parseFloat(divisionUtilized) >= calculatedBudgetWeight ? 'âœ… Division Complete' : `${(calculatedBudgetWeight - parseFloat(divisionUtilized)).toFixed(2)}% remaining`}
                  </span>
                  <span>of ${calculatedBudgetWeight.toFixed(1)}%</span>
                </div>
              </div>
            </div>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-green-100 relative milestone-utilized-card">
            <label class="text-sm font-semibold text-green-700 mb-2 block flex items-center gap-2">
              Milestone Utilized
              <div class="relative group">
                <svg class="w-4 h-4 text-gray-400 hover:text-gray-600 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-50">
                  <div class="bg-gray-800 text-white text-xs rounded-lg p-3 whitespace-nowrap shadow-lg">
                    <div class="text-center mb-1 font-semibold">Milestone Utilized Calculation</div>
                    <div>â‚±${formatCurrency(usedBudget)} used Ã· â‚±${formatCurrency(plannedBudget)} total = ${rawBudgetUtilization.toFixed(2)}%</div>
                    <div>Applied to Milestone Weight ${milestoneWeight.toFixed(2)}% â†’ ${milestoneUtilized}%</div>
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                  </div>
                </div>
              </div>
            </label>
            <div class="mb-3">
              <div class="flex items-center justify-between mb-1">
            <p class="font-bold text-indigo-600 text-xl">${milestoneUtilized}%</p>
                <span class="text-xs text-gray-500">${milestoneWeight.toFixed(1)}% capacity</span>
              </div>
              <!-- Enhanced Progress Bar with Dynamic Color -->
              <div class="relative">
                <div class="w-full bg-gray-200 rounded-full h-3 mb-2 overflow-hidden relative">
                  <div class="milestone-progress-bar h-3 rounded-full transition-all duration-2000 ease-out relative overflow-hidden" 
                       style="width: 0%;"
                       data-target-width="${Math.min(parseFloat(milestoneUtilized) / milestoneWeight * 100, 100)}"
                       data-milestone-percent="${milestoneUtilized}"
                       data-completion-percent="${Math.min(parseFloat(milestoneUtilized) / milestoneWeight * 100, 100)}">
                    <!-- Glow effect overlay -->
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse-glow" style="transform: translateX(-100%);"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center text-xs text-gray-500">
                  <span>${rawBudgetUtilization.toFixed(1)}% raw</span>
                  <span class="text-center flex-1">
                    ${parseFloat(milestoneUtilized) >= milestoneWeight ? 'ðŸŽ¯ Milestone Complete' : `${(milestoneWeight - parseFloat(milestoneUtilized)).toFixed(2)}% remaining`}
                  </span>
                  <span>of ${milestoneWeight.toFixed(1)}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-white/60 p-4 rounded-xl border border-green-100">
          <label class="text-sm font-semibold text-green-700 mb-3 block">Budget Breakdown & Allocation</label>
          <div class="bg-gray-50 p-3 rounded-lg">
            <p class="text-gray-700 whitespace-pre-wrap">${submission.budgetBreakdownAllocation || 'No budget breakdown provided'}</p>
          </div>
        </div>
      `;
    }

    // Populate Physical Information
    const physicalInfo = document.getElementById('physicalInfo');
    if (physicalInfo) {
      // Evidence files are already JSON objects from the database
      const photoEvidence = submission.photoEvidence || [];
      const videoEvidence = submission.videoEvidence || [];
      const documentFiles = submission.documentFiles || [];

      console.log('ðŸ–¼ï¸ Photo Evidence:', photoEvidence);
      console.log('ðŸŽ¥ Video Evidence:', videoEvidence);
      console.log('ðŸ“„ Document Files:', documentFiles);

      physicalInfo.innerHTML = `
        <div class="space-y-4">
          <div class="bg-white/60 p-4 rounded-xl border border-orange-100">
            <label class="text-sm font-semibold text-orange-700 mb-3 block">Required Proofs</label>
            
            <!-- Photo Evidence -->
            <div class="mb-4">
              <h5 class="font-semibold text-orange-800 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Photo Evidence (${Array.isArray(photoEvidence) ? photoEvidence.length : 0} files)
              </h5>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                ${Array.isArray(photoEvidence) && photoEvidence.length > 0 ? photoEvidence.map((photo, index) => {
                  // Handle different possible data structures
                  let photoUrl = '';
                  let photoName = '';
                  
                  // If photo is an object with url/src properties
                  if (typeof photo === 'object' && photo !== null) {
                    photoUrl = photo.url || photo.src || photo.path || photo.filePath || photo.fileName || '';
                    photoName = photo.name || photo.originalName || photo.fileName || `Photo ${index + 1}`;
                  } else if (typeof photo === 'string') {
                    // If photo is just a string (filename)
                    photoUrl = photo;
                    photoName = photo.split('/').pop() || `Photo ${index + 1}`;
                  }
                  
                  // Ensure URL is properly formatted
                  if (photoUrl && !photoUrl.startsWith('http')) {
                    // If it's just a filename, construct the full URL
                    if (!photoUrl.includes('/')) {
                      photoUrl = `http://localhost:3000/uploads/${photoUrl}`;
                    } else {
                      // If it's a relative path, make it absolute
                      photoUrl = `http://localhost:3000/${photoUrl}`;
                    }
                  }
                  
                  // Validate that we have a complete URL
                  if (!photoUrl || photoUrl === 'http://localhost:3000/uploads/' || photoUrl.endsWith('file-')) {
                    console.warn('âš ï¸ Incomplete photo URL detected:', photoUrl, 'for photo:', photo);
                    return `
                      <div class="w-full h-20 bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center">
                        <svg class="w-6 h-6 text-red-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-red-500 text-xs text-center">Invalid URL</span>
                        <span class="text-gray-400 text-xs">${photoName}</span>
                      </div>
                    `;
                  }
                  
                  console.log('ðŸ–¼ï¸ Final photo URL:', photoUrl, 'Name:', photoName);
                  console.log('ðŸ–¼ï¸ Rendering photo:', { photoUrl, photoName, photo, originalPhoto: photo });
                  return `
                    <div class="relative group cursor-pointer" onclick="previewPhoto('${photoUrl}', '${photoName}')">
                      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjOTlBM0FFIi8+Cjwvc3ZnPgo=" alt="${photoName}" 
                           class="w-full h-20 object-cover rounded-lg border border-orange-200 group-hover:opacity-75 transition-opacity"
                           data-photo-url="${photoUrl}" data-photo-name="${photoName}">
                      <div class="w-full h-20 bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center" style="display: none;">
                        <svg class="w-6 h-6 text-red-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-red-500 text-xs text-center">Image not found</span>
                        <span class="text-gray-400 text-xs">${photoName}</span>
                      </div>
                      <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-lg flex items-center justify-center transition-all">
                        <svg class="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                      </div>
                      <div class="absolute bottom-1 left-1 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-xs">
                        ${photoName}
                      </div>
                      <div class="absolute top-1 right-1 bg-orange-500 text-white px-2 py-1 rounded text-xs opacity-75">
                        Loading...
                      </div>
                    </div>
                  `;
                }).join('') : '<p class="text-gray-500 italic text-sm">No photo evidence provided</p>'}
              </div>
            </div>

            <!-- Video Evidence -->
            <div class="mb-4">
              <h5 class="font-semibold text-orange-800 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Video Evidence (${Array.isArray(videoEvidence) ? videoEvidence.length : 0} files)
              </h5>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                ${Array.isArray(videoEvidence) && videoEvidence.length > 0 ? videoEvidence.map((video, index) => {
                  // Handle different possible data structures
                  let videoUrl = '';
                  let videoName = '';
                  
                  // If video is an object with url/src properties
                  if (typeof video === 'object' && video !== null) {
                    videoUrl = video.url || video.src || video.path || video.filePath || video.fileName || '';
                    videoName = video.name || video.originalName || video.fileName || `Video ${index + 1}`;
                  } else if (typeof video === 'string') {
                    // If video is just a string (filename)
                    videoUrl = video;
                    videoName = video.split('/').pop() || `Video ${index + 1}`;
                  }
                  
                  // Ensure URL is properly formatted
                  if (videoUrl && !videoUrl.startsWith('http')) {
                    // If it's just a filename, construct the full URL
                    if (!videoUrl.includes('/')) {
                    videoUrl = `http://localhost:3000/uploads/${videoUrl}`;
                    } else {
                      // If it's a relative path, make it absolute
                      videoUrl = `http://localhost:3000/${videoUrl}`;
                    }
                  }
                  
                  // Validate that we have a complete URL
                  if (!videoUrl || videoUrl === 'http://localhost:3000/uploads/' || videoUrl.endsWith('file-')) {
                    console.warn('âš ï¸ Incomplete video URL detected:', videoUrl, 'for video:', video);
                    return `
                      <div class="w-full h-24 bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center">
                        <svg class="w-6 h-6 text-red-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-red-500 text-xs text-center">Invalid URL</span>
                        <span class="text-gray-400 text-xs">${videoName}</span>
                      </div>
                    `;
                  }
                  
                  console.log('ðŸŽ¥ Final video URL:', videoUrl, 'Name:', videoName);
                  console.log('ðŸŽ¥ Rendering video:', { videoUrl, videoName, video, originalVideo: video });
                  const videoId = `video-${index}-${Date.now()}`;
                  return `
                    <div class="relative group bg-gray-100 rounded-lg border border-orange-200 overflow-hidden hover:bg-gray-200 transition-colors cursor-pointer" onclick="previewVideo('${videoUrl}', '${videoName}')">
                      <div class="w-full h-24 relative bg-gray-800">
                        <video id="${videoId}" class="w-full h-full object-cover" muted preload="metadata" crossorigin="anonymous" onloadedmetadata="this.currentTime=1" data-video-url="${videoUrl}" data-video-name="${videoName}">
                          <source type="video/mp4">
                          <source type="video/webm">
                          <source type="video/mov">
                        </video>
                        <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                          <svg class="w-8 h-8 text-white drop-shadow-lg" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                          </svg>
                        </div>
                        <div class="video-error-fallback w-full h-24 bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center absolute inset-0" style="display: none;">
                          <svg class="w-6 h-6 text-red-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          <span class="text-red-500 text-xs text-center">Video not found</span>
                          <span class="text-gray-400 text-xs">${videoName}</span>
                        </div>
                        <div class="absolute top-1 right-1 bg-orange-500 text-white px-2 py-1 rounded text-xs opacity-75">
                          Loading...
                        </div>
                      </div>
                      <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 flex items-center justify-center transition-all">
                        <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity z-20 drop-shadow-lg" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M8 5v14l11-7z"/>
                        </svg>
                      </div>
                      <div class="absolute bottom-1 left-1 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-xs z-10">
                        ${videoName}
                      </div>
                    </div>
                  `;
                }).join('') : '<p class="text-gray-500 italic text-sm">No video evidence provided</p>'}
              </div>
            </div>

            <!-- Document Files -->
            <div class="mb-4">
              <h5 class="font-semibold text-orange-800 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Excel/Document Files (${Array.isArray(documentFiles) ? documentFiles.length : 0} files)
              </h5>
              <div class="space-y-2">
                ${Array.isArray(documentFiles) && documentFiles.length > 0 ? documentFiles.map((doc, index) => {
                  let docUrl = '';
                  let docName = '';
                  let docSize = 0;
                  
                  // Handle different possible data structures
                  if (typeof doc === 'object' && doc !== null) {
                    docUrl = doc.url || doc.src || doc.path || doc.filePath || doc.fileName || '';
                    docName = doc.name || doc.originalName || doc.fileName || `Document ${index + 1}`;
                    docSize = doc.size || 0;
                  } else if (typeof doc === 'string') {
                    docUrl = doc;
                    docName = doc.split('/').pop() || `Document ${index + 1}`;
                  }
                  
                  // Ensure URL is properly formatted
                  if (docUrl && !docUrl.startsWith('http')) {
                    if (!docUrl.includes('/')) {
                    docUrl = `http://localhost:3000/uploads/${docUrl}`;
                    } else {
                      docUrl = `http://localhost:3000/${docUrl}`;
                    }
                  }
                  
                  const fileExtension = docName.split('.').pop()?.toLowerCase() || 'file';
                  
                  console.log('ðŸ“„ Final document URL:', docUrl, 'Name:', docName);
                  console.log('ðŸ“„ Rendering document:', { docUrl, docName, docSize, fileExtension, doc });
                  
                  // Get appropriate icon based on file type
                  let iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>`;
                  let iconColor = 'text-orange-600';
                  
                  if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    iconColor = 'text-green-600';
                    iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>`;
                  } else if (fileExtension === 'pdf') {
                    iconColor = 'text-red-600';
                    iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>`;
                  } else if (fileExtension === 'docx' || fileExtension === 'doc') {
                    iconColor = 'text-blue-600';
                    iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>`;
                  }
                  
                  return `
                    <div class="flex items-center gap-3 bg-white p-3 rounded-lg border border-orange-100 hover:border-orange-200 transition-colors">
                      <svg class="w-5 h-5 ${iconColor} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${iconSvg}
                      </svg>
                      <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-800 truncate">${docName}</p>
                        <p class="text-xs text-gray-500">${docSize ? formatFileSize(docSize) : 'Unknown size'} â€¢ ${fileExtension.toUpperCase()}</p>
                      </div>
                      <button 
                         id="download-btn-${index}"
                         onclick="event.stopPropagation(); window.open('${docUrl}', '_blank'); console.log('ðŸ“„ Opening file:', '${docUrl}');"
                         class="px-4 py-2 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors text-sm font-medium flex items-center gap-2 flex-shrink-0 cursor-pointer border-none outline-none"
                         style="pointer-events: auto; z-index: 10; position: relative;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download
                      </button>
                    </div>
                  `;
                }).join('') : '<p class="text-gray-500 italic text-sm">No document files provided</p>'}
              </div>
            </div>
          </div>

          <div class="bg-white/60 p-4 rounded-xl border border-orange-100">
            <label class="text-sm font-semibold text-orange-700 mb-2 block">Physical Progress Description</label>
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-gray-700 whitespace-pre-wrap">${submission.physicalProgressDescription || 'No physical progress description provided'}</p>
            </div>
          </div>

          <div class="bg-white/60 p-4 rounded-xl border border-orange-100">
            <label class="text-sm font-semibold text-orange-700 mb-2 block">Additional Notes</label>
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-gray-700 whitespace-pre-wrap">${submission.additionalNotes || 'No additional notes provided'}</p>
            </div>
          </div>
        </div>
      `;
    }

    // Populate Submitted By Information
    const submitterInfo = document.getElementById('submitterInfo');
    if (submitterInfo) {
      // Get submitter data - prioritize the submitter association (which has complete user data)
      let submitterData = {};
      
      // First priority: submitter association from database (has complete user data)
      if (submission.submitter) {
        submitterData = {
          fullName: submission.submitter.fullName || submission.submitter.name,
          subrole: submission.submitter.subRole || submission.submitter.role,
          contactNumber: submission.submitter.contactNumber,
          department: submission.submitter.department,
          company: submission.submitter.externalCompanyName || 'External Partner',
          profilePictureUrl: submission.submitter.profilePictureUrl
        };
      }
      
      // Second priority: submitterInfo JSON field (fallback)
      if (!submitterData.fullName && submission.submitterInfo) {
        submitterData = {
          ...submitterData,
          fullName: submission.submitterInfo.fullName,
          subrole: submission.submitterInfo.subrole,
          contactNumber: submission.submitterInfo.contactNumber,
          department: submission.submitterInfo.department,
          company: submission.submitterInfo.company || 'External Partner'
        };
      }
      
      console.log('ðŸ‘¤ Submitter data extracted:', submitterData);
      
      submitterInfo.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="info-card bg-white/60 p-4 rounded-xl border border-gray-100 md:col-span-3">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center relative">
                <img 
                  id="submitterProfilePicture" 
                  src="" 
                  alt="Profile Picture" 
                  class="w-full h-full object-cover hidden"
                />
                <div 
                  id="submitterProfilePlaceholder"
                  class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg"
                >
                  ${(submitterData.fullName || 'EIU').charAt(0).toUpperCase()}
                </div>
              </div>
              <div>
                <h5 class="font-bold text-lg text-gray-800">${submitterData.fullName || 'EIU User'}</h5>
                <p class="text-sm text-gray-600">${submitterData.subrole || 'External Implementing Unit'}</p>
                <p class="text-xs text-gray-500">${submitterData.department || 'EIU Department'}</p>
              </div>
            </div>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-gray-100">
            <label class="text-sm font-semibold text-gray-700 mb-1 block">Contact Number</label>
            <p class="font-bold text-gray-800">${submitterData.contactNumber || 'N/A'}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-gray-100">
            <label class="text-sm font-semibold text-gray-700 mb-1 block">Company</label>
            <p class="font-bold text-gray-800">${submitterData.company || 'External Partner'}</p>
          </div>
          <div class="info-card bg-white/60 p-4 rounded-xl border border-gray-100">
            <label class="text-sm font-semibold text-gray-700 mb-1 block">Submission Date</label>
            <p class="font-bold text-indigo-600">${formatDateTime(submission.submittedAt || submission.submissionDate || submission.createdAt) || 'N/A'}</p>
          </div>
        </div>
      `;

      // Enhanced Profile Picture Loading (same approach as ProjectDetailsModal)
      if (submitterData.profilePictureUrl) {
        console.log('ðŸ‘¤ Loading submitter profile picture:', submitterData.profilePictureUrl);
        
        const submitterProfileImg = document.getElementById('submitterProfilePicture');
        const submitterProfilePlaceholder = document.getElementById('submitterProfilePlaceholder');
        
        if (submitterProfileImg && submitterProfilePlaceholder) {
          const profileUrl = submitterData.profilePictureUrl;
          
          // Show placeholder initially to prevent blank state
          submitterProfileImg.classList.add('hidden');
          submitterProfilePlaceholder.classList.remove('hidden');
          
          if (profileUrl && profileUrl !== 'null' && profileUrl !== '' && profileUrl !== 'undefined') {
            // Process and normalize the profile picture URL
            let normalizedUrl = profileUrl;
            
            // Handle relative URLs by making them absolute
            if (profileUrl.startsWith('/') && !profileUrl.startsWith('//')) {
              normalizedUrl = window.location.origin + profileUrl;
              console.log('ðŸ”— Converted relative URL to absolute:', normalizedUrl);
            }
            
            // Handle URLs that might need the backend server origin
            if (profileUrl.startsWith('/uploads/') || profileUrl.startsWith('uploads/')) {
              const backendOrigin = 'http://localhost:3000'; // Backend server URL
              normalizedUrl = profileUrl.startsWith('/') ? 
                backendOrigin + profileUrl : 
                backendOrigin + '/' + profileUrl;
              console.log('ðŸ”— Using backend server URL:', normalizedUrl);
            }
            
            console.log('âœ… Attempting to load submitter profile picture:', {
              original: profileUrl,
              normalized: normalizedUrl
            });
            
            // Enhanced loading strategy with authentication headers
            const loadSubmitterProfilePicture = async () => {
              try {
                // First, try direct image loading (works for public URLs)
                const testImg = new Image();
                
                // Set up success handler
                testImg.onload = function() {
                  console.log('âœ… Submitter profile picture loaded successfully via direct loading');
                  submitterProfileImg.src = normalizedUrl;
                  submitterProfileImg.classList.remove('hidden');
                  submitterProfilePlaceholder.classList.add('hidden');
                };
                
                // Set up error handler for direct loading
                testImg.onerror = async function() {
                  console.log('âŒ Direct loading failed, trying authenticated fetch');
                  
                  try {
                    // Try fetching with authentication headers
                    const token = localStorage.getItem('token') || document.cookie.replace(/(?:(?:^|.*;\s*)token\s*\=\s*([^;]*).*$)|^.*$/, "$1");
                    
                    const response = await fetch(normalizedUrl, {
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                      }
                    });
                    
                    if (response.ok) {
                      const blob = await response.blob();
                      const objectUrl = URL.createObjectURL(blob);
                      
                      console.log('âœ… Submitter profile picture loaded via authenticated fetch');
                      submitterProfileImg.src = objectUrl;
                      submitterProfileImg.classList.remove('hidden');
                      submitterProfilePlaceholder.classList.add('hidden');
                      
                      // Clean up object URL after image loads
                      submitterProfileImg.onload = () => {
                        URL.revokeObjectURL(objectUrl);
                      };
                    } else {
                      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                  } catch (fetchError) {
                    console.log('âŒ Authenticated fetch also failed:', fetchError.message);
                    console.log('ðŸ“· Showing placeholder due to loading failures');
                    submitterProfileImg.classList.add('hidden');
                    submitterProfilePlaceholder.classList.remove('hidden');
                  }
                };
                
                // Start the loading process
                testImg.src = normalizedUrl;
                
              } catch (error) {
                console.log('âŒ Submitter profile picture loading error:', error);
                submitterProfileImg.classList.add('hidden');
                submitterProfilePlaceholder.classList.remove('hidden');
              }
            };
            
            // Execute the loading function
            loadSubmitterProfilePicture();
          }
        }
      }
    }

    // Populate Attached Files
    const attachedFiles = document.getElementById('attachedFiles');
    if (attachedFiles) {
      attachedFiles.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="info-card bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-200">
            <label class="text-sm font-semibold text-indigo-700 mb-2 block">Attached RPMES Form</label>
            <div class="text-gray-500 italic text-sm">Will be attached during approval process</div>
          </div>
          <div class="info-card bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-200">
            <label class="text-sm font-semibold text-indigo-700 mb-2 block">Attached Additional Document</label>
            <div class="text-gray-500 italic text-sm">Will be attached during approval process</div>
          </div>
        </div>
        <div class="info-card bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-200 mt-4">
          <label class="text-sm font-semibold text-indigo-700 mb-2 block">Additional Note</label>
          <div class="text-gray-500 italic text-sm">Will be added during approval process</div>
        </div>
      `;
    }

    // Set submission date and status in footer
    const submissionDateSpan = document.getElementById('submissionDate');
    if (submissionDateSpan) {
      submissionDateSpan.textContent = `Submitted: ${formatDateTime(submission.submittedAt || submission.submissionDate || submission.createdAt) || 'N/A'}`;
    }

    const submissionStatus = document.getElementById('submissionStatus');
    if (submissionStatus) {
      const status = submission.status || 'pending_review';
      const statusText = status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      submissionStatus.textContent = `Status: ${statusText}`;
    }

    // Store current submission ID for actions
    window.currentReviewSubmissionId = submission.id;
    
    // Initialize character counter for notes
    initializeNotesCharCounter();
    
    // Load all evidence images after modal is populated (same approach as profile pictures)
    setTimeout(async () => {
      // First, try to restore photos from sessionStorage
      const photoImages = document.querySelectorAll('#physicalInfo img[data-photo-url]');
      console.log('ðŸ–¼ï¸ Found', photoImages.length, 'photo evidence images...');
      
      // Check if we have cached data URLs for these photos
      let restoredCount = 0;
      photoImages.forEach(img => {
        const photoUrl = img.getAttribute('data-photo-url');
        const photoName = img.getAttribute('data-photo-name');
        
        // Try to find cached data URL in sessionStorage
        const cacheKeys = Object.keys(sessionStorage).filter(key => key.startsWith('modal-photo-'));
        for (const key of cacheKeys) {
          try {
            const cachedDataUrl = sessionStorage.getItem(key);
            if (cachedDataUrl && cachedDataUrl.startsWith('data:')) {
              // Use cached data URL
              img.setAttribute('data-original-src', cachedDataUrl);
              img.src = cachedDataUrl;
              img.setAttribute('data-photo-id', key.replace('modal-photo-', ''));
              
              const loadingIndicator = img.parentElement.querySelector('.absolute.top-1.right-1');
              if (loadingIndicator) loadingIndicator.style.display = 'none';
              
              console.log('ðŸ”„ Restored photo from cache:', photoName);
              restoredCount++;
              return; // Exit the loop for this image
            }
          } catch (e) {
            // Continue to next cache key
          }
        }
      });
      
      console.log(`ðŸ”„ Restored ${restoredCount} photos from cache, loading ${photoImages.length - restoredCount} fresh photos...`);
      
      // Load photo evidence (only those not restored from cache)
      console.log('ðŸ–¼ï¸ Loading photo evidence images...');
      
      for (const img of photoImages) {
        // Skip if already restored from cache
        if (img.getAttribute('data-original-src')) {
          continue;
        }
        
        const photoUrl = img.getAttribute('data-photo-url');
        const photoName = img.getAttribute('data-photo-name');
        const loadingIndicator = img.parentElement.querySelector('.absolute.top-1.right-1');
        
        try {
          const dataUrl = await convertToDataURL(photoUrl);
          
          // Store the data URL as the original source for protection
          img.setAttribute('data-original-src', dataUrl);
          img.src = dataUrl;
          
          // Store in sessionStorage for persistence (same approach as submit-update.astro)
          const photoId = `photo-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          try {
            sessionStorage.setItem(`modal-photo-${photoId}`, dataUrl);
            img.setAttribute('data-photo-id', photoId);
          } catch (e) {
            console.warn('Could not save photo data to sessionStorage:', e);
          }
          
          if (loadingIndicator) loadingIndicator.style.display = 'none';
          console.log('âœ… Photo loaded successfully with protection:', photoName);
        } catch (error) {
          console.error('âŒ Failed to load photo:', photoName, error);
          img.style.display = 'none';
          const errorDiv = img.nextElementSibling;
          if (errorDiv) errorDiv.style.display = 'block';
          if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
      }

      // Load video thumbnails
      const videoElements = document.querySelectorAll('#physicalInfo video[data-video-url]');
      console.log('ðŸŽ¥ Loading', videoElements.length, 'video evidence thumbnails...');
      
      for (const video of videoElements) {
        const videoUrl = video.getAttribute('data-video-url');
        const videoName = video.getAttribute('data-video-name');
        
        try {
          const dataUrl = await convertToDataURL(videoUrl);
          video.src = dataUrl;
          console.log('âœ… Video loaded successfully:', videoName);
        } catch (error) {
          console.error('âŒ Failed to load video:', videoName, error);
          video.style.display = 'none';
          const errorDiv = video.parentElement.querySelector('.video-error-fallback');
          if (errorDiv) errorDiv.style.display = 'block';
        }
      }
      
      // Add MutationObserver protection (same approach as submit-update.astro)
      if (!window.modalImageObserver) {
        window.modalImageObserver = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
              const img = mutation.target;
              const originalSrc = img.getAttribute('data-original-src');
              
              // If someone tries to change the src, revert it immediately
              if (originalSrc && img.src !== originalSrc && img.src !== '' && !img.src.startsWith('data:image/svg+xml')) {
                console.log(`ðŸ›¡ï¸ Modal: Blocked unauthorized image src change from "${img.src}" back to "${originalSrc}"`);
                img.src = originalSrc;
              }
            }
          });
        });
      }
      
      // Start observing all modal photo images
      const modalPhotoImages = document.querySelectorAll('#physicalInfo img[data-photo-url]');
      modalPhotoImages.forEach(img => {
        window.modalImageObserver.observe(img, {
          attributes: true,
          attributeFilter: ['src']
        });
      });
      
      console.log(`ðŸ›¡ï¸ Started MutationObserver protection for ${modalPhotoImages.length} modal photo images`);
    }, 100); // Small delay to ensure DOM is ready
    
    console.log('âœ… Comprehensive milestone submission modal populated successfully');
    
    // Add enhanced CSS animations for progress bars
    if (!document.getElementById('progress-bar-styles')) {
      const styleSheet = document.createElement('style');
      styleSheet.id = 'progress-bar-styles';
      styleSheet.textContent = `
        @keyframes pulse-glow {
          0% { transform: translateX(-100%); }
          50% { transform: translateX(100%); }
          100% { transform: translateX(300%); }
        }
        
        .animate-pulse-glow {
          animation: pulse-glow 3s ease-in-out infinite;
          animation-delay: 2s;
        }
        
        .division-progress-bar.animate,
        .milestone-progress-bar.animate {
          transition: width 2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .progress-complete .animate-pulse-glow {
          animation-duration: 2s;
        }
        
        /* Dynamic color classes */
        .progress-red { background-color: #ef4444; }
        .progress-yellow { background-color: #f59e0b; }
        .progress-blue { background-color: #3b82f6; }
        .progress-green { background-color: #10b981; }
      `;
      document.head.appendChild(styleSheet);
    }
    
    // Function to get progress bar color based on completion percentage
    function getProgressColor(completionPercent) {
      if (completionPercent <= 25) return 'progress-red';
      if (completionPercent <= 50) return 'progress-yellow';
      if (completionPercent <= 75) return 'progress-blue';
      return 'progress-green';
    }
    
    // Initialize scroll-triggered animations
    setTimeout(() => {
      const observerOptions = {
        threshold: 0.3,
        rootMargin: '0px 0px -10% 0px'
      };
      
      const progressObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const card = entry.target;
            
            // Animate Division Utilized
            if (card.classList.contains('division-utilized-card')) {
              const progressBar = card.querySelector('.division-progress-bar');
              if (progressBar) {
                const targetWidth = progressBar.getAttribute('data-target-width');
                const divisionPercent = progressBar.getAttribute('data-division-percent');
                const completionPercent = parseFloat(progressBar.getAttribute('data-completion-percent'));
                
                // Apply dynamic color based on completion percentage
                const colorClass = getProgressColor(completionPercent);
                progressBar.classList.add(colorClass);
                
                console.log(`ðŸŽ¨ Division progress: ${completionPercent.toFixed(1)}% completion â†’ ${colorClass}`);
                
                setTimeout(() => {
                  progressBar.style.width = targetWidth + '%';
                  progressBar.classList.add('animate');
                  
                  if (parseFloat(divisionPercent) >= 18.33) {
                    setTimeout(() => {
                      progressBar.classList.add('progress-complete');
                    }, 2000);
                  }
                }, 200);
              }
            }
            
            // Animate Milestone Utilized
            if (card.classList.contains('milestone-utilized-card')) {
              const progressBar = card.querySelector('.milestone-progress-bar');
              if (progressBar) {
                const targetWidth = progressBar.getAttribute('data-target-width');
                const milestonePercent = progressBar.getAttribute('data-milestone-percent');
                const completionPercent = parseFloat(progressBar.getAttribute('data-completion-percent'));
                
                // Apply dynamic color based on completion percentage
                const colorClass = getProgressColor(completionPercent);
                progressBar.classList.add(colorClass);
                
                console.log(`ðŸŽ¨ Milestone progress: ${completionPercent.toFixed(1)}% completion â†’ ${colorClass}`);
                
                setTimeout(() => {
                  progressBar.style.width = targetWidth + '%';
                  progressBar.classList.add('animate');
                  
                  if (parseFloat(milestonePercent) >= 55.0) {
                    setTimeout(() => {
                      progressBar.classList.add('progress-complete');
                    }, 2000);
                  }
                }, 400);
              }
            }
          }
        });
      }, observerOptions);
      
      // Start observing
      const divisionCard = document.querySelector('.division-utilized-card');
      const milestoneCard = document.querySelector('.milestone-utilized-card');
      
      if (divisionCard) progressObserver.observe(divisionCard);
      if (milestoneCard) progressObserver.observe(milestoneCard);
    }, 100);
  }

  // Helper function to format currency
  function formatCurrency(amount) {
    if (!amount || isNaN(amount)) return '0.00';
    return parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // Helper function to format dates
  function formatDate(dateString) {
    if (!dateString) return null;
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    } catch (e) {
      return dateString;
    }
  }

  // Helper function to format dates with time
  function formatDateTime(dateString) {
    if (!dateString) return null;
    try {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return dateString;
    }
  }

  // Helper function to format file sizes
  function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Initialize notes character counter
  function initializeNotesCharCounter() {
    const notesTextarea = document.getElementById('adminNotes');
    const charCounter = document.getElementById('notesCharCount');
    
    if (notesTextarea && charCounter) {
      const updateCounter = () => {
        const count = notesTextarea.value.length;
        charCounter.textContent = `${count}/500`;
        charCounter.className = count > 450 ? 'text-xs text-red-500' : 'text-xs text-yellow-500';
      };
      
      notesTextarea.addEventListener('input', updateCounter);
      updateCounter(); // Initialize counter
    }
  }

  // Helper function to format file size
  window.formatFileSize = function(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  // Photo preview/zoom function (adapted from submit-update.astro)
  // Helper function to convert server URL to data URL (same approach as profile pictures)
  async function convertToDataURL(serverUrl) {
    try {
      console.log(`ðŸ”„ Converting server URL to data URL: ${serverUrl}`);
      const response = await fetch(serverUrl, { mode: 'cors' });
      if (response.ok) {
        const blob = await response.blob();
        const dataUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
        console.log(`âœ… Successfully converted to data URL`);
        return dataUrl;
      }
    } catch (error) {
      console.log(`âš ï¸ Failed to convert server URL to data URL:`, error);
    }
    return serverUrl; // Fallback to original URL
  }

  // Helper function to load image with data URL conversion
  async function loadImageWithDataURL(imgElement, serverUrl, fileName) {
    try {
      // Convert server URL to data URL to bypass CORS
      const dataUrl = await convertToDataURL(serverUrl);
      imgElement.src = dataUrl;
      imgElement.onload = () => {
        console.log('âœ… Image loaded successfully via data URL:', fileName);
      };
      imgElement.onerror = () => {
        console.error('âŒ Failed to load image via data URL:', fileName);
        // Show error state
        imgElement.style.display = 'none';
        const errorDiv = imgElement.nextElementSibling;
        if (errorDiv) {
          errorDiv.style.display = 'block';
        }
      };
    } catch (error) {
      console.error('âŒ Error in loadImageWithDataURL:', error);
      imgElement.style.display = 'none';
      const errorDiv = imgElement.nextElementSibling;
      if (errorDiv) {
        errorDiv.style.display = 'block';
      }
    }
  }

  // Helper function to load video with data URL conversion
  async function loadVideoWithDataURL(videoElement, serverUrl, fileName) {
    try {
      // Convert server URL to data URL to bypass CORS
      const dataUrl = await convertToDataURL(serverUrl);
      videoElement.src = dataUrl;
      videoElement.onloadstart = () => {
        console.log('ðŸŽ¥ Video loading started via data URL:', fileName);
      };
      videoElement.oncanplay = () => {
        console.log('âœ… Video can play via data URL:', fileName);
      };
      videoElement.onerror = () => {
        console.error('âŒ Failed to load video via data URL:', fileName);
        // Show error state
        videoElement.style.display = 'none';
        const errorDiv = videoElement.parentElement.querySelector('.video-error-fallback');
        if (errorDiv) {
          errorDiv.style.display = 'block';
        }
      };
    } catch (error) {
      console.error('âŒ Error in loadVideoWithDataURL:', error);
      videoElement.style.display = 'none';
      const errorDiv = videoElement.parentElement.querySelector('.video-error-fallback');
      if (errorDiv) {
        errorDiv.style.display = 'block';
      }
    }
  }

  window.previewPhoto = async function(imageSrc, fileName) {
    console.log('ðŸ–¼ï¸ Opening photo preview:', { imageSrc, fileName });
    
    const modal = document.getElementById('photo-preview-modal');
    const modalImg = document.getElementById('modal-photo');
    const modalTitle = document.getElementById('modal-photo-title');
    
    if (modal && modalImg && modalTitle) {
      // Clear any previous image
      modalImg.src = '';
      modalTitle.textContent = fileName;
      
      // Show modal first
      modal.classList.remove('hidden');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // First, try to find the cached data URL from the grid image (same approach as submit-update.astro)
      let cachedDataUrl = null;
      
      // Look for the corresponding grid image that has the same data-photo-url
      const gridImages = document.querySelectorAll('#physicalInfo img[data-photo-url]');
      for (const gridImg of gridImages) {
        if (gridImg.getAttribute('data-photo-url') === imageSrc) {
          // Check if this image has a cached data URL
          const originalSrc = gridImg.getAttribute('data-original-src');
          if (originalSrc && originalSrc.startsWith('data:')) {
            cachedDataUrl = originalSrc;
            console.log('ðŸ”„ Using cached data URL from grid image for preview:', fileName);
            break;
          }
          
          // Also check sessionStorage if available
          const photoId = gridImg.getAttribute('data-photo-id');
          if (photoId) {
            const sessionKey = `modal-photo-${photoId}`;
            const sessionDataUrl = sessionStorage.getItem(sessionKey);
            if (sessionDataUrl && sessionDataUrl.startsWith('data:')) {
              cachedDataUrl = sessionDataUrl;
              console.log('ðŸ”„ Using cached data URL from sessionStorage for preview:', fileName);
              break;
            }
          }
        }
      }
      
      // Use cached data URL if available, otherwise convert fresh
      try {
        let dataUrl;
        if (cachedDataUrl) {
          dataUrl = cachedDataUrl;
          console.log('âœ… Using cached data URL for preview:', fileName);
        } else {
          console.log('ðŸ”„ Converting fresh data URL for preview:', fileName);
          dataUrl = await convertToDataURL(imageSrc);
        }
        
        modalImg.src = dataUrl;
        
        // Add protection to the modal image (same as grid images)
        modalImg.setAttribute('data-original-src', dataUrl);
        
        // Apply MutationObserver protection to the modal image
        if (window.modalImageObserver) {
          window.modalImageObserver.observe(modalImg, {
            attributes: true,
            attributeFilter: ['src']
          });
        }
        
        modalImg.onload = function() {
          console.log('âœ… Image loaded successfully in modal with protection:', fileName);
        };
        modalImg.onerror = function() {
          console.error('âŒ Failed to load image in modal via data URL:', fileName);
          modalTitle.innerHTML = `
            <div class="text-red-500 text-center">
              <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p>Failed to load image</p>
              <p class="text-sm text-gray-400">${fileName}</p>
            </div>
          `;
        };
      } catch (error) {
        console.error('âŒ Error loading image in modal:', error);
        modalTitle.innerHTML = `
          <div class="text-red-500 text-center">
            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>Failed to load image</p>
            <p class="text-sm text-gray-400">${fileName}</p>
          </div>
        `;
      }
      
      console.log('âœ… Photo modal opened successfully');
    } else {
      console.error('âŒ Photo modal elements not found');
    }
  };

  // Video preview/player function (adapted from submit-update.astro)
  window.previewVideo = async function(videoSrc, fileName) {
    console.log('ðŸŽ¥ Opening video preview:', { videoSrc, fileName });
    
    const modal = document.getElementById('video-preview-modal');
    const modalVideo = document.getElementById('modal-video');
    const modalTitle = document.getElementById('modal-video-title');
    
    if (modal && modalVideo && modalTitle) {
      // Clear any previous source
      modalVideo.src = '';
      modalVideo.load();
      modalTitle.textContent = fileName;
      
      // Show modal first
      modal.classList.remove('hidden');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Load video using data URL conversion (same as profile pictures)
      try {
        const dataUrl = await convertToDataURL(videoSrc);
        modalVideo.src = dataUrl;
      modalVideo.onloadstart = function() {
          console.log('ðŸŽ¥ Modal video loading started via data URL:', fileName);
      };
      modalVideo.oncanplay = function() {
          console.log('âœ… Modal video can play via data URL:', fileName);
      };
      modalVideo.onerror = function() {
          console.error('âŒ Modal video failed to load via data URL:', fileName);
          modalTitle.innerHTML = `
            <div class="text-red-500 text-center">
              <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p>Failed to load video</p>
              <p class="text-sm text-gray-400">${fileName}</p>
            </div>
          `;
        };
      } catch (error) {
        console.error('âŒ Error loading video in modal:', error);
        modalTitle.innerHTML = `
          <div class="text-red-500 text-center">
            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>Failed to load video</p>
            <p class="text-sm text-gray-400">${fileName}</p>
          </div>
        `;
      }
      
      console.log('âœ… Video modal opened successfully');
    } else {
      console.error('âŒ Video modal elements not found');
    }
  };

  // Close photo preview modal
  window.closePhotoPreview = function() {
    const modal = document.getElementById('photo-preview-modal');
    const modalImg = document.getElementById('modal-photo');
    
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
      
      // Clear modal image data
      if (modalImg) {
        modalImg.src = '';
      }
      
      // Restore body scrolling
      document.body.style.overflow = 'auto';
      
      console.log('ðŸ“¸ Photo modal closed');
    }
  };

  // Close video preview modal
  window.closeVideoPreview = function() {
    const modal = document.getElementById('video-preview-modal');
    const modalVideo = document.getElementById('modal-video');
    
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
      
      // Stop video playback and clear source
      if (modalVideo) {
        modalVideo.pause();
        modalVideo.currentTime = 0;
        modalVideo.src = '';
      }
      
      // Restore body scrolling
      document.body.style.overflow = 'auto';
      
      console.log('ðŸŽ¥ Video modal closed');
    }
  };

  // Event listeners for modal interactions (adapted from submit-update.astro)
  window.addEventListener('click', function(event) {
    const photoModal = document.getElementById('photo-preview-modal');
    const videoModal = document.getElementById('video-preview-modal');
    
    if (event.target === photoModal) {
      window.closePhotoPreview();
    }
    if (event.target === videoModal) {
      window.closeVideoPreview();
    }
  });

  // Close modal with Escape key
  window.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      window.closePhotoPreview();
      window.closeVideoPreview();
    }
  });

  // Legacy function cleanup - functionality moved to previewPhoto/previewVideo
  window.closeMediaPreview = function() {
    // Redirect to new functions for compatibility
    window.closePhotoPreview();
    window.closeVideoPreview();
  };

  function rejectMilestoneSubmission() {
    if (!window.currentReviewSubmissionId) return;
    
    if (confirm('Are you sure you want to reject this milestone submission? The EIU will need to revise and resubmit.')) {
      // Update submission status
      const submission = milestoneSubmissions.find(s => s.id === window.currentReviewSubmissionId);
      if (submission) {
        submission.status = 'rejected';
        renderSubmissions();
        updateSubmissionCount();
        closeMilestoneSubmissionModal();
        
        // Show success notification
        alert('Milestone submission rejected. The EIU has been notified to make revisions.');
      }
    }
  }

  function submitToMPMECSecretariat() {
    if (!window.currentReviewSubmissionId) return;
    
    const rpmesForm = document.getElementById('rpmesFormUpload');
    if (!rpmesForm || !rpmesForm.files.length) {
      alert('Please attach the RPMES form before submitting to the Secretariat.');
      return;
    }
    
    if (confirm('Are you sure you want to submit this milestone to the MPMEC Secretariat? This action cannot be undone.')) {
      // Update submission status
      const submission = milestoneSubmissions.find(s => s.id === window.currentReviewSubmissionId);
      if (submission) {
        submission.status = 'approved';
        renderSubmissions();
        updateSubmissionCount();
        closeMilestoneSubmissionModal();
        
        // Show success notification
                 alert('Milestone submission approved and forwarded to MPMEC Secretariat successfully!');
       }
     }
   }

     // Submission History & Analytics functions
  function showSubmissionHistoryAnalytics() {
    // The section is always visible now, just update the data
    updateAnalyticsData();
    console.log('ðŸ“Š Submission History & Analytics data updated');
  }

     function updateAnalyticsData() {
    // Load milestone submissions first if not already loaded
    if (!milestoneSubmissions || milestoneSubmissions.length === 0) {
      loadMilestoneSubmissions();
      return;
    }

    const totalSubmissions = milestoneSubmissions.length;
    const pendingSubmissions = milestoneSubmissions.filter(s => s.status === 'pending_review' || s.status === 'under_review').length;
    const approvedSubmissions = milestoneSubmissions.filter(s => s.status === 'approved').length;
    const rejectedSubmissions = milestoneSubmissions.filter(s => s.status === 'rejected' || s.status === 'needs_revision').length;

    // Safely update analytics elements if they exist
    const analyticsTotal = document.getElementById('analyticsTotal');
    const analyticsPending = document.getElementById('analyticsPending');
    const analyticsApproved = document.getElementById('analyticsApproved');
    const analyticsRejected = document.getElementById('analyticsRejected');
    
    if (analyticsTotal) analyticsTotal.textContent = totalSubmissions;
    if (analyticsPending) analyticsPending.textContent = pendingSubmissions;
    if (analyticsApproved) analyticsApproved.textContent = approvedSubmissions;
    if (analyticsRejected) analyticsRejected.textContent = rejectedSubmissions;

    // Update charts
    updateEIUSubmissionTrend();
    updateReviewCompletionCurve();
    updateSubmissionTimeline();
    
    console.log('ðŸ“Š Analytics data updated:', {
      total: totalSubmissions,
      pending: pendingSubmissions,
      approved: approvedSubmissions,
      rejected: rejectedSubmissions
    });
  }

  // Update EIU Submission Trend chart
  function updateEIUSubmissionTrend() {
    const chartContainer = document.querySelector('.eiu-submission-trend-chart');
    if (!chartContainer || !milestoneSubmissions.length) {
      if (chartContainer) {
        chartContainer.innerHTML = `
          <div class="h-64 flex items-center justify-center text-gray-500">
            <div class="text-center">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <p class="text-sm">Submission trend will appear after updates</p>
            </div>
          </div>
        `;
      }
      return;
    }

    // Group submissions by date
    const submissionsByDate = {};
    milestoneSubmissions.forEach(submission => {
      const date = new Date(submission.submittedAt).toLocaleDateString();
      submissionsByDate[date] = (submissionsByDate[date] || 0) + 1;
    });

    const dates = Object.keys(submissionsByDate).sort();
    const maxCount = Math.max(...Object.values(submissionsByDate));

    chartContainer.innerHTML = `
      <div class="h-64 flex items-end justify-around space-x-2 px-4">
        ${dates.map(date => {
          const count = submissionsByDate[date];
          const height = (count / maxCount) * 100;
          return `
            <div class="flex-1 flex flex-col items-center">
              <div class="w-full bg-gray-200 rounded-full h-32 mb-2 flex items-end">
                <div class="bg-gradient-to-r from-orange-400 to-red-500 w-full rounded-full transition-all duration-500" 
                     style="height: ${height}%"></div>
              </div>
              <span class="text-xs text-gray-600">${date}</span>
              <span class="text-xs font-semibold text-orange-600">${count}</span>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  // Update Review Completion Curve chart
  function updateReviewCompletionCurve() {
    const chartContainer = document.querySelector('.review-completion-curve-chart');
    if (!chartContainer || !milestoneSubmissions.length) {
      if (chartContainer) {
        chartContainer.innerHTML = `
          <div class="h-64 flex items-center justify-center text-gray-500">
            <div class="text-center">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
              </svg>
              <p class="text-sm">Review curve will appear after submissions</p>
            </div>
          </div>
        `;
      }
      return;
    }

    // Calculate review completion over time
    const reviewData = milestoneSubmissions
      .filter(s => s.status === 'approved' || s.status === 'rejected')
      .sort((a, b) => new Date(a.reviewedAt || a.updatedAt) - new Date(b.reviewedAt || b.updatedAt))
      .map((submission, index) => ({
        date: new Date(submission.reviewedAt || submission.updatedAt).toLocaleDateString(),
        completion: ((index + 1) / milestoneSubmissions.length) * 100,
        status: submission.status
      }));

    if (reviewData.length > 0) {
      chartContainer.innerHTML = `
        <div class="h-64 flex items-end justify-around space-x-2 px-4">
          ${reviewData.map((point, index) => {
            const height = (point.completion / 100) * 100;
            const statusColor = point.status === 'approved' ? 'bg-green-500' : 'bg-red-500';
            return `
              <div class="flex-1 flex flex-col items-center">
                <div class="w-full bg-gray-200 rounded-full h-32 mb-2 flex items-end">
                  <div class="${statusColor} w-full rounded-full transition-all duration-500" 
                       style="height: ${height}%"></div>
                </div>
                <span class="text-xs text-gray-600">${point.date}</span>
                <span class="text-xs font-semibold text-green-600">${point.completion.toFixed(1)}%</span>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
  }

  // Update Submission Timeline
  function updateSubmissionTimeline() {
    const timelineContainer = document.getElementById('submissionTimelineContainer');
    if (!timelineContainer) return;

    if (!milestoneSubmissions.length) {
      timelineContainer.innerHTML = `
        <div class="text-center py-12 text-gray-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-sm">No submissions yet</p>
          <p class="text-xs text-gray-400">Submit your first milestone update to see detailed timeline</p>
        </div>
      `;
      return;
    }

    const sortedSubmissions = [...milestoneSubmissions].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

    timelineContainer.innerHTML = sortedSubmissions.map((submission, index) => {
      const date = new Date(submission.submittedAt);
      const statusColor = submission.status === 'approved' ? 'bg-green-100 border-green-300' : 
                         submission.status === 'pending_review' ? 'bg-yellow-100 border-yellow-300' : 
                         submission.status === 'under_review' ? 'bg-blue-100 border-blue-300' :
                         'bg-red-100 border-red-300';
      
      return `
        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0 w-4 h-4 bg-orange-500 rounded-full border-4 border-white shadow-md relative z-10"></div>
          <div class="flex-1 ${statusColor} rounded-lg p-4 border">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-gray-800">${submission.milestone?.title || 'Milestone Update'}</h4>
              <span class="text-sm text-gray-500">${date.toLocaleDateString()}</span>
            </div>
            <p class="text-sm text-gray-600 mb-2">Project: ${submission.project?.name || 'Unknown Project'}</p>
            <div class="flex items-center justify-between">
              <span class="text-xs px-2 py-1 rounded-full ${
                submission.status === 'approved' ? 'bg-green-200 text-green-800' :
                submission.status === 'pending_review' ? 'bg-yellow-200 text-yellow-800' :
                submission.status === 'under_review' ? 'bg-blue-200 text-blue-800' :
                'bg-red-200 text-red-800'
              }">
                ${submission.status.replace('_', ' ').toUpperCase()}
              </span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Export submission report function
  function exportSubmissionReport() {
    console.log('ðŸ“Š Exporting submission report...');
    
    if (!milestoneSubmissions || milestoneSubmissions.length === 0) {
      alert('No submission data to export');
      return;
    }

    // Prepare CSV data
    const csvData = [
      ['Submission Date', 'Project', 'Milestone', 'Status', 'Submitted By', 'Review Date'],
      ...milestoneSubmissions.map(submission => [
        new Date(submission.submittedAt).toLocaleDateString(),
        submission.projectName || 'N/A',
        submission.milestoneName || 'N/A',
        submission.status || 'N/A',
        submission.submittedBy || 'N/A',
        submission.reviewDate ? new Date(submission.reviewDate).toLocaleDateString() : 'Pending'
      ])
    ];

    // Convert to CSV string
    const csvContent = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');

    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `submission-report-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('âœ… Report exported successfully');
  }

  // Refresh submission history function
  function refreshSubmissionHistory() {
    console.log('ðŸ”„ Refreshing submission history...');
    
    // Show loading state (optional)
    const totalElement = document.getElementById('analyticsTotal');
    if (totalElement) {
      totalElement.textContent = '...';
    }

    // Simulate API call to refresh data
    setTimeout(() => {
      updateAnalyticsData();
      updateSubmissionTimeline();
      console.log('âœ… Submission history refreshed');
      
      // Show success notification (optional)
      if (window.showNotification) {
        window.showNotification('Submission history refreshed successfully', 'success');
      }
    }, 1000);
  }

  // Toggle timeline view function
  function toggleTimelineView(view) {
    const listView = document.getElementById('submissionTimeline');
    const timelineView = document.getElementById('submissionTimelineView');
    const listBtn = document.getElementById('listViewBtn');
    const timelineBtn = document.getElementById('timelineViewBtn');
    
    if (!listView || !timelineView || !listBtn || !timelineBtn) {
      console.error('Timeline view elements not found');
      return;
    }
    
    if (view === 'timeline') {
      listView.style.display = 'none';
      timelineView.classList.remove('hidden');
      // Update tab button classes - List View inactive
      listBtn.className = 'timeline-tab-button inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300';
      // Timeline View active
      timelineBtn.className = 'timeline-tab-button active inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300';
      renderSubmissionTimelineView();
    } else {
      listView.style.display = 'block';
      timelineView.classList.add('hidden');
      // List View active
      listBtn.className = 'timeline-tab-button active inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300';
      // Timeline View inactive
      timelineBtn.className = 'timeline-tab-button inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300';
    }
    
    console.log('ðŸ“Š Timeline view switched to:', view);
  }

  // Render submission timeline view
  function renderSubmissionTimelineView() {
    const container = document.getElementById('submissionTimelineContainer');
    if (!container || !milestoneSubmissions || milestoneSubmissions.length === 0) {
      if (container) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500"><p>No submissions to display in timeline view</p></div>';
      }
      return;
    }
    
    const sortedSubmissions = [...milestoneSubmissions].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
    
    container.innerHTML = sortedSubmissions.map((submission, index) => {
      const date = new Date(submission.submittedAt);
      const statusColors = {
        'pending_review': 'from-orange-500 to-orange-600',
        'under_review': 'from-amber-500 to-amber-600',
        'approved': 'from-green-500 to-green-600',
        'rejected': 'from-red-500 to-red-600'
      };
      
      return `
        <div class="flex items-start gap-6 relative">
          <div class="icon-container bg-gradient-to-br ${statusColors[submission.status] || 'from-amber-500 to-amber-600'} flex-shrink-0 z-10">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div class="flex-1 profile-card p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="icon-container-small bg-gradient-to-br from-amber-500 to-amber-600">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                </div>
                <h5 class="text-lg font-bold text-black">${submission.milestoneName || 'Milestone Update'}</h5>
              </div>
              <div class="text-xs text-amber-600 font-medium bg-amber-50 px-3 py-1 rounded-full border border-amber-200">${date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}</div>
            </div>
            <div class="text-sm text-gray-600 mb-3">
              <strong>Project:</strong> ${submission.projectName || 'N/A'}<br>
              <strong>Submitted by:</strong> ${submission.submittedBy || 'N/A'}<br>
              <strong>Status:</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                submission.status === 'approved' ? 'bg-green-100 text-green-800' :
                submission.status === 'rejected' ? 'bg-red-100 text-red-800' :
                submission.status === 'under_review' ? 'bg-amber-100 text-amber-800' :
                'bg-orange-100 text-orange-800'
              }">${submission.status || 'Pending'}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

   function exportAnalyticsReport() {
     if (milestoneSubmissions.length === 0) {
       alert('No submission data available to export.');
       return;
     }
     
     // Create CSV content
     const headers = ['Project Name', 'Project Code', 'Milestone Name', 'Status', 'Submission Date', 'Planned Budget', 'Weight'];
     const csvContent = [
       headers.join(','),
       ...milestoneSubmissions.map(s => [
         `"${s.projectName}"`,
         s.projectCode,
         `"${s.milestone.name}"`,
         s.status,
         s.milestone.submissionDate,
         s.milestone.plannedBudget,
         s.milestone.weight
       ].join(','))
     ].join('\n');
     
     // Download CSV
     const blob = new Blob([csvContent], { type: 'text/csv' });
     const url = window.URL.createObjectURL(blob);
     const a = document.createElement('a');
     a.href = url;
     a.download = `submission-analytics-${new Date().toISOString().split('T')[0]}.csv`;
     a.click();
     window.URL.revokeObjectURL(url);
   }

   function refreshAnalytics() {
     updateAnalyticsData();
   }

   // Status Lifecycle Management
   const STATUS_LIFECYCLE = {
     PROJECT: {
       PENDING: 'pending',        // Not approved by Secretariat yet
       ONGOING: 'ongoing',        // Approved by Secretariat, updatable by EIU
       DELAYED: 'delayed',        // Any milestone delayed â†’ project is delayed
       COMPLETED: 'completed'     // All milestones validated by Secretariat
     },
     MILESTONE: {
       PENDING: 'pending',        // Not updated by EIU, no effect on project status
       ONGOING: 'ongoing',        // Updated by EIU, to be reviewed by IOO, to be validated by Secretariat
       DELAYED: 'delayed',        // Past due date â†’ affects project status
       NEED_REVISION: 'need_revision', // Red, requested by Secretariat, does not affect project status
       COMPLETED: 'completed'     // Validated by Secretariat, contributes to project completion
     }
   };

   function updateProjectStatus(projectId, newStatus, reason = '') {
     const project = allProjects.find(p => p.id === projectId);
     if (!project) return false;

     const oldStatus = project.status;
     project.status = newStatus;
     project.statusUpdatedAt = new Date().toISOString();
     project.statusUpdateReason = reason;

     console.log(`Project ${projectId} status changed: ${oldStatus} â†’ ${newStatus}`, reason);
     
     // Update UI
     renderProjectsGrid(allProjects);
     updateSummaryCards(allProjects);
     
     // Update selected project if it's the current one
     if (selectedProject && selectedProject.id === projectId) {
       selectedProject.status = newStatus;
       updateProjectManagementDashboard(selectedProject);
     }

     return true;
   }

   function updateMilestoneStatus(milestoneId, newStatus, reason = '') {
     // Find milestone in submissions
     const submission = milestoneSubmissions.find(s => s.milestone.id === milestoneId);
     if (submission) {
       const oldStatus = submission.status;
       submission.status = newStatus;
       submission.statusUpdatedAt = new Date().toISOString();
       submission.statusUpdateReason = reason;

       console.log(`Milestone ${milestoneId} status changed: ${oldStatus} â†’ ${newStatus}`, reason);
       
       // Update UI
       renderSubmissions();
       updateAnalyticsData();
       
       return true;
     }
     return false;
   }

   function checkProjectDelayedStatus(projectId) {
         const project = allProjects.find(p => p.id === projectId);
    if (!project) return false;
    
    // Ensure milestones is an array
    const milestones = Array.isArray(project.milestones) ? project.milestones : [];
    if (milestones.length === 0) return false;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Check if any milestone is delayed
    const hasDelayedMilestones = milestones.some(milestone => {
       const dueDate = new Date(milestone.dueDate || milestone.deadline || milestone.targetDate);
       dueDate.setHours(0, 0, 0, 0);
       
       return dueDate < today && 
              milestone.status !== STATUS_LIFECYCLE.MILESTONE.COMPLETED &&
              milestone.status !== STATUS_LIFECYCLE.MILESTONE.NEED_REVISION;
     });

     if (hasDelayedMilestones && project.status !== STATUS_LIFECYCLE.PROJECT.DELAYED) {
       updateProjectStatus(projectId, STATUS_LIFECYCLE.PROJECT.DELAYED, 'Milestone(s) past due date');
       
       // Show notification badge in sidebar
       showNotificationBadge();
       
       return true;
     }

     return false;
   }

     function checkProjectCompletionStatus(projectId) {
    const project = allProjects.find(p => p.id === projectId);
    if (!project) return false;
    
    // Ensure milestones is an array
    const milestones = Array.isArray(project.milestones) ? project.milestones : [];
    if (milestones.length === 0) return false;

    // Check if all milestones are completed
    const allMilestonesCompleted = milestones.every(milestone => 
      milestone.status === STATUS_LIFECYCLE.MILESTONE.COMPLETED
    );

     if (allMilestonesCompleted && project.status !== STATUS_LIFECYCLE.PROJECT.COMPLETED) {
       updateProjectStatus(projectId, STATUS_LIFECYCLE.PROJECT.COMPLETED, 'All milestones validated by Secretariat');
       
       // Hide notification badge if no other pending items
       const hasOtherPendingProjects = allProjects.some(p => 
         p.id !== projectId && (p.status === STATUS_LIFECYCLE.PROJECT.DELAYED || p.hasPendingSubmissions)
       );
       
       if (!hasOtherPendingProjects) {
         hideNotificationBadge();
       }
       
       return true;
     }

     return false;
   }

   function processSubmissionStatusChange(submissionId, newStatus, reason = '') {
     const submission = milestoneSubmissions.find(s => s.id === submissionId);
     if (!submission) return false;

     // Update submission status
     updateMilestoneStatus(submission.milestone.id, newStatus, reason);

     // Update project status based on milestone changes
     const projectId = submission.projectId || selectedProject?.id;
     if (projectId) {
       // Check for delayed status
       checkProjectDelayedStatus(projectId);
       
       // Check for completion status
       if (newStatus === STATUS_LIFECYCLE.MILESTONE.COMPLETED) {
         checkProjectCompletionStatus(projectId);
       }
       
       // Update project to ongoing if milestone is being worked on
       if (newStatus === STATUS_LIFECYCLE.MILESTONE.ONGOING) {
         const project = allProjects.find(p => p.id === projectId);
         if (project && project.approvedBySecretariat && project.status === STATUS_LIFECYCLE.PROJECT.PENDING) {
           updateProjectStatus(projectId, STATUS_LIFECYCLE.PROJECT.ONGOING, 'EIU milestone submission received');
         }
       }
     }

     return true;
   }

   function showNotificationBadge() {
     const badge = document.getElementById('submissionNotificationBadge');
     if (badge) {
       badge.classList.remove('hidden');
     }
   }

   function hideNotificationBadge() {
     const badge = document.getElementById('submissionNotificationBadge');
     if (badge) {
       badge.classList.add('hidden');
     }
   }

     // Reject milestone submission function
  async function rejectSubmission(submissionId) {
    console.log('ðŸš« Rejecting submission:', submissionId);
    
    // Get rejection reason from user
    const reason = prompt('Please provide a reason for rejection (optional):');
    
    if (!confirm('Are you sure you want to reject this milestone submission? The EIU will be notified and the submission will be deleted.')) {
      return;
    }
    
    try {
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      if (!token) {
        alert('Authentication required. Please log in again.');
        return;
      }

      // Update submission status to rejected
      const response = await fetch(`${API_URL}/milestones/milestone-submissions/${submissionId}/status`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'rejected',
          reviewNotes: reason || 'Submission rejected by LGU-IU'
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('ðŸ“¦ Rejection response:', data);

      if (data.success) {
        // Show success message
        alert('Milestone submission rejected successfully. The EIU has been notified.');
        
        // Create notification for EIU
        await createEIUNotification(submissionId, reason);
        
        // Delete the submission
        await deleteRejectedSubmission(submissionId);
        
        // Reload milestone submissions
        loadMilestoneSubmissions();
        
        // Close any open modals
        const modal = document.getElementById('milestoneSubmissionModal');
        if (modal) {
          modal.classList.add('hidden');
        }
      } else {
        alert('Error rejecting submission: ' + (data.error || 'Unknown error'));
      }
      
    } catch (error) {
      console.error('âŒ Error rejecting submission:', error);
      alert('Error rejecting submission. Please try again.');
    }
  }

  // Create notification for EIU about rejection
  async function createEIUNotification(submissionId, reason) {
    try {
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      
      // First, get the submission details to find the EIU user
      const submissionResponse = await fetch(`${API_URL}/milestones/milestone-submissions/${submissionId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!submissionResponse.ok) {
        console.warn('âš ï¸ Could not fetch submission details for notification');
        return;
      }

      const submissionData = await submissionResponse.json();
      if (!submissionData.success || !submissionData.submission) {
        console.warn('âš ï¸ Invalid submission data for notification');
        return;
      }

      const submission = submissionData.submission;
      const eiuUserId = submission.submitterId;

      if (!eiuUserId) {
        console.warn('âš ï¸ No EIU user ID found for notification');
        return;
      }

      // Create notification for the EIU user
      const response = await fetch(`${API_URL}/notifications/create-for-user`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: eiuUserId,
          type: 'milestone_rejected',
          title: 'Milestone Submission Rejected',
          message: `Your milestone submission "${submission.milestone?.title || 'Milestone Update'}" has been rejected by the LGU-IU. ${reason ? 'Reason: ' + reason : 'Please review and resubmit.'}`,
          category: 'Submission',
          entityType: 'MilestoneSubmission',
          entityId: submissionId,
          priority: 'high'
        })
      });

      if (response.ok) {
        console.log('âœ… EIU notification created successfully');
      } else {
        console.warn('âš ï¸ Failed to create EIU notification');
      }
    } catch (error) {
      console.error('âŒ Error creating EIU notification:', error);
    }
  }

  // Delete rejected submission
  async function deleteRejectedSubmission(submissionId) {
    try {
      const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
      
      const response = await fetch(`${API_URL}/milestones/milestone-submissions/${submissionId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        console.log('âœ… Rejected submission deleted successfully');
      } else {
        console.warn('âš ï¸ Failed to delete rejected submission');
      }
    } catch (error) {
      console.error('âŒ Error deleting rejected submission:', error);
    }
  }

  // Enhanced rejection with status lifecycle
  function rejectMilestoneSubmissionWithLifecycle() {
     if (!window.currentReviewSubmissionId) return;
     
     const submission = milestoneSubmissions.find(s => s.id === window.currentReviewSubmissionId);
     if (!submission) return;
     
     const reason = prompt('Please provide a reason for rejection (optional):');
     
     if (confirm('Are you sure you want to reject this milestone submission? The EIU will need to revise and resubmit.')) {
       // Process status change with lifecycle rules
       processSubmissionStatusChange(window.currentReviewSubmissionId, STATUS_LIFECYCLE.MILESTONE.NEED_REVISION, reason || 'Rejected by IOO Admin');
       
       closeMilestoneSubmissionModal();
       
       // Show enhanced notification
       alert(`Milestone submission rejected. ${reason ? 'Reason: ' + reason + '. ' : ''}The EIU has been notified to make revisions.`);
     }
   }

   // Enhanced approval with status lifecycle and API integration
   async function submitToMPMECSecretariatWithLifecycle() {
     if (!window.currentReviewSubmissionId) return;
     
     const rpmesForm = document.getElementById('rpmesFormUpload');
     if (!rpmesForm || !rpmesForm.files.length) {
       alert('Please attach the RPMES form before submitting to the Secretariat.');
       return;
     }
     
     const additionalNotes = document.getElementById('adminNotes')?.value || '';
     
     if (confirm('Are you sure you want to submit this milestone to the MPMEC Secretariat? This action cannot be undone.')) {
       try {
         // Show loading state
         const submitButton = document.querySelector('button[onclick="submitToMPMECSecretariatWithLifecycle()"]');
         if (submitButton) {
           submitButton.disabled = true;
           submitButton.innerHTML = 'Submitting...';
         }

         // Get the submission data
         const submission = milestoneSubmissions.find(s => s.id === window.currentReviewSubmissionId);
         if (!submission) {
           throw new Error('Submission not found');
         }

         // Extract division weights from the submission data
         const timelineWeight = parseFloat(submission.timelineWeight || 0);
         const budgetWeight = parseFloat(submission.budgetWeight || 0);
         const physicalWeight = parseFloat(submission.physicalWeight || 0);
         
         // Get budget division utilized from the modal (if available)
         // Look for the "Division Utilized" field in the modal by targeting the specific element
         let budgetDivisionUtilized = budgetWeight; // fallback to planned weight
         
         console.log('ðŸ” Starting Division Utilized extraction...');
         console.log('ðŸ” Modal elements available:', {
           divisionUtilizedCard: !!document.querySelector('.division-utilized-card'),
           purpleElements: document.querySelectorAll('[class*="text-purple-600"]').length,
           modalExists: !!document.querySelector('#milestoneSubmissionModal')
         });
         
         // Method 1: Look for the specific Division Utilized element with text-purple-600 class
         const divisionUtilizedElement = document.querySelector('.division-utilized-card .text-purple-600');
         if (divisionUtilizedElement) {
           const text = divisionUtilizedElement.textContent || '';
           console.log('ðŸ” Division Utilized element text:', text);
           const match = text.match(/(\d+\.?\d*)\s*%/);
           if (match) {
             budgetDivisionUtilized = parseFloat(match[1]);
             console.log('ðŸ” Found Division Utilized via purple element:', budgetDivisionUtilized + '%');
           }
         }
         
         // Method 2: Look for text containing "Division Utilized" and extract the percentage
         if (budgetDivisionUtilized === budgetWeight) {
           const modalText = document.body.textContent || '';
           const divisionUtilizedMatch = modalText.match(/Division Utilized[:\s]*(\d+\.?\d*)\s*%/i);
           if (divisionUtilizedMatch) {
             budgetDivisionUtilized = parseFloat(divisionUtilizedMatch[1]);
             console.log('ðŸ” Found Division Utilized via text search:', budgetDivisionUtilized + '%');
           }
         }
         
         // Method 3: Look for any element with purple text that contains percentage
         if (budgetDivisionUtilized === budgetWeight) {
           const purpleElements = document.querySelectorAll('[class*="text-purple-600"], [class*="purple"]');
           console.log('ðŸ” Found purple elements:', purpleElements.length);
           for (const element of purpleElements) {
             const text = element.textContent || '';
             console.log('ðŸ” Purple element text:', text);
             const match = text.match(/(\d+\.?\d*)\s*%/);
             if (match && parseFloat(match[1]) < 100) { // Likely a percentage value
               budgetDivisionUtilized = parseFloat(match[1]);
               console.log('ðŸ” Found Division Utilized via purple element fallback:', budgetDivisionUtilized + '%');
               break;
             }
           }
         }
         
         // Method 4: Look for the specific modal content area
         if (budgetDivisionUtilized === budgetWeight) {
           const modalContent = document.querySelector('#milestoneSubmissionModal, .modal-content, [class*="modal"]');
           if (modalContent) {
             const modalText = modalContent.textContent || '';
             const divisionUtilizedMatch = modalText.match(/Division Utilized[:\s]*(\d+\.?\d*)\s*%/i);
             if (divisionUtilizedMatch) {
               budgetDivisionUtilized = parseFloat(divisionUtilizedMatch[1]);
               console.log('ðŸ” Found Division Utilized via modal content:', budgetDivisionUtilized + '%');
             }
           }
         }
         
         // Method 5: Direct calculation from submission data if available
         if (budgetDivisionUtilized === budgetWeight && submission.usedBudget && submission.plannedBudget) {
           const usedBudget = parseFloat(submission.usedBudget) || 0;
           const plannedBudget = parseFloat(submission.plannedBudget) || 0;
           if (plannedBudget > 0) {
             const rawUtilization = (usedBudget / plannedBudget) * 100;
             budgetDivisionUtilized = (rawUtilization * (budgetWeight / 100)).toFixed(2);
             console.log('ðŸ” Calculated Division Utilized from submission data:', budgetDivisionUtilized + '%');
           }
         }

         console.log('ðŸ” Division weights extracted:', {
           timelineWeight,
           budgetWeight,
           physicalWeight,
           budgetDivisionUtilized
         });

         // Prepare the RPMES form file
         const formData = new FormData();
         formData.append('rpmesForm', rpmesForm.files[0]);
         if (additionalNotes) {
           formData.append('reviewNotes', additionalNotes);
         }

         // Get authentication token
         const token = localStorage.getItem('token') || document.cookie.split('; ').find(row => row.startsWith('token='))?.split('=')[1];
         
         // Update milestone submission status via API
         const response = await fetch(`${API_URL}/milestones/milestone-submissions/${window.currentReviewSubmissionId}/status`, {
           method: 'PUT',
           headers: {
             'Authorization': `Bearer ${token}`,
             'Content-Type': 'application/json'
           },
           body: JSON.stringify({
             status: 'approved',
             reviewNotes: additionalNotes || 'Approved by IOO Admin and forwarded to MPMEC Secretariat'
           })
         });

         if (!response.ok) {
           const errorData = await response.json();
           throw new Error(errorData.error || 'Failed to update submission status');
         }

         // Upload RPMES form if provided
         if (rpmesForm.files.length > 0) {
           const uploadResponse = await fetch(`${API_URL}/milestones/milestone-submissions/${window.currentReviewSubmissionId}/upload-rpmes`, {
             method: 'POST',
             headers: {
               'Authorization': `Bearer ${token}`
             },
             body: formData
           });

           if (!uploadResponse.ok) {
             console.warn('Failed to upload RPMES form, but submission was approved');
           }
         }

         // Update project progress based on milestone approval
         console.log('ðŸ” Checking submission data for progress update:', {
           projectId: submission.projectId,
           milestoneId: submission.milestoneId,
           hasProjectId: !!submission.projectId,
           hasMilestoneId: !!submission.milestoneId
         });
         
         if (submission.projectId && submission.milestoneId) {
           try {
             console.log('ðŸš€ Making progress update API call to:', `${API_URL}/projects/${submission.projectId}/milestones/${submission.milestoneId}/approve-progress`);
             console.log('ðŸ“Š Sending progress data:', {
               timelineWeight,
               budgetWeight,
               physicalWeight,
               budgetDivisionUtilized
             });
             
             const progressResponse = await fetch(`${API_URL}/projects/${submission.projectId}/milestones/${submission.milestoneId}/approve-progress`, {
               method: 'POST',
               headers: {
                 'Authorization': `Bearer ${token}`,
                 'Content-Type': 'application/json'
               },
               body: JSON.stringify({
                 timelineWeight,
                 budgetWeight,
                 physicalWeight,
                 budgetDivisionUtilized
               })
             });

             console.log('ðŸ“¡ Progress API response status:', progressResponse.status);
             
             if (progressResponse.ok) {
               const progressData = await progressResponse.json();
               console.log('âœ… Project progress updated successfully:', progressData.progress);
               
               // Show progress update notification
               alert(`âœ… Progress Updated: Overall: ${progressData.progress.overall}%, Timeline: ${progressData.progress.timeline}%, Budget: ${progressData.progress.budget}%, Physical: ${progressData.progress.physical}%`);
               
               // Refresh project data to show updated progress
               console.log('ðŸ”„ Refreshing project data after progress update...');
               if (typeof loadProjects === 'function') {
                 loadProjects();
               }
             } else {
               const errorData = await progressResponse.json();
               console.warn('âŒ Failed to update project progress:', errorData);
               console.warn('Response status:', progressResponse.status);
             }
           } catch (progressError) {
             console.error('âŒ Error updating project progress:', progressError);
             // Don't fail the entire operation if progress update fails
           }
         } else {
           console.warn('âš ï¸ Cannot update progress - missing projectId or milestoneId:', {
             projectId: submission.projectId,
             milestoneId: submission.milestoneId
           });
         }

         // Process status change with lifecycle rules
         processSubmissionStatusChange(window.currentReviewSubmissionId, STATUS_LIFECYCLE.MILESTONE.COMPLETED, 'Approved by IOO Admin and forwarded to MPMEC Secretariat');
         
         // Update local submission status
         if (submission) {
           submission.status = 'approved';
           submission.reviewedAt = new Date().toISOString();
           submission.reviewNotes = additionalNotes;
         }

         // Refresh the submissions list
         await loadMilestoneSubmissions();
         
         // Automatically switch to Approved filter tab
         filterSubmissions('approved');
         
         closeMilestoneSubmissionModal();
         
         // Show enhanced notification
         alert('Milestone submission approved and forwarded to MPMEC Secretariat successfully! Project status updated based on milestone completion.');
         
       } catch (error) {
         console.error('Error submitting to MPMEC Secretariat:', error);
         alert(`Failed to submit to MPMEC Secretariat: ${error.message}`);
       } finally {
         // Reset button state
         const submitButton = document.querySelector('button[onclick="submitToMPMECSecretariatWithLifecycle()"]');
         if (submitButton) {
           submitButton.disabled = false;
           submitButton.innerHTML = `
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
             </svg>
             Approve & Submit to MPMEC
           `;
         }
       }
     }
   }

   // Periodic status check (runs every minute)
   function initializeStatusLifecycleMonitoring() {
     // Check for delayed projects on page load
     allProjects.forEach(project => {
       checkProjectDelayedStatus(project.id);
     });
     
     // Set up periodic monitoring
     setInterval(() => {
       allProjects.forEach(project => {
         checkProjectDelayedStatus(project.id);
         checkProjectCompletionStatus(project.id);
       });
     }, 60000); // Check every minute
   }

  // Make functions globally available
  window.selectProject = selectProject;
  window.approveUpdate = approveUpdate;
  window.rejectUpdate = rejectUpdate;
  window.compileAndSubmitToSecretariat = compileAndSubmitToSecretariat;
  window.loadProgressTimeline = loadProgressTimeline;
  window.refreshUpdates = refreshUpdates;
  // window.refreshProjectTimeline = refreshProjectTimeline; // Moved to enhanced timeline section
  window.setupHorizontalScroll = setupHorizontalScroll;
  window.updateSummaryCards = updateSummaryCards;
  window.renderProjectsGrid = renderProjectsGrid;

  window.toggleTimelineView = toggleTimelineView;
  window.exportSubmissionReport = exportSubmissionReport;
  window.refreshSubmissionHistory = refreshSubmissionHistory;
  window.renderSubmissionTimelineView = renderSubmissionTimelineView;
  window.setupAnalyticsEventListeners = setupAnalyticsEventListeners;
  window.filterProjects = filterProjects;
  window.clearFilters = clearFilters;
  window.updateProjectManagementDashboard = updateProjectManagementDashboard;
  window.refreshProjectData = refreshProjectData;
  window.deleteSubmission = deleteSubmission;
  window.exportProjectReport = exportProjectReport;
  window.viewProjectTimeline = viewProjectTimeline;
  window.viewProjectDetails = viewProjectDetails;
  window.viewSubmission = viewSubmission;
  window.viewSubmissionHistory = viewSubmissionHistory;
  window.manageMilestones = manageMilestones;
  window.showSubmissionReviewCenter = showSubmissionReviewCenter;
  window.rejectSubmission = rejectSubmission;
  window.loadMilestoneSubmissions = loadMilestoneSubmissions;
  window.filterSubmissions = filterSubmissions;
  window.refreshSubmissions = refreshSubmissions;
  window.openMilestoneSubmissionModal = openMilestoneSubmissionModal;
  window.closeMilestoneSubmissionModal = closeMilestoneSubmissionModal;
  window.rejectMilestoneSubmission = rejectMilestoneSubmission;
  window.submitToMPMECSecretariat = submitToMPMECSecretariat;
  window.showSubmissionHistoryAnalytics = showSubmissionHistoryAnalytics;
  window.exportAnalyticsReport = exportAnalyticsReport;
  window.refreshAnalytics = refreshAnalytics;
  window.updateProjectStatus = updateProjectStatus;
  window.updateMilestoneStatus = updateMilestoneStatus;
  window.processSubmissionStatusChange = processSubmissionStatusChange;
  window.showNotificationBadge = showNotificationBadge;
  window.hideNotificationBadge = hideNotificationBadge;
  window.rejectMilestoneSubmissionWithLifecycle = rejectMilestoneSubmissionWithLifecycle;
  window.submitToMPMECSecretariatWithLifecycle = submitToMPMECSecretariatWithLifecycle;
  window.toggleMilestonesSection = function(sectionId) {
    console.log('ðŸŽ¯ DEBUG: toggleMilestonesSection called for:', sectionId);
    const content = document.getElementById(sectionId + '-content');
    const icon = document.getElementById(sectionId + '-icon');
    
    if (content && icon) {
      const isExpanded = content.classList.contains('expanded');
      if (isExpanded) {
        content.classList.remove('expanded');
        icon.classList.remove('rotated');
      } else {
        content.classList.add('expanded');
        icon.classList.add('rotated');
      }
    }
  };
  
  // Export missing functions to window
  window.showSubmissionsLoading = showSubmissionsLoading;
  window.showEmptySubmissionsState = showEmptySubmissionsState;
  window.toggleProjectSection = toggleProjectSection;
  window.toggleSubmissionReviewCenter = toggleSubmissionReviewCenter;
  window.viewProjectDetails = viewProjectDetails;
  
  // Additional functions for new design
  window.exportProgressReport = function() {
    console.log('Exporting progress report...');
    // Implementation for progress report export
    showNotification('info', 'Export Started', 'Progress report export has been initiated.');
  };
  
  window.filterByCard = function(filterType) {
    console.log('Filtering by card:', filterType);
    // Implementation for summary card filtering
    applyFilters();
  };
  
  window.applyFilters = function() {
    console.log('Applying filters...');
    // Implementation for applying filters
    filterProjects();
  };

  // ===== ENHANCED PROJECT TIMELINE FUNCTIONS =====
  
  // Toggle project sections (collapsible functionality) - Matching submit-update.astro approach
  function toggleProjectSection(sectionName) {
    console.log('ðŸŽ¯ DEBUG: toggleProjectSection called for:', sectionName);
    const sectionContent = document.getElementById(`${sectionName}Section`);
    const chevron = document.querySelector(`[data-section="${sectionName}"]`);
    
    console.log('ðŸ“¦ Elements found:', { 
      sectionContent: !!sectionContent, 
      chevron: !!chevron,
      sectionId: `${sectionName}Section`,
      currentClasses: sectionContent ? sectionContent.className : 'not found'
    });
    
    if (!sectionContent || !chevron) {
      console.error('âŒ Section or chevron not found for:', sectionName);
      return;
    }
    
    const isExpanded = sectionContent.classList.contains('expanded');
    console.log('ðŸ“Š Current state - isExpanded:', isExpanded);
    
    if (isExpanded) {
      // Collapse - Only toggle classes, let CSS handle the styling
      console.log('ðŸ”’ Collapsing section:', sectionName);
      sectionContent.classList.remove('expanded');
      chevron.classList.remove('rotated');
      console.log('ðŸ”’ Section collapsed');
      
    } else {
      // Expand - Only toggle classes, let CSS handle the styling
      console.log('ðŸ”“ Expanding section:', sectionName);
      sectionContent.classList.add('expanded');
      chevron.classList.add('rotated');
      
      // Load content if needed
      if (sectionName === 'timeline') {
        loadModernTimeline(true);
      } else if (sectionName === 'milestoneSummary') {
        displayMilestoneSummary();
      } else if (sectionName === 'projectMilestones') {
        displayProjectMilestones();
      }
      
      console.log('ðŸ”“ Section expanded');
    }
  }
  
  // Load modern timeline for the selected project
  async function loadModernTimeline(forceLoad = false) {
    if (!selectedProject) {
      console.log('No project selected for timeline');
      hideModernTimeline();
      return;
    }
    
    // Check if timeline section is visible
    const timelineSection = document.getElementById('timelineSection');
    const modernTimeline = document.getElementById('modernTimeline');
    if (!timelineSection || !modernTimeline) {
      console.log('â¸ï¸ Timeline elements not found, skipping load');
      return;
    }
    
    // Check if section is expanded (unless forced)
    const isExpanded = timelineSection.classList.contains('expanded');
    if (!isExpanded && !forceLoad) {
      console.log('â¸ï¸ Timeline section not expanded, skipping load');
      return;
    }
    
    try {
      console.log('ðŸš€ Loading modern timeline for project:', selectedProject.id);
      
      // Show loading state
      showTimelineLoading();
      
      // Use milestones from selectedProject or fetch from API
      let milestones = [];
      if (selectedProject.milestones && Array.isArray(selectedProject.milestones)) {
        milestones = selectedProject.milestones;
      } else {
        // Try to fetch from API if available
        const token = localStorage.getItem('token');
        if (token) {
          const response = await fetch(`${API_URL}/projects/${selectedProject.id}/milestones`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.milestones) {
              milestones = data.milestones;
            }
          }
        }
      }
      
      if (milestones.length > 0) {
        console.log('âœ… Timeline milestones loaded:', milestones.length);
        
        // Process milestones with enhanced status detection
        const processedMilestones = processMilestonesWithStatus(milestones);
        
        console.log('ðŸ“Š Processed milestones for timeline:', processedMilestones.map(m => ({
          title: m.title,
          status: m.status,
          isDelayed: m.isDelayed,
          dueDate: m.dueDate,
          overallProgress: m.overallProgress
        })));
        
        // Render modern timeline
        await renderModernTimeline(selectedProject, processedMilestones);
      } else {
        console.log('âš ï¸ No milestones found for project timeline');
        hideModernTimeline();
      }
    } catch (error) {
      console.error('ðŸ’¥ Error loading modern timeline:', error);
      hideModernTimeline();
    }
  }
  
  // Process milestones with enhanced status detection
  function processMilestonesWithStatus(milestones) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    return milestones.map(milestone => {
      let status = milestone.status || 'pending';
      
      // Enhanced delayed detection using lifecycle rules
      if (milestone.dueDate && status !== 'completed' && status !== 'under_approval' && status !== 'revision_request') {
        const milestoneDate = new Date(milestone.dueDate);
        milestoneDate.setHours(0, 0, 0, 0);
        
        if (milestoneDate < today && status === 'pending') {
          status = 'delayed';
          console.log(`ðŸš¨ Milestone "${milestone.title}" marked as delayed (due: ${milestone.dueDate})`);
        }
      }
      
      // Calculate overall milestone progress
      const timelineProgress = milestone.timelineProgress || 0;
      const budgetProgress = milestone.budgetProgress || 0;
      const physicalProgress = milestone.physicalProgress || 0;
      const overallProgress = (timelineProgress + budgetProgress + physicalProgress) / 3;
      
      return { 
        ...milestone, 
        status,
        isDelayed: status === 'delayed',
        overallProgress: overallProgress
      };
    });
  }
  
  // Show timeline loading state
  function showTimelineLoading() {
    const loading = document.getElementById('timelineLoading');
    const timeline = document.getElementById('modernTimeline');
    
    if (loading) loading.classList.remove('hidden');
    if (timeline) timeline.classList.add('hidden');
  }
  
  // Show modern timeline content
  function showModernTimelineContent() {
    const loading = document.getElementById('timelineLoading');
    const timeline = document.getElementById('modernTimeline');
    
    if (loading) loading.classList.add('hidden');
    if (timeline) timeline.classList.remove('hidden');
  }
  
  // Hide entire timeline section
  function hideModernTimeline() {
    const container = document.getElementById('modernTimelineContainer');
    if (container) {
      container.innerHTML = `
        <div class="flex items-center justify-center py-12 text-gray-500">
          <div class="text-center">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="font-medium">No timeline data available</p>
            <p class="text-sm">Select a project with milestones to view timeline</p>
          </div>
        </div>
      `;
    }
  }
  
  // Render modern timeline for a project - Complete implementation
  async function renderModernTimeline(project, processedMilestones) {
    try {
      const startDateSpan = document.getElementById('timelineStartDate');
      const targetDateSpan = document.getElementById('timelineTargetDate');
      const actualDateSpan = document.getElementById('timelineActualDate');
      const expectedDaysSpan = document.getElementById('timelineExpectedDays');
      const milestonesContainer = document.getElementById('timelineMilestonesContainer');
      const progressLine = document.getElementById('progressLine');
      
      if (!startDateSpan || !targetDateSpan || !actualDateSpan || !expectedDaysSpan || !milestonesContainer || !progressLine) {
        console.error('Modern timeline elements not found');
        hideModernTimeline();
        return;
      }
    
      // Show timeline content
      showModernTimelineContent();
      
      // Update date labels
      if (project.startDate) {
        startDateSpan.textContent = new Date(project.startDate).toLocaleDateString();
      }
      if (project.targetCompletionDate || project.targetDateOfCompletion || project.endDate) {
        targetDateSpan.textContent = new Date(project.targetCompletionDate || project.targetDateOfCompletion || project.endDate).toLocaleDateString();
      }
      
      // Update actual completion date
      if (project.completionDate || project.actualCompletionDate) {
        actualDateSpan.textContent = new Date(project.completionDate || project.actualCompletionDate).toLocaleDateString();
      } else {
        actualDateSpan.textContent = 'â€“';
      }
      
      // Update expected days
      if (project.expectedDaysOfCompletion) {
        expectedDaysSpan.textContent = `${project.expectedDaysOfCompletion} days`;
      } else {
        expectedDaysSpan.textContent = 'â€“';
      }
      
      console.log('ðŸŽ¯ Rendering complete modern timeline:', {
        project: project.name,
        milestones: processedMilestones.length,
        delayed: processedMilestones.filter(m => m.isDelayed).length
      });
      
      // Clear existing content
      milestonesContainer.innerHTML = '';
      const percentageContainer = document.getElementById('milestonePercentageIndicators');
      if (percentageContainer) {
        percentageContainer.innerHTML = '';
      }
      
      const dateRuler = document.getElementById('dateRuler');
      if (dateRuler) {
        dateRuler.innerHTML = '';
      }
      
      let percentageRuler = document.getElementById('percentageRuler');
      if (percentageRuler) {
        percentageRuler.innerHTML = '';
      }

      const verticalConnectors = document.getElementById('verticalConnectors');
      if (verticalConnectors) {
        verticalConnectors.innerHTML = '';
      }

      // Project date calculations
      const projectStart = new Date(project.startDate);
      const projectEnd = new Date(project.targetCompletionDate || project.targetDateOfCompletion || project.endDate);
      const totalDuration = projectEnd - projectStart;
      
      // Calculate optimal timeline width based on milestone spacing (like submit-update.astro)
      const minSpacing = 120; // Minimum spacing between milestone circles
      const totalMilestones = processedMilestones.length * 2; // Each milestone has start + end
      const baseWidth = 800; // Base minimum width
      
      // Calculate positions to check for clustering
      let positions = [];
      processedMilestones.forEach((milestone, index) => {
        // Add due date position
        const dueDate = new Date(milestone.dueDate || milestone.deadline);
        const duePosition = ((dueDate - projectStart) / totalDuration) * 100;
        positions.push(Math.max(0, Math.min(100, duePosition)));
        
        // Add start date position
        let startDate = milestone.startDate;
        if (!startDate && index === 0) {
          startDate = project.startDate;
        } else if (!startDate && index > 0) {
          const previousDueDate = new Date(processedMilestones[index - 1].dueDate || processedMilestones[index - 1].deadline);
          previousDueDate.setDate(previousDueDate.getDate() + 1);
          startDate = previousDueDate.toISOString().split('T')[0];
        }
        
        if (startDate) {
          const startMilestoneDate = new Date(startDate);
          const startPosition = ((startMilestoneDate - projectStart) / totalDuration) * 100;
          positions.push(Math.max(0, Math.min(100, startPosition)));
        }
      });
      
      // Sort positions and check for clustering
      positions.sort((a, b) => a - b);
      let maxCluster = 1;
      let currentCluster = 1;
      let clusteredPairs = 0;
      
      for (let i = 1; i < positions.length; i++) {
        const gap = positions[i] - positions[i-1];
        if (gap < 10) { // Less than 10% apart
          currentCluster++;
          clusteredPairs++;
        } else {
          maxCluster = Math.max(maxCluster, currentCluster);
          currentCluster = 1;
        }
      }
      maxCluster = Math.max(maxCluster, currentCluster);
      
      // Calculate required width with expansion
      const clusterMultiplier = Math.max(4, maxCluster * 3);
      const baseExpansion = clusteredPairs > 0 ? 800 : 400;
      const requiredWidth = Math.max(baseWidth + baseExpansion, totalMilestones * minSpacing * clusterMultiplier + 800);
      const forcedMinWidth = processedMilestones.length > 1 ? 1600 : baseWidth;
      const finalWidth = Math.max(requiredWidth, forcedMinWidth);
      
      // Apply timeline expansion if needed
      if (finalWidth > baseWidth) {
        console.log(`ðŸš€ Expanding timeline due to clustering - Final Width: ${finalWidth}px`);
        
        const timelineContainer = milestonesContainer.parentElement; // The h-20 container
        const timelineSection = timelineContainer ? timelineContainer.parentElement : null; // The bg-gradient container
        
        // Apply to main timeline container
        if (timelineContainer) {
          timelineContainer.style.minWidth = `${finalWidth}px`;
          timelineContainer.style.width = `${finalWidth}px`;
        }
        
        // Apply horizontal scrolling to the timeline content container
        if (timelineSection) {
          timelineSection.style.overflowX = 'auto';
          timelineSection.style.overflowY = 'visible';
        }
        
        // Expand ruler containers
        if (dateRuler) {
          dateRuler.style.minWidth = `${finalWidth}px`;
          dateRuler.style.width = `${finalWidth}px`;
          if (dateRuler.parentElement) {
            dateRuler.parentElement.style.minWidth = `${finalWidth}px`;
            dateRuler.parentElement.style.width = `${finalWidth}px`;
          }
        }
        
        if (percentageRuler) {
          percentageRuler.style.minWidth = `${finalWidth}px`;
          percentageRuler.style.width = `${finalWidth}px`;
          if (percentageRuler.parentElement) {
            percentageRuler.parentElement.style.minWidth = `${finalWidth}px`;
            percentageRuler.parentElement.style.width = `${finalWidth}px`;
          }
        }
        
        if (percentageContainer) {
          percentageContainer.style.minWidth = `${finalWidth}px`;
          percentageContainer.style.width = `${finalWidth}px`;
        }
        
        // Adjust progress line alignment
        const progressLine = document.getElementById('progressLine');
        if (progressLine) {
          progressLine.style.left = '32px';
          progressLine.style.right = 'auto';
          progressLine.style.maxWidth = `${finalWidth - 64}px`;
          progressLine.classList.remove('left-8');
        }
      }
      
      // Generate date ruler with 5-day intervals
      generateDateRuler(projectStart, projectEnd, dateRuler, finalWidth);
      
      // Generate percentage ruler with 5% intervals
      generatePercentageRuler(percentageRuler, finalWidth);
      
      // Generate vertical connectors
      generateVerticalConnectors(verticalConnectors, finalWidth);
      
      // Use actual project overall progress instead of calculating from milestones
      const overallProgress = parseFloat(project.progress?.overall || project.progress?.overallProgress || project.overallProgress || 0);
      
      // Update project center info
      const projectNameDisplay = document.getElementById('projectNameDisplay');
      const projectProgressDisplay = document.getElementById('projectProgressDisplay');
      if (projectNameDisplay && projectProgressDisplay) {
        projectNameDisplay.textContent = project.name || project.title || 'Project';
        projectProgressDisplay.textContent = `${overallProgress.toFixed(1)}%`;
      }
      
      // Animate progress line
      setTimeout(() => {
        progressLine.style.width = `${Math.min(overallProgress, 100)}%`;
      }, 300);
      
      // Render enhanced milestone dots with hover functionality (both start and due dates)
      processedMilestones.forEach((milestone, index) => {
        // Create due date dot (existing logic)
        if (milestone.dueDate || milestone.deadline) {
          const milestoneDate = new Date(milestone.dueDate || milestone.deadline);
          const timePosition = ((milestoneDate - projectStart) / totalDuration) * 100;
          const clampedPosition = Math.max(0, Math.min(100, timePosition));
          
          console.log(`ðŸŽ¯ Creating due date milestone: ${milestone.title}`, {
            calculatedPosition: clampedPosition.toFixed(1) + '%',
            status: milestone.status,
            progress: milestone.overallProgress?.toFixed(1) + '%'
          });
          
          // Create enhanced milestone element
          const milestoneElement = document.createElement('div');
          milestoneElement.className = 'milestone-dot absolute cursor-pointer transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 hover:scale-125';
          milestoneElement.style.left = `calc(32px + ${clampedPosition}% * (100% - 64px) / 100%)`;
          milestoneElement.style.top = '50%';
          milestoneElement.style.width = '32px';
          milestoneElement.style.height = '32px';
          milestoneElement.style.borderRadius = '50%';
          milestoneElement.style.border = '4px solid white';
          milestoneElement.style.zIndex = '20';
          
          // Store milestone data
          milestoneElement.setAttribute('data-milestone', JSON.stringify(milestone));
          
          // Apply status-specific styling (LGU-IU IOO Gold Theme)
          switch (milestone.status) {
            case 'completed':
              milestoneElement.style.background = 'linear-gradient(135deg, #10b981, #059669)';
              milestoneElement.style.boxShadow = '0 6px 20px rgba(16, 185, 129, 0.3), 0 0 0 3px rgba(16, 185, 129, 0.2)';
              break;
            case 'ongoing':
              milestoneElement.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
              milestoneElement.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.3), 0 0 0 3px rgba(59, 130, 246, 0.2)';
              break;
            case 'pending':
              milestoneElement.style.background = 'linear-gradient(135deg, #eab308, #ca8a04)'; // Gold theme
              milestoneElement.style.boxShadow = '0 6px 20px rgba(234, 179, 8, 0.3), 0 0 0 3px rgba(234, 179, 8, 0.2)';
              break;
            case 'delayed':
              milestoneElement.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
              milestoneElement.style.boxShadow = '0 6px 20px rgba(239, 68, 68, 0.4), 0 0 0 3px rgba(239, 68, 68, 0.3)';
              break;
            default:
              milestoneElement.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
              milestoneElement.style.boxShadow = '0 6px 20px rgba(107, 114, 128, 0.3), 0 0 0 3px rgba(107, 114, 128, 0.2)';
          }
          
          // Add hover events
          milestoneElement.addEventListener('mouseenter', (e) => showMilestoneTooltip(e, milestone));
          milestoneElement.addEventListener('mouseleave', hideMilestoneTooltip);
          milestoneElement.addEventListener('click', (e) => openMilestoneDetails(milestone));
          
          milestonesContainer.appendChild(milestoneElement);
          
          // Create percentage indicator for due date milestone
          const percentageIndicator = document.createElement('div');
          percentageIndicator.className = 'milestone-percentage-indicator';
          
          const indicatorContainer = document.createElement('div');
          indicatorContainer.style.position = 'absolute';
          indicatorContainer.style.left = `calc(32px + ${clampedPosition}% * (100% - 64px) / 100%)`;
          indicatorContainer.style.transform = 'translateX(-50%)';
          indicatorContainer.style.top = '0';
          indicatorContainer.style.display = 'flex';
          indicatorContainer.style.flexDirection = 'column';
          indicatorContainer.style.alignItems = 'center';
          indicatorContainer.style.zIndex = '15';
          
          // Create tick mark
          const tickMark = document.createElement('div');
          tickMark.style.width = '2px';
          tickMark.style.height = '8px';
          tickMark.style.marginBottom = '2px';
          
          // Set tick color based on milestone status (LGU-IU IOO theme)
          switch (milestone.status) {
            case 'completed': tickMark.style.background = '#10b981'; break;
            case 'ongoing': tickMark.style.background = '#3b82f6'; break;
            case 'pending': tickMark.style.background = '#eab308'; break; // Gold
            case 'delayed': tickMark.style.background = '#ef4444'; break;
            default: tickMark.style.background = '#6b7280';
          }
          
          // Create percentage label
          const percentageLabel = document.createElement('span');
          percentageLabel.style.fontSize = '10px';
          percentageLabel.style.fontWeight = '700';
          percentageLabel.style.color = '#1f2937';
          percentageLabel.style.backgroundColor = 'white';
          percentageLabel.style.padding = '1px 4px';
          percentageLabel.style.borderRadius = '3px';
          percentageLabel.style.border = '1px solid #e5e7eb';
          percentageLabel.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
          percentageLabel.style.whiteSpace = 'nowrap';
          percentageLabel.textContent = `${Math.round(clampedPosition)}%`;
          
          // Assemble the indicator
          indicatorContainer.appendChild(tickMark);
          indicatorContainer.appendChild(percentageLabel);
          percentageIndicator.appendChild(indicatorContainer);
          
          // Add to percentage indicators container
          if (percentageContainer) {
            percentageContainer.appendChild(percentageIndicator);
          }
        }
        
        // Create start date dot (new logic)
        let startDate = milestone.startDate;
        
        // Generate start date if not provided
        if (!startDate && index === 0) {
          // First milestone starts at project start
          const projectStartDate = new Date(project.startDate);
          startDate = projectStartDate.toISOString().split('T')[0];
          console.log(`ðŸ“… First milestone start date set to project start:`, startDate);
        } else if (!startDate && index > 0) {
          // Subsequent milestones start when previous milestone should end (add 1 day)
          const previousDueDate = new Date(processedMilestones[index - 1].dueDate || processedMilestones[index - 1].deadline);
          previousDueDate.setDate(previousDueDate.getDate() + 1);
          startDate = previousDueDate.toISOString().split('T')[0];
          console.log(`ðŸ“… Milestone ${index} start date set to day after previous due date:`, startDate);
        }
        
        if (startDate) {
          const startMilestoneDate = new Date(startDate);
          const startPosition = ((startMilestoneDate - projectStart) / totalDuration) * 100;
          const startClampedPosition = Math.max(0, Math.min(100, startPosition));
          
          console.log(`ðŸŽ¯ Creating start date milestone: ${milestone.title}`, {
            startMilestoneDate: startMilestoneDate.toISOString(),
            calculatedPosition: startClampedPosition.toFixed(1) + '%',
            status: milestone.status,
            startDate: startDate
          });
          
          // Create start date milestone dot
          const startMilestoneElement = document.createElement('div');
          startMilestoneElement.className = 'milestone-dot start-date absolute cursor-pointer transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 hover:scale-125';
          startMilestoneElement.style.left = `calc(32px + ${startClampedPosition}% * (100% - 64px) / 100%)`;
          startMilestoneElement.style.top = '50%';
          startMilestoneElement.style.width = '32px';
          startMilestoneElement.style.height = '32px';
          startMilestoneElement.style.borderRadius = '50%';
          startMilestoneElement.style.border = '4px solid white';
          startMilestoneElement.style.zIndex = '20';
          
          // Store milestone data with start date flag
          startMilestoneElement.setAttribute('data-milestone', JSON.stringify({...milestone, isStartDate: true, startDate: startDate}));
          
          // Apply status-specific styling (LGU-IU IOO Gold Theme) - same as due date
          switch (milestone.status) {
            case 'completed':
              startMilestoneElement.style.background = 'linear-gradient(135deg, #10b981, #059669)';
              startMilestoneElement.style.boxShadow = '0 6px 20px rgba(16, 185, 129, 0.4), 0 0 0 3px rgba(16, 185, 129, 0.3)';
              break;
            case 'ongoing':
              startMilestoneElement.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
              startMilestoneElement.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.4), 0 0 0 3px rgba(59, 130, 246, 0.3)';
              break;
            case 'pending':
              startMilestoneElement.style.background = 'linear-gradient(135deg, #eab308, #ca8a04)'; // Gold theme
              startMilestoneElement.style.boxShadow = '0 6px 20px rgba(234, 179, 8, 0.4), 0 0 0 3px rgba(234, 179, 8, 0.3)';
              break;
            case 'delayed':
              startMilestoneElement.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
              startMilestoneElement.style.boxShadow = '0 6px 20px rgba(239, 68, 68, 0.4), 0 0 0 3px rgba(239, 68, 68, 0.3)';
              break;
            default:
              startMilestoneElement.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
              startMilestoneElement.style.boxShadow = '0 6px 20px rgba(107, 114, 128, 0.3), 0 0 0 3px rgba(107, 114, 128, 0.2)';
          }
          
          // Add hover events for start date
          startMilestoneElement.addEventListener('mouseenter', (e) => showMilestoneTooltip(e, {...milestone, isStartDate: true, startDate: startDate}));
          startMilestoneElement.addEventListener('mouseleave', hideMilestoneTooltip);
          startMilestoneElement.addEventListener('click', (e) => {
            e.stopPropagation();
            console.log('Start date milestone clicked:', milestone.title);
            openMilestoneDetails({...milestone, isStartDate: true, startDate: startDate});
          });
          
          milestonesContainer.appendChild(startMilestoneElement);
          
          // Create start date percentage indicator
          const startPercentageIndicator = document.createElement('div');
          startPercentageIndicator.className = 'milestone-percentage-indicator start-date';
          
          const startIndicatorContainer = document.createElement('div');
          startIndicatorContainer.style.position = 'absolute';
          startIndicatorContainer.style.left = `calc(32px + ${startClampedPosition}% * (100% - 64px) / 100%)`;
          startIndicatorContainer.style.transform = 'translateX(-50%)';
          startIndicatorContainer.style.top = '0';
          startIndicatorContainer.style.display = 'flex';
          startIndicatorContainer.style.flexDirection = 'column';
          startIndicatorContainer.style.alignItems = 'center';
          startIndicatorContainer.style.zIndex = '15';
          
          // Create tick mark for start date
          const startTickMark = document.createElement('div');
          startTickMark.style.width = '2px';
          startTickMark.style.height = '8px';
          startTickMark.style.marginBottom = '2px';
          
          // Set tick color based on milestone status (LGU-IU IOO theme)
          switch (milestone.status) {
            case 'completed': startTickMark.style.background = '#10b981'; break;
            case 'ongoing': startTickMark.style.background = '#3b82f6'; break;
            case 'pending': startTickMark.style.background = '#eab308'; break; // Gold
            case 'delayed': startTickMark.style.background = '#ef4444'; break;
            default: startTickMark.style.background = '#6b7280';
          }
          
          // Create percentage label for start date
          const startPercentageLabel = document.createElement('span');
          startPercentageLabel.style.fontSize = '9px'; // Slightly smaller for start date
          startPercentageLabel.style.fontWeight = '600';
          startPercentageLabel.style.color = '#4b5563';
          startPercentageLabel.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
          startPercentageLabel.style.padding = '1px 3px';
          startPercentageLabel.style.borderRadius = '3px';
          startPercentageLabel.style.border = '1px solid #d1d5db';
          startPercentageLabel.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
          startPercentageLabel.style.whiteSpace = 'nowrap';
          startPercentageLabel.textContent = `${Math.round(startClampedPosition)}%`;
          
          // Assemble the start indicator
          startIndicatorContainer.appendChild(startTickMark);
          startIndicatorContainer.appendChild(startPercentageLabel);
          startPercentageIndicator.appendChild(startIndicatorContainer);
          
          // Add to percentage indicators container
          if (percentageContainer) {
            percentageContainer.appendChild(startPercentageIndicator);
          }
        }
      });
      
    } catch (error) {
      console.error('Error rendering modern timeline:', error);
      hideModernTimeline();
    }
  }
  
  // Refresh project timeline
  function refreshProjectTimeline() {
    if (selectedProject) {
      loadModernTimeline(true);
    }
  }

  // Generate date ruler above timeline with 5-day intervals
  function generateDateRuler(projectStart, projectEnd, dateRuler, finalWidth) {
    if (!finalWidth || isNaN(finalWidth) || finalWidth < 800) {
      finalWidth = 800;
    }
    
    const totalDuration = projectEnd - projectStart;
    const totalDays = Math.ceil(totalDuration / (1000 * 60 * 60 * 24));
    
    console.log('ðŸ“… Generating date ruler with 5-day intervals:', {
      start: projectStart.toLocaleDateString(),
      end: projectEnd.toLocaleDateString(),
      totalDays: totalDays
    });
    
    const dateMarkers = [];
    
    // Generate markers every 5 days
    for (let day = 0; day <= totalDays; day += 5) {
      const currentDate = new Date(projectStart.getTime() + (day * 24 * 60 * 60 * 1000));
      const position = (day / totalDays) * 100;
      
      const isKey = day === 0 || day === totalDays || day % 10 === 0;
      
      dateMarkers.push({
        position: Math.min(position, 100),
        date: currentDate,
        isKey: isKey,
        day: day
      });
    }
    
    // Ensure we always have the end date at exactly 100%
    const lastMarker = dateMarkers[dateMarkers.length - 1];
    if (lastMarker.position < 100) {
      dateMarkers.push({
        position: 100,
        date: projectEnd,
        isKey: true,
        day: totalDays
      });
    }
    
    dateMarkers.forEach(marker => {
      const dateMarker = document.createElement('div');
      dateMarker.style.position = 'absolute';
      dateMarker.style.left = `calc(32px + ${marker.position}% * (100% - 64px) / 100%)`;
      dateMarker.style.transform = 'translateX(-50%)';
      dateMarker.style.display = 'flex';
      dateMarker.style.flexDirection = 'column';
      dateMarker.style.alignItems = 'center';
      dateMarker.style.bottom = '0';
      
      // Create date label
      const dateLabel = document.createElement('div');
      dateLabel.style.fontSize = marker.isKey ? '10px' : '9px';
      dateLabel.style.fontWeight = marker.isKey ? '600' : '500';
      dateLabel.style.color = marker.isKey ? '#1f2937' : '#6b7280';
      dateLabel.style.backgroundColor = 'white';
      dateLabel.style.padding = marker.isKey ? '2px 6px' : '1px 4px';
      dateLabel.style.borderRadius = '4px';
      dateLabel.style.border = marker.isKey ? '1px solid #eab308' : '1px solid #e5e7eb'; // Gold theme
      dateLabel.style.boxShadow = marker.isKey ? '0 1px 3px rgba(234, 179, 8, 0.1)' : '0 1px 2px rgba(0,0,0,0.05)';
      dateLabel.style.whiteSpace = 'nowrap';
      
      if (marker.isKey) {
        dateLabel.textContent = marker.date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric'
        });
      } else {
        dateLabel.textContent = marker.date.getDate().toString();
      }
      
      // Add connecting line
      const connector = document.createElement('div');
      connector.style.width = '1px';
      connector.style.height = marker.isKey ? '8px' : '6px';
      connector.style.backgroundColor = marker.isKey ? '#eab308' : '#d1d5db'; // Gold theme
      connector.style.marginTop = '2px';
      
      dateMarker.appendChild(dateLabel);
      dateMarker.appendChild(connector);
      dateRuler.appendChild(dateMarker);
    });
  }

  // Generate percentage ruler with 5% intervals
  function generatePercentageRuler(percentageRuler, finalWidth) {
    if (!finalWidth || isNaN(finalWidth) || finalWidth < 800) {
      finalWidth = 800;
    }
    
    percentageRuler.innerHTML = '';
    
    console.log('ðŸ“Š Generating percentage ruler with 5% intervals');
    
    // Generate markers every 5%
    for (let percent = 0; percent <= 100; percent += 5) {
      const percentMarker = document.createElement('div');
      percentMarker.style.position = 'absolute';
      percentMarker.style.left = `calc(32px + ${percent}% * (100% - 64px) / 100%)`;
      percentMarker.style.transform = 'translateX(-50%)';
      percentMarker.style.display = 'flex';
      percentMarker.style.flexDirection = 'column';
      percentMarker.style.alignItems = 'center';
      percentMarker.style.top = '0';
      
      const isKey = percent === 0 || percent === 25 || percent === 50 || percent === 75 || percent === 100;
      const isMajor = percent % 10 === 0;
      
      // Create tick mark
      const tick = document.createElement('div');
      tick.style.width = isKey ? '2px' : '1px';
      tick.style.height = isKey ? '12px' : isMajor ? '8px' : '6px';
      tick.style.backgroundColor = isKey ? '#eab308' : isMajor ? '#ca8a04' : '#d1d5db'; // Gold theme
      tick.style.marginBottom = '2px';
      
      // Create percentage label
      if (isKey || isMajor) {
        const label = document.createElement('span');
        label.style.fontSize = isKey ? '11px' : '10px';
        label.style.fontWeight = isKey ? '700' : '600';
        label.style.color = isKey ? '#1f2937' : '#4b5563';
        label.style.backgroundColor = 'white';
        label.style.padding = isKey ? '2px 4px' : '1px 3px';
        label.style.borderRadius = '3px';
        label.style.border = isKey ? '1px solid #eab308' : '1px solid #e5e7eb'; // Gold theme
        label.style.boxShadow = isKey ? '0 1px 3px rgba(234, 179, 8, 0.1)' : '0 1px 2px rgba(0,0,0,0.05)';
        label.style.whiteSpace = 'nowrap';
        label.textContent = `${percent}%`;
        
        percentMarker.appendChild(tick);
        percentMarker.appendChild(label);
      } else {
        percentMarker.appendChild(tick);
      }
      
      percentageRuler.appendChild(percentMarker);
    }
  }

  // Generate vertical connectors between ruler lines
  function generateVerticalConnectors(verticalConnectors, finalWidth) {
    if (!finalWidth || isNaN(finalWidth) || finalWidth < 800) {
      finalWidth = 800;
    }
    
    verticalConnectors.innerHTML = '';
    
    console.log('ðŸ”— Generating vertical connectors with proper alignment');
    
    const keyPositions = [0, 25, 50, 75, 100];
    
    keyPositions.forEach(percent => {
      const connector = document.createElement('div');
      connector.style.position = 'absolute';
      connector.style.left = `calc(32px + ${percent}% * (100% - 64px) / 100%)`;
      connector.style.transform = 'translateX(-50%)';
      connector.style.width = '1px';
      connector.style.top = '-32px';
      connector.style.bottom = '-32px';
      connector.style.pointerEvents = 'none';
      
      if (percent === 50) {
        // Center - Gold theme
        connector.style.backgroundColor = '#eab308';
        connector.style.opacity = '0.6';
        connector.style.width = '1px';
      } else if (percent === 0 || percent === 100) {
        connector.style.backgroundColor = '#6b7280';
        connector.style.opacity = '0.4';
      } else {
        connector.style.backgroundColor = '#9ca3af';
        connector.style.opacity = '0.3';
      }
      
      verticalConnectors.appendChild(connector);
    });
  }

  // Show milestone tooltip with detailed information
  function showMilestoneTooltip(event, milestone) {
    hideMilestoneTooltip();
    
    const tooltip = document.createElement('div');
    tooltip.className = 'timeline-tooltip';
    tooltip.id = 'milestone-timeline-tooltip';
    
    // Apply LGU-IU IOO gold theme
    tooltip.style.backgroundColor = 'white';
    tooltip.style.color = '#1f2937';
    tooltip.style.border = '1px solid #d1d5db';
    tooltip.style.borderRadius = '12px';
    tooltip.style.padding = '16px 20px';
    tooltip.style.fontSize = '14px';
    tooltip.style.lineHeight = '1.5';
    tooltip.style.boxShadow = '0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04), 0 0 0 1px rgba(234, 179, 8, 0.1)';
    tooltip.style.zIndex = '1000';
    tooltip.style.minWidth = '280px';
    tooltip.style.maxWidth = '360px';
    tooltip.style.position = 'fixed';
    tooltip.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
    tooltip.style.backdropFilter = 'blur(10px)';
    tooltip.style.background = 'rgba(255, 255, 255, 0.95)';
    
    const timelineProgress = milestone.timelineProgress || 0;
    const budgetProgress = milestone.budgetProgress || 0;
    const physicalProgress = milestone.physicalProgress || 0;
    
    let delayReason = '';
    if (milestone.status === 'delayed') {
      const dueDate = new Date(milestone.dueDate);
      const today = new Date();
      const daysOverdue = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
      delayReason = `<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center gap-2 text-red-800 font-semibold text-sm mb-1">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          Milestone Overdue
        </div>
        <div class="text-red-700 text-xs">
          <div>Overdue by ${daysOverdue} day${daysOverdue !== 1 ? 's' : ''}</div>
          <div>Due: ${dueDate.toLocaleDateString()}</div>
        </div>
      </div>`;
    }
    
    // Determine if this is a start date milestone
    const isStartDate = milestone.isStartDate || false;
    const displayDate = isStartDate ? 
      new Date(milestone.startDate).toLocaleDateString() : 
      new Date(milestone.dueDate || milestone.deadline).toLocaleDateString();
    const dateLabel = isStartDate ? 'Start Date:' : 'Due Date:';
    const milestoneTypeLabel = isStartDate ? '(Start Date)' : '(Due Date)';
    
    // Calculate milestone budget (matching submit-update.astro format)
    const milestoneBudget = parseFloat(milestone.plannedBudget || milestone.budget || (milestone.weight ? (milestone.weight / 100) * 1000000 : 500000));
    const formattedBudget = milestoneBudget.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    tooltip.innerHTML = `
      <div class="flex items-start gap-3 mb-4">
        <div class="w-3 h-3 rounded-full mt-1" style="background: ${milestone.status === 'completed' ? '#10b981' : milestone.status === 'ongoing' ? '#3b82f6' : milestone.status === 'pending' ? '#eab308' : '#ef4444'}"></div>
        <div class="flex-1">
          <div class="font-bold text-lg text-gray-900 mb-1">${milestone.title || milestone.name || 'Milestone'} ${milestoneTypeLabel}</div>
          <div class="text-sm text-gray-600 mb-2">${milestone.description || 'No description available'}</div>
          <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${milestone.status === 'completed' ? '#dcfce7' : milestone.status === 'ongoing' ? '#dbeafe' : milestone.status === 'pending' ? '#fef3c7' : '#fee2e2'}; color: ${milestone.status === 'completed' ? '#166534' : milestone.status === 'ongoing' ? '#1e40af' : milestone.status === 'pending' ? '#92400e' : '#991b1b'}">
            ${milestone.status.toUpperCase()}
          </div>
        </div>
      </div>
      
      <div class="space-y-3 mb-4">
        <div class="flex justify-between items-center text-sm">
          <span class="font-medium text-gray-700">${dateLabel}</span>
          <span class="text-gray-900">${displayDate}</span>
        </div>
        <div class="flex justify-between items-center text-sm">
          <span class="font-medium text-gray-700">Budget Allocation:</span>
          <span class="font-bold text-gray-900">â‚±${formattedBudget}</span>
        </div>
        <div class="flex justify-between items-center text-sm">
          <span class="font-medium text-gray-700">Overall Progress:</span>
          <span class="font-bold text-gray-900">${milestone.overallProgress?.toFixed(1) || '0.0'}%</span>
        </div>
      </div>
      
      <div class="grid grid-cols-3 gap-3 mb-4">
        <div class="text-center">
          <div class="text-xs font-medium text-gray-600 mb-1">Timeline</div>
          <div class="text-lg font-bold" style="color: #3b82f6">${timelineProgress.toFixed(1)}%</div>
        </div>
        <div class="text-center">
          <div class="text-xs font-medium text-gray-600 mb-1">Budget</div>
          <div class="text-lg font-bold" style="color: #eab308">${budgetProgress.toFixed(1)}%</div>
        </div>
        <div class="text-center">
          <div class="text-xs font-medium text-gray-600 mb-1">Physical</div>
          <div class="text-lg font-bold" style="color: #10b981">${physicalProgress.toFixed(1)}%</div>
        </div>
      </div>
      
      ${delayReason}
      
      <div class="text-xs text-gray-500 mt-4 pt-3 border-t border-gray-200">
        ${isStartDate ? 'Milestone start date marker' : 'Click milestone for detailed view'}
      </div>
    `;
    
    // Position tooltip
    const rect = event.target.getBoundingClientRect();
    tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
    tooltip.style.top = `${rect.top - 10}px`;
    tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
    
    document.body.appendChild(tooltip);
    
    // Adjust position if tooltip goes off screen
    const tooltipRect = tooltip.getBoundingClientRect();
    if (tooltipRect.left < 10) {
      tooltip.style.left = '10px';
      tooltip.style.transform = 'translateY(-100%)';
    } else if (tooltipRect.right > window.innerWidth - 10) {
      tooltip.style.left = `${window.innerWidth - 10}px`;
      tooltip.style.transform = 'translateX(-100%) translateY(-100%)';
    }
  }

  // Hide milestone tooltip
  function hideMilestoneTooltip() {
    const tooltip = document.getElementById('milestone-timeline-tooltip');
    if (tooltip) {
      tooltip.remove();
    }
  }

  // Open milestone details (placeholder for future implementation)
  function openMilestoneDetails(milestone) {
    console.log('Opening milestone details:', milestone);
    // Future: Open milestone details modal
  }
  
  // Display milestone summary
  function displayMilestoneSummary() {
    const summaryContainer = document.getElementById('milestoneSummaryContainer');
    
    // Get milestones from selectedProject
    const milestones = selectedProject?.milestones || [];
    
    if (!summaryContainer || !milestones || milestones.length === 0) {
      if (summaryContainer) {
        summaryContainer.innerHTML = '<p class="text-gray-600">No milestone data available.</p>';
      }
      return;
    }

    // Calculate milestone statistics
    const pendingMilestones = milestones.filter(m => m.status?.toLowerCase() === 'pending');
    const underApprovalMilestones = milestones.filter(m => m.status?.toLowerCase() === 'under_approval');
    const completedMilestones = milestones.filter(m => m.status?.toLowerCase() === 'completed');
    const delayedMilestones = milestones.filter(m => m.status?.toLowerCase() === 'delayed');
    const revisionRequestMilestones = milestones.filter(m => m.status?.toLowerCase() === 'revision_requested');

    // Calculate weights
    const pendingWeight = pendingMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const underApprovalWeight = underApprovalMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const completedWeight = completedMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const delayedWeight = delayedMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const revisionRequestWeight = revisionRequestMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const totalWeight = milestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);

    // Calculate total budget from selected project
    const totalBudget = parseFloat(selectedProject?.totalBudget || 0);

    const summaryHTML = `
      <div class="bg-gradient-to-r from-yellow-50 to-gray-50 rounded-xl p-6 border border-yellow-200">
        <h4 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-3">
          <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          Milestone Status Overview
        </h4>
        
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="text-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105">
            <div class="text-2xl font-bold text-blue-600 mb-1">${pendingMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Pending</div>
            <div class="text-xs text-gray-500">${pendingWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105">
            <div class="text-2xl font-bold text-yellow-600 mb-1">${underApprovalMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Under Approval</div>
            <div class="text-xs text-gray-500">${underApprovalWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105">
            <div class="text-2xl font-bold text-red-600 mb-1">${delayedMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Delayed</div>
            <div class="text-xs text-gray-500">${delayedWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105">
            <div class="text-2xl font-bold text-orange-600 mb-1">${revisionRequestMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Revision</div>
            <div class="text-xs text-gray-500">${revisionRequestWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105">
            <div class="text-2xl font-bold text-green-600 mb-1">${completedMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Completed</div>
            <div class="text-xs text-gray-500">${completedWeight.toFixed(1)}% weight</div>
          </div>
        </div>
        
        <div class="p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
          <div class="text-center">
            <div class="text-xl font-bold text-yellow-600 mb-1">â‚±${totalBudget.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Total Budget</div>
            <div class="text-xs text-gray-500">${totalWeight.toFixed(1)}% total weight</div>
          </div>
        </div>
      </div>
    `;
    
    summaryContainer.innerHTML = summaryHTML;
    console.log('Milestone summary displayed successfully');
  }

  // Get EIU data from project (matching ProjectDetailsModal.astro logic)
  function getEIUData(project, field) {
    if (!project) return 'â€“';
    
    // Try multiple sources for EIU data
    let eiuData = project.eiuPersonnel || project.assignedEIU || project.User || project.eiu || project.eiuPartner;
    
    // If no direct EIU data, check if it's in the _debug object
    if (!eiuData && project._debug && project._debug.eiuPersonnel) {
      eiuData = project._debug.eiuPersonnel;
    }
    
    // Special handling for submissions module - ensure we have complete data
    if (eiuData && (!eiuData.contactNumber || !eiuData.birthdate || !eiuData.department)) {
      if (project.eiuPersonnel) {
        eiuData = {
          ...eiuData,
          ...project.eiuPersonnel,
          // Ensure all fields are properly mapped
          contactNumber: project.eiuPersonnel.contactNumber || project.eiuPersonnel.phoneNumber || eiuData.contactNumber,
          birthdate: project.eiuPersonnel.birthdate || eiuData.birthdate,
          department: project.eiuPersonnel.department || project.eiuPersonnel.externalCompanyName || eiuData.department || 'External Partner Company',
          externalCompanyName: project.eiuPersonnel.externalCompanyName || project.eiuPersonnel.department || eiuData.externalCompanyName || 'Sample Company',
          profilePicture: project.eiuPersonnel.profilePicture || eiuData.profilePicture
        };
      }
    }
    
    if (!eiuData) return 'â€“';
    
    // Extract the requested field
    switch (field) {
      case 'fullName':
        const fullName = eiuData.name || eiuData.fullName || eiuData.firstName + ' ' + eiuData.lastName || eiuData.username;
        return fullName && fullName !== '' && fullName !== 'null' ? fullName : 'â€“';
      
      case 'subrole':
        const subrole = eiuData.subRole || eiuData.subrole || eiuData.role;
        return subrole && subrole !== '' && subrole !== 'null' ? subrole : 'â€“';
      
      case 'contactNumber':
        const contact = eiuData.contactNumber || eiuData.phoneNumber || eiuData.contact || eiuData.contact_number || eiuData.phone_number;
        return contact && contact !== '' && contact !== 'null' ? contact : 'â€“';
      
      case 'department':
        const department = eiuData.department || eiuData.departmentName;
        return department && department !== '' && department !== 'null' ? department : 'â€“';
      
      case 'company':
        const company = eiuData.externalCompanyName || eiuData.company;
        return company && company !== '' && company !== 'null' ? company : 'â€“';
      
      default:
        return 'â€“';
    }
  }

  // Display project milestones (read-only view with collapsible milestone cards)
  function displayProjectMilestones() {
    const container = document.getElementById('projectMilestonesContainer');
    const counter = document.getElementById('totalMilestonesCounter');
    
    // Get milestones from selectedProject
    const milestones = selectedProject?.milestones || [];
    
    if (!container) {
      console.log('Project milestones container not found');
      return;
    }
    
    if (!milestones || milestones.length === 0) {
      container.innerHTML = '<p class="text-gray-600 text-center py-8">No milestones found for this project.</p>';
      if (counter) {
        counter.style.display = 'none';
      }
      return;
    }

    // Update counter
    if (counter) {
      counter.textContent = milestones.length;
      counter.style.display = 'inline-block';
    }

    // Sort milestones by due date
    const sortedMilestones = [...milestones].sort((a, b) => {
      const dateA = new Date(a.dueDate);
      const dateB = new Date(b.dueDate);
      return dateA - dateB;
    });

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const milestonesHTML = sortedMilestones.map(milestone => {
      const dueDate = new Date(milestone.dueDate);
      const isOverdue = dueDate < today;
      const status = milestone.status?.toLowerCase() || 'pending';
      
      // Determine status color and message
      let statusConfig = {
        color: 'yellow',
        bgColor: 'yellow-50',
        textColor: 'yellow-700',
        message: 'Pending'
      };

      switch (status) {
        case 'pending':
          statusConfig = {
            color: 'blue',
            bgColor: 'blue-50',
            textColor: 'blue-700',
            message: 'Pending'
          };
          break;
        case 'ongoing':
        case 'in_progress':
          statusConfig = {
            color: 'yellow',
            bgColor: 'yellow-50',
            textColor: 'yellow-700',
            message: 'In Progress'
          };
          break;
        case 'completed':
          statusConfig = {
            color: 'green',
            bgColor: 'green-50',
            textColor: 'green-700',
            message: 'Completed'
          };
          break;
        case 'delayed':
          statusConfig = {
            color: 'red',
            bgColor: 'red-50',
            textColor: 'red-700',
            message: 'Delayed'
          };
          break;
        case 'revision_requested':
        case 'need_revision':
          statusConfig = {
            color: 'orange',
            bgColor: 'orange-50',
            textColor: 'orange-700',
            message: 'Revision Requested'
          };
          break;
        case 'under_approval':
          statusConfig = {
            color: 'purple',
            bgColor: 'purple-50',
            textColor: 'purple-700',
            message: 'Under Approval'
          };
          break;
      }

      return `
        <!-- Individual Milestone Collapsible Card -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow-lg transition-all duration-300 hover:shadow-xl hover:border-yellow-200 hover:-translate-y-1 mb-4 overflow-hidden">
          <div class="bg-gradient-to-r from-yellow-50 to-gray-50 px-6 py-4 border-b border-yellow-200 cursor-pointer hover:from-yellow-100 hover:to-gray-100 transition-all duration-300 group" 
               onclick="toggleMilestoneCard('milestone-${milestone.id}')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600 group-hover:from-yellow-600 group-hover:to-yellow-700">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="font-bold text-black group-hover:text-yellow-800 transition-colors duration-300">${milestone.title}</h4>
                  <div class="flex flex-wrap items-center gap-3 mt-2">
                    <span class="px-3 py-1 text-xs font-medium rounded-full bg-${statusConfig.bgColor} text-${statusConfig.textColor}">${statusConfig.message}</span>
                    <span class="text-sm text-gray-600 bg-white/70 px-2 py-1 rounded-lg">Weight: ${milestone.weight || 0}%</span>
                    <span class="text-sm ${isOverdue ? 'text-red-600 font-medium bg-red-50' : 'text-gray-500 bg-gray-50'} px-2 py-1 rounded-lg">Due: ${milestone.dueDate}${isOverdue ? ' (OVERDUE)' : ''}</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-right">
                  <div class="text-sm text-gray-500 mb-1">Progress</div>
                  <div class="text-xl font-bold text-yellow-600">${milestone.progress || 0}%</div>
                </div>
                <div class="icon-container-small bg-gradient-to-br from-gray-600 to-gray-700 toggle-chevron hover:scale-110 hover:rotate-3 transition-all duration-300 border-2 border-gray-500 hover:border-gray-400 rounded-xl">
                  <svg id="milestone-${milestone.id}-icon" class="w-4 h-4 text-white transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <div id="milestone-${milestone.id}-content" class="section-content">
            <div class="p-6">
              <!-- General Information Section -->
              <div class="bg-gradient-to-r from-yellow-50 to-gray-100 rounded-xl p-6 mb-6 border border-yellow-200">
                <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  General Information
                </h5>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-4">
                  <div class="space-y-3">
                    <div class="bg-white rounded-lg p-4 border border-yellow-200">
                      <label class="block text-sm font-medium text-yellow-700 mb-1">Project Name</label>
                      <div class="text-lg font-bold text-gray-900">${selectedProject?.name || 'N/A'}</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-yellow-200">
                      <label class="block text-sm font-medium text-yellow-700 mb-1">Project Code</label>
                      <div class="text-sm font-semibold text-gray-700">${selectedProject?.projectCode || 'N/A'}</div>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div class="bg-white rounded-lg p-4 border border-yellow-200">
                      <label class="block text-sm font-medium text-yellow-700 mb-1">Total Budget Allocation (â‚±)</label>
                      <div class="text-lg font-bold text-yellow-600">${parseFloat(selectedProject?.totalBudget || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div class="bg-white rounded-lg p-4 border border-yellow-200">
                        <label class="block text-sm font-medium text-yellow-700 mb-1">Start Date</label>
                        <div class="text-sm font-semibold text-gray-700">${selectedProject?.startDate ? new Date(selectedProject.startDate).toLocaleDateString() : 'Not set'}</div>
                      </div>
                      <div class="bg-white rounded-lg p-4 border border-yellow-200">
                        <label class="block text-sm font-medium text-yellow-700 mb-1">Target Completion Date</label>
                        <div class="text-sm font-semibold text-gray-700">${selectedProject?.targetCompletionDate || selectedProject?.targetDateOfCompletion || selectedProject?.endDate ? new Date(selectedProject.targetCompletionDate || selectedProject.targetDateOfCompletion || selectedProject.endDate).toLocaleDateString() : 'Not set'}</div>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-3">
                      <div class="bg-white rounded-lg p-4 border border-yellow-200">
                        <label class="block text-sm font-medium text-yellow-700 mb-1">Actual Completion Date</label>
                        <div class="text-sm font-semibold text-gray-700">${selectedProject?.completionDate || selectedProject?.actualCompletionDate ? new Date(selectedProject.completionDate || selectedProject.actualCompletionDate).toLocaleDateString() : 'â€“'}</div>
                      </div>
                      <div class="bg-white rounded-lg p-4 border border-yellow-200">
                        <label class="block text-sm font-medium text-yellow-700 mb-1">Expected Days</label>
                        <div class="text-sm font-semibold text-gray-700">${selectedProject?.expectedDaysOfCompletion ? selectedProject.expectedDaysOfCompletion + ' days' : 'â€“'}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- EIU Partner Information Section -->
              <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 mb-6 border border-gray-200">
                <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-gray-600 to-gray-700">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                  </div>
                  EIU Partner Information
                </h5>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">EIU Full Name</label>
                    <div class="text-sm font-semibold text-gray-700">${getEIUData(selectedProject, 'fullName')}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subrole</label>
                    <div class="text-sm font-semibold text-gray-700">${getEIUData(selectedProject, 'subrole')}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                    <div class="text-sm font-semibold text-gray-700">${getEIUData(selectedProject, 'contactNumber')}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <div class="text-sm font-semibold text-gray-700">${getEIUData(selectedProject, 'department')}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <div class="text-sm font-semibold text-gray-700">${getEIUData(selectedProject, 'company')}</div>
                  </div>
                </div>
              </div>

              <!-- Milestone Information Section -->
              <div class="bg-gradient-to-r from-yellow-50 to-gray-100 rounded-xl p-6 mb-6 border border-yellow-200">
                <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-yellow-500 to-yellow-600">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                  </div>
                  Milestone Information
                </h5>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                  <div class="bg-white rounded-lg p-4 border border-yellow-200">
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Milestone Name (Item of Work)</label>
                    <div class="text-lg font-bold text-gray-900">${milestone.title || 'N/A'}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-yellow-200">
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Status</label>
                    <div class="text-sm font-semibold">
                      <span class="px-3 py-1 text-xs font-medium rounded-full bg-${statusConfig.bgColor} text-${statusConfig.textColor}">${statusConfig.message}</span>
                    </div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-yellow-200">
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Weight</label>
                    <div class="text-lg font-bold text-yellow-600">${milestone.weight || 0}%</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-yellow-200">
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Planned Budget</label>
                    <div class="text-lg font-bold text-yellow-600">â‚±${parseFloat(milestone.plannedBudget || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-yellow-200">
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Due Date</label>
                    <div class="text-sm font-semibold text-gray-700">${milestone.dueDate || 'Not set'}</div>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-yellow-200">
                  <label class="block text-sm font-medium text-yellow-700 mb-1">Description</label>
                  <div class="text-sm text-gray-600 leading-relaxed">${milestone.description || 'No description available'}</div>
                </div>
              </div>

              <!-- Timeline Division Information Section -->
              <div class="bg-gradient-to-r from-blue-50 to-gray-100 rounded-xl p-6 mb-6 border border-blue-200">
                <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-blue-500 to-blue-600">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  Timeline Division Information
                </h5>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                  <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <label class="block text-sm font-medium text-blue-700 mb-1">Weight</label>
                    <div class="text-lg font-bold text-blue-600">${milestone.timelineWeight || milestone.weight || 0}%</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <label class="block text-sm font-medium text-blue-700 mb-1">Start</label>
                    <div class="text-sm font-semibold text-gray-700">${milestone.timelineStartDate || milestone.startDate || 'Not set'}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <label class="block text-sm font-medium text-blue-700 mb-1">End</label>
                    <div class="text-sm font-semibold text-gray-700">${milestone.timelineEndDate || milestone.dueDate || 'Not set'}</div>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-blue-200">
                  <label class="block text-sm font-medium text-blue-700 mb-1">Description</label>
                  <div class="text-sm text-gray-600 leading-relaxed">${milestone.timelineDescription || milestone.description || 'No timeline description available'}</div>
                </div>
              </div>

              <!-- Budget Division Information Section -->
              <div class="bg-gradient-to-r from-green-50 to-gray-100 rounded-xl p-6 mb-6 border border-green-200">
                <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-green-500 to-green-600">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                  </div>
                  Budget Division Information
                </h5>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                  <div class="bg-white rounded-lg p-4 border border-green-200">
                    <label class="block text-sm font-medium text-green-700 mb-1">Weight</label>
                    <div class="text-lg font-bold text-green-600">${milestone.budgetWeight || milestone.weight || 0}%</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-green-200">
                    <label class="block text-sm font-medium text-green-700 mb-1">Budget</label>
                    <div class="text-lg font-bold text-green-600">â‚±${parseFloat(milestone.plannedBudget || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-green-200">
                    <label class="block text-sm font-medium text-green-700 mb-1">Funding Source</label>
                    <div class="text-sm font-semibold text-gray-700">${milestone.fundingSource || 'LOCAL FUND'}</div>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-green-200">
                  <label class="block text-sm font-medium text-green-700 mb-1">Breakdown</label>
                  <div class="text-sm text-gray-600 leading-relaxed">${milestone.budgetBreakdown || milestone.budgetDescription || 'No budget breakdown available'}</div>
                </div>
              </div>

              <!-- Physical Division Information Section -->
              <div class="bg-gradient-to-r from-purple-50 to-gray-100 rounded-xl p-6 mb-6 border border-purple-200">
                <h5 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-3">
                  <div class="icon-container-small bg-gradient-to-br from-purple-500 to-purple-600">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                  </div>
                  Physical Division Information
                </h5>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                  <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <label class="block text-sm font-medium text-purple-700 mb-1">Weight</label>
                    <div class="text-lg font-bold text-purple-600">${milestone.physicalWeight || milestone.weight || 0}%</div>
                  </div>
                  <div class="bg-white rounded-lg p-4 border border-purple-200">
                    <label class="block text-sm font-medium text-purple-700 mb-1">Proof Types</label>
                    <div class="text-sm font-semibold text-gray-700">${milestone.requiredProofs || 'Photo, Video, Excel'}</div>
                  </div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-purple-200">
                  <label class="block text-sm font-medium text-purple-700 mb-1">Description</label>
                  <div class="text-sm text-gray-600 leading-relaxed">${milestone.physicalDescription || milestone.description || 'No physical description available'}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = milestonesHTML;
    
    // Force collapse all milestones after rendering
    setTimeout(() => {
      forceCollapseAllMilestones();
    }, 50);
    setTimeout(() => {
      forceCollapseAllMilestones();
    }, 200);
    
    console.log('Project milestones displayed successfully');
  }

  // Toggle milestone card visibility (matching submit-update.astro behavior)
  function toggleMilestoneCard(milestoneId) {
    console.log('ðŸŽ¯ Toggle milestone card called:', milestoneId);
    const sectionContent = document.getElementById(`${milestoneId}-content`);
    const icon = document.getElementById(`${milestoneId}-icon`);
    
    console.log('ðŸ“¦ Elements found:', { 
      sectionContent: !!sectionContent, 
      icon: !!icon,
      currentClasses: sectionContent ? sectionContent.className : 'not found'
    });
    
    if (sectionContent) {
      const isExpanded = sectionContent.classList.contains('expanded');
      console.log('ðŸ“Š Current state - isExpanded:', isExpanded);
      
      if (isExpanded) {
        // Collapse
        console.log('ðŸ”’ Attempting to collapse...');
        sectionContent.classList.remove('expanded');
        
        // Force immediate style update
        sectionContent.style.maxHeight = '0px';
        sectionContent.style.opacity = '0';
        sectionContent.style.transform = 'translateY(-10px)';
        sectionContent.style.overflow = 'hidden';
        
        if (icon) {
          icon.classList.remove('rotated');
          icon.style.transform = 'rotate(0deg)';
        }
        
        console.log('ðŸ”’ Milestone collapsed');
        
      } else {
        // Expand - but first close all other milestones
        console.log('ðŸ”“ Attempting to expand...');
        
        // Close all other open milestone contents
        const allMilestoneContents = document.querySelectorAll('[id^="milestone-"][id$="-content"].section-content.expanded');
        const allMilestoneIcons = document.querySelectorAll('[id^="milestone-"][id$="-icon"]');
        
        console.log('ðŸ” Found milestone contents to potentially close:', allMilestoneContents.length);
        
        allMilestoneContents.forEach(content => {
          if (content.id !== sectionContent.id) {
            console.log('ðŸ”’ Auto-closing milestone:', content.id);
            content.classList.remove('expanded');
            content.style.maxHeight = '0px';
            content.style.opacity = '0';
            content.style.transform = 'translateY(-10px)';
            content.style.overflow = 'hidden';
          }
        });
        
        allMilestoneIcons.forEach(iconEl => {
          if (iconEl.id !== icon?.id) {
            console.log('ðŸ”’ Auto-rotating milestone icon:', iconEl.id);
            iconEl.classList.remove('rotated');
            iconEl.style.transform = 'rotate(0deg)';
          }
        });
        
        sectionContent.classList.add('expanded');
        
        // Ensure parent Project Milestones section is also expanded
        const parentMilestonesSection = document.getElementById('projectMilestonesSection');
        if (parentMilestonesSection && !parentMilestonesSection.classList.contains('expanded')) {
          console.log('ðŸ”“ Auto-expanding parent Project Milestones section');
          parentMilestonesSection.classList.add('expanded');
          parentMilestonesSection.style.maxHeight = 'none';
          parentMilestonesSection.style.height = 'auto';
          parentMilestonesSection.style.overflow = 'visible';
        }
        
        // Force immediate style update with unlimited height
        sectionContent.style.maxHeight = 'none';
        sectionContent.style.height = 'auto';
        sectionContent.style.opacity = '1';
        sectionContent.style.transform = 'translateY(0)';
        sectionContent.style.overflow = 'visible';
        
        if (icon) {
          icon.classList.add('rotated');
          icon.style.transform = 'rotate(180deg)';
        }
        
        console.log('ðŸ”“ Milestone expanded');
      }
    }
  }

  // Debug function to force expand all milestone containers
  window.debugExpandAllContainers = function() {
    console.log('ðŸ”§ DEBUG: Force expanding all milestone containers');
    
    // Expand parent Project Milestones section
    const parentSection = document.getElementById('projectMilestonesSection');
    if (parentSection) {
      parentSection.classList.add('expanded');
      parentSection.style.maxHeight = 'none';
      parentSection.style.height = 'auto';
      parentSection.style.overflow = 'visible';
      console.log('âœ… Parent Project Milestones section expanded');
    }
    
    // Expand milestone container
    const container = document.getElementById('projectMilestonesContainer');
    if (container) {
      container.style.maxHeight = 'none';
      container.style.height = 'auto';
      container.style.overflow = 'visible';
      console.log('âœ… Project milestones container expanded');
    }
    
    // Expand all milestone content sections
    const milestoneContents = document.querySelectorAll('[id^="milestone-"][id$="-content"]');
    console.log('ðŸ” Found milestone contents:', milestoneContents.length);
    
    milestoneContents.forEach(content => {
      content.classList.add('expanded');
      content.style.maxHeight = 'none';
      content.style.height = 'auto';
      content.style.opacity = '1';
      content.style.transform = 'translateY(0)';
      content.style.overflow = 'visible';
      console.log('âœ… Milestone content expanded:', content.id);
    });
    
    // Expand all milestone icons
    const milestoneIcons = document.querySelectorAll('[id^="milestone-"][id$="-icon"]');
    milestoneIcons.forEach(icon => {
      icon.classList.add('rotated');
      icon.style.transform = 'rotate(180deg)';
    });
    
    console.log('âœ… All containers force expanded');
  };

  // Debug function to check Project Milestones section state
  window.debugProjectMilestonesSection = function() {
    console.log('ðŸ”§ DEBUG: Checking Project Milestones section state');
    
    const section = document.getElementById('projectMilestonesSection');
    const chevron = document.querySelector('[data-section="projectMilestones"] svg');
    
    console.log('ðŸ“¦ Project Milestones Section:', {
      found: !!section,
      id: section?.id,
      classes: section?.className,
      styles: section?.style.cssText,
      computedStyles: section ? {
        maxHeight: window.getComputedStyle(section).maxHeight,
        height: window.getComputedStyle(section).height,
        opacity: window.getComputedStyle(section).opacity,
        overflow: window.getComputedStyle(section).overflow
      } : 'not found'
    });
    
    console.log('ðŸ”„ Chevron:', {
      found: !!chevron,
      transform: chevron?.style.transform,
      computedTransform: chevron ? window.getComputedStyle(chevron).transform : 'not found'
    });
     };

  // Debug function to force collapse all sections
  window.forceCollapseAllSections = function() {
    console.log('ðŸ”§ DEBUG: Force collapsing all sections');
    
    const sections = ['timeline', 'milestoneSummary', 'projectMilestones'];
    sections.forEach(sectionName => {
      const section = document.getElementById(sectionName + 'Section');
      const chevron = document.querySelector(`[data-section="${sectionName}"]`);
      if (section) {
        section.classList.remove('expanded');
        console.log(`ðŸ”’ Force collapsed section: ${sectionName}`);
      }
      if (chevron) {
        chevron.classList.remove('rotated');
        console.log(`ðŸ”„ Reset chevron for section: ${sectionName}`);
      }
    });
    
    // Also collapse all milestone cards
    forceCollapseAllMilestones();
    
    console.log('âœ… All sections force collapsed');
  };

  // Debug function to manually test Project Milestones section collapse/expand
  window.testProjectMilestonesToggle = function() {
    console.log('ðŸ”§ DEBUG: Testing Project Milestones toggle manually');
    
    const section = document.getElementById('projectMilestonesSection');
    const chevron = document.querySelector('[data-section="projectMilestones"] svg');
    
    if (!section) {
      console.error('âŒ Project Milestones section not found');
      return;
    }
    
    const isCollapsed = section.classList.contains('collapsed');
    console.log('ðŸ“Š Current state - isCollapsed:', isCollapsed);
    
    if (isCollapsed) {
      // Expand
      console.log('ðŸ”“ Expanding manually...');
      section.classList.remove('collapsed');
      section.classList.add('expanded');
      section.style.maxHeight = 'none';
      section.style.opacity = '1';
      section.style.overflow = 'visible';
      section.style.display = 'block';
      if (chevron) chevron.style.transform = 'rotate(180deg)';
    } else {
      // Collapse
      console.log('ðŸ”’ Collapsing manually...');
      section.classList.remove('expanded');
      section.classList.add('collapsed');
      section.style.maxHeight = '0px';
      section.style.opacity = '0';
      section.style.overflow = 'hidden';
      section.style.display = 'block'; // Keep display block
      if (chevron) chevron.style.transform = 'rotate(0deg)';
    }
    
    // Check final state
    setTimeout(() => {
      console.log('ðŸ“Š Final state:', {
        classes: section.className,
        styles: section.style.cssText,
        visible: section.offsetHeight > 0
      });
    }, 500);
  };

  // Force collapse all milestones on load
  function forceCollapseAllMilestones() {
    const allMilestoneContents = document.querySelectorAll('[id^="milestone-"][id$="-content"]');
    console.log('ðŸ” Found milestone contents:', allMilestoneContents.length);
    
    allMilestoneContents.forEach(content => {
      // Remove expanded class
      content.classList.remove('expanded');
      
      // Force collapsed styles directly
      content.style.maxHeight = '0px';
      content.style.opacity = '0';
      content.style.transform = 'translateY(-10px)';
      content.style.overflow = 'hidden';
      
      console.log('ðŸ”’ Milestone forced collapsed:', content.id);
    });
    
    // Reset all milestone icons
    const allMilestoneIcons = document.querySelectorAll('[id^="milestone-"][id$="-icon"]');
    allMilestoneIcons.forEach(icon => {
      icon.classList.remove('rotated');
      icon.style.transform = 'rotate(0deg)';
    });
    console.log('âœ… All milestones forced to collapsed state');
  }

  // ===== SUBMISSION REVIEW CENTER FUNCTIONS =====
  
  // Toggle Submission Review Center visibility
  function toggleSubmissionReviewCenter() {
    console.log('ðŸŽ¯ Toggling Submission Review Center');
    const content = document.getElementById('submissionReviewContent');
    const chevron = document.querySelector('[data-section="submissionReview"] .chevron-icon');
    
    if (!content) {
      console.error('âŒ Submission review content not found');
      return;
    }
    
    const isExpanded = content.classList.contains('expanded');
    console.log('ðŸ“Š Current state - isExpanded:', isExpanded);
    
    if (isExpanded) {
      // Collapse
      content.classList.remove('expanded');
      content.classList.add('collapsed');
      content.style.maxHeight = '0px';
      content.style.opacity = '0';
      if (chevron) chevron.style.transform = 'rotate(0deg)';
      console.log('ðŸ”’ Submission Review Center collapsed');
    } else {
      // Expand
      content.classList.remove('collapsed');
      content.classList.add('expanded');
      content.style.maxHeight = 'none';
      content.style.opacity = '1';
      if (chevron) chevron.style.transform = 'rotate(180deg)';
      console.log('ðŸ”“ Submission Review Center expanded');
      
      // Load submissions when expanded
      loadMilestoneSubmissions();
    }
  }

  // Helper functions for UI state management
  function showSubmissionsLoading() {
    const loading = document.getElementById('submissionsLoading');
    const empty = document.getElementById('submissionsEmpty');
    const container = document.getElementById('submissionsContainer');
    
    if (loading) loading.classList.remove('hidden');
    if (empty) empty.classList.add('hidden');
    
    // Clear existing submissions
    if (container) {
      container.innerHTML = ''; // Clear all content
    }
    
    console.log('â³ Showing loading state and cleared existing submissions');
  }

  function hideSubmissionsLoading() {
    const loading = document.getElementById('submissionsLoading');
    if (loading) loading.classList.add('hidden');
  }

  function showEmptySubmissionsState() {
    const loading = document.getElementById('submissionsLoading');
    const empty = document.getElementById('submissionsEmpty');
    const container = document.getElementById('submissionsContainer');
    
    if (loading) loading.classList.add('hidden');
    if (empty) empty.classList.remove('hidden');
    
    // Clear existing submissions - use the correct selector for submission cards
    if (container) {
      container.innerHTML = ''; // Clear all content
    }
    
    // Reset counter
    updateSubmissionCountBadge(0);
    
    // Also clear the milestoneSubmissions array to prevent stale data
    if (typeof milestoneSubmissions !== 'undefined') {
      milestoneSubmissions.length = 0;
    }
    
    console.log('ðŸ§¹ Cleared all submissions and reset state');
  }

  function hideEmptySubmissionsState() {
    const empty = document.getElementById('submissionsEmpty');
    if (empty) empty.classList.add('hidden');
  }

  function updateSubmissionCountBadge(count) {
    const badge = document.getElementById('submissionNotificationBadge');
    const badgeCount = document.getElementById('submissionBadgeCount');
    const submissionCount = document.getElementById('submissionCount');
    
    if (badgeCount) badgeCount.textContent = count;
    if (submissionCount) {
      submissionCount.innerHTML = `<span class="text-white/90">${count}</span> <span class="text-white/70">Submission${count !== 1 ? 's' : ''}</span>`;
    }
    
    if (badge) {
      if (count > 0) {
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
  }

  // Export functions to window
  window.toggleSubmissionReviewCenter = toggleSubmissionReviewCenter;
  window.filterSubmissions = filterSubmissions;
  window.refreshSubmissions = refreshSubmissions;
  window.showSubmissionsLoading = showSubmissionsLoading;
  window.hideSubmissionsLoading = hideSubmissionsLoading;
  window.showEmptySubmissionsState = showEmptySubmissionsState;
  window.hideEmptySubmissionsState = hideEmptySubmissionsState;
  window.updateSubmissionCountBadge = updateSubmissionCountBadge;
  window.displayMilestoneSubmissions = displayMilestoneSubmissions;

  // Functions exported to window in DOMContentLoaded event listener above
  
  // Progress bar animation functions
  function animateProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar-fill');
    
    progressBars.forEach(bar => {
      const progress = parseFloat(bar.getAttribute('data-progress')) || 0;
      const colorClass = bar.getAttribute('data-progress-color') || 'bg-gray-500';
      
      // Apply the color class
      bar.className = bar.className.replace(/bg-\w+-\d+/, '');
      bar.classList.add(colorClass);
      
      // Set the progress width
      bar.style.setProperty('--progress-width', `${progress}%`);
      
      // Reset and start animation
      bar.style.animation = 'none';
      bar.offsetHeight; // Trigger reflow
      bar.style.animation = 'fillProgress 2s ease-out forwards';
    });
  }

  // Dashboard progress bar animation function
  function animateDashboardProgressBars(progressData) {
    progressData.forEach(({ element, progress }) => {
      const bar = document.getElementById(element);
      if (!bar) return;

      // Determine color based on progress percentage
      const colorClass = progress >= 0 && progress <= 25 ? 'bg-red-500' : 
                        progress >= 26 && progress <= 50 ? 'bg-yellow-500' : 
                        progress >= 51 && progress <= 75 ? 'bg-blue-500' : 
                        progress >= 76 && progress <= 100 ? 'bg-green-500' : 'bg-gray-500';

      // Apply the color class
      bar.className = bar.className.replace(/bg-\w+-\d+/, '');
      bar.classList.add(colorClass);

      // Update data attributes
      bar.setAttribute('data-progress', progress);
      bar.setAttribute('data-progress-color', colorClass);

      // Set the progress width for animation
      bar.style.setProperty('--dashboard-progress-width', `${progress}%`);

      // Reset and start animation
      bar.style.width = '0%';
      bar.style.animation = 'none';
      bar.offsetHeight; // Trigger reflow
      bar.style.animation = 'fillDashboardProgress 2s ease-out forwards';
    });
  }
  
  // Intersection Observer for scroll-triggered animation
  function setupProgressAnimation() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const progressBar = entry.target.querySelector('.progress-bar-fill');
          if (progressBar) {
            const progress = parseFloat(progressBar.getAttribute('data-progress')) || 0;
            const colorClass = progressBar.getAttribute('data-progress-color') || 'bg-gray-500';
            
            // Apply the color class
            progressBar.className = progressBar.className.replace(/bg-\w+-\d+/, '');
            progressBar.classList.add(colorClass);
            
            // Set the progress width
            progressBar.style.setProperty('--progress-width', `${progress}%`);
            
            // Reset and start animation
            progressBar.style.animation = 'none';
            progressBar.offsetHeight; // Trigger reflow
            progressBar.style.animation = 'fillProgress 2s ease-out forwards';
          }
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });
    
    // Observe all project cards
    const projectCards = document.querySelectorAll('.project-card');
    projectCards.forEach(card => observer.observe(card));
  }
  
  // Initialize progress animation when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(setupProgressAnimation, 100);
    });
  } else {
    setTimeout(setupProgressAnimation, 100);
  }
  
  // Also run on window load for any dynamically loaded content
  window.addEventListener('load', () => {
    setTimeout(setupProgressAnimation, 200);
  });

  // Export functions to global scope
  window.animateProgressBars = animateProgressBars;
  window.setupProgressAnimation = setupProgressAnimation;
  window.animateDashboardProgressBars = animateDashboardProgressBars;
  
</script>

<!-- Pass server-side data to client-side via global variable -->
<script define:vars={{ serverProjects: projects }}>
  // Make server-side projects available globally
      window.initialProjectsData = serverProjects;
    console.log('Server-side projects loaded:', serverProjects ? serverProjects.length : 0);
  </script> 