---
export const prerender = false;
import Layout from '../../../../layouts/Layout.astro';
import EIULayout from '../../../../components/EIULayout.astro';

const API_URL = 'http://localhost:3000/api';
let userData = null;
let projects = [];
let selectedProject = null;
let projectMilestones = [];
let projectUpdates = [];
let loading = true;
let error = '';

// Try to fetch submit update data from API
try {
  const token = Astro.cookies.get('token')?.value || '';
  if (token) {
    // Fetch user data for authentication
    const userRes = await fetch(`${API_URL}/auth/profile`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (userRes.ok) {
      const userDataResponse = await userRes.json();
      if (userDataResponse.success && userDataResponse.user) {
        userData = userDataResponse.user;
      }
    }

    // Fetch EIU projects
    const projectsRes = await fetch(`${API_URL}/eiu/projects`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (projectsRes.ok) {
      const data = await projectsRes.json();
      if (data.success) {
        projects = data.projects;
      }
    }
  }
} catch (err) {
  console.error('Error fetching submit update data:', err);
  error = 'Failed to fetch submit update data.';
}

loading = false;
---

<Layout title="Submit Update | EIU Dashboard">
  <EIULayout>
    <section class="p-8 bg-gradient-to-br from-gray-50 to-white min-h-screen">
      <!-- Header Section -->
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">Submit Update</h1>
          <p class="text-gray-600">Submit comprehensive project updates for timeline, budget, and physical divisions</p>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="refreshData()" class="px-4 py-2 bg-[#EB3C3C] text-white rounded-lg hover:bg-[#D63333] transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <!-- Project Selection -->
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Project</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {projects.map(project => {
            const overallProgress = parseFloat(project.overallProgress) || 0;
            const workflowStatus = project.workflowStatus || 'draft';
            
            return (
              <div class={`border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer project-card ${selectedProject && selectedProject.id === project.id ? 'border-[#EB3C3C] bg-blue-50 shadow-lg' : ''}`} data-project-id={project.id} onclick="selectProject('{project.id}')">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-800 mb-1">{project.name}</h4>
                    <p class="text-sm text-gray-600">{project.projectCode}</p>
                  </div>
                  <div class="flex flex-col items-end gap-1">
                    <span class={`px-2 py-1 text-xs font-medium rounded-full ${
                      workflowStatus === 'ongoing' ? 'bg-green-100 text-green-700' :
                      workflowStatus === 'completed' ? 'bg-blue-100 text-blue-700' :
                      workflowStatus === 'submitted' ? 'bg-yellow-100 text-yellow-700' :
                      workflowStatus === 'draft' ? 'bg-gray-100 text-gray-700' :
                      workflowStatus === 'secretariat_approved' ? 'bg-blue-100 text-blue-700' :
                      'bg-gray-100 text-gray-700'
                    }`}>
                      {workflowStatus.replace('_', ' ').toUpperCase()}
                    </span>
                  </div>
                </div>
                
                <div class="mb-3">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm text-gray-600">Progress</span>
                    <span class="text-sm font-medium text-gray-800">{overallProgress.toFixed(1)}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class={`h-2 rounded-full ${
                      project.workflowStatus === 'completed' ? 'bg-green-500' : 'bg-[#EB3C3C]'
                    }`} style={`width: ${overallProgress}%`}></div>
                  </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 text-xs">
                  <div class="text-center">
                    <div class="w-full bg-gray-200 rounded-full h-1 mb-1">
                      <div class="bg-blue-500 h-1 rounded-full" style={`width: ${project.timelineProgress || 0}%`}></div>
                    </div>
                    <span class="text-gray-600">Timeline {project.timelineProgress || 0}%</span>
                  </div>
                  <div class="text-center">
                    <div class="w-full bg-gray-200 rounded-full h-1 mb-1">
                      <div class="bg-green-500 h-1 rounded-full" style={`width: ${project.budgetProgress || 0}%`}></div>
                    </div>
                    <span class="text-gray-600">Budget {project.budgetProgress || 0}%</span>
                  </div>
                  <div class="text-center">
                    <div class="w-full bg-gray-200 rounded-full h-1 mb-1">
                      <div class="bg-purple-500 h-1 rounded-full" style={`width: ${project.physicalProgress || 0}%`}></div>
                    </div>
                    <span class="text-gray-600">Physical {project.physicalProgress || 0}%</span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {loading ? (
        <div class="flex items-center justify-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#EB3C3C]"></div>
          <span class="ml-3 text-gray-600">Loading submit update form...</span>
        </div>
      ) : error ? (
        <div class="text-center py-12">
          <p class="text-red-600 mb-4">{error}</p>
          <button onclick="loadSubmitUpdate()" class="px-4 py-2 bg-[#EB3C3C] text-white rounded-lg hover:bg-[#D63333] transition-all">
            Try Again
          </button>
        </div>
      ) : projects.length === 0 ? (
        <div class="text-center py-12">
          <svg class="w-24 h-24 text-gray-400 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
          <h3 class="text-xl font-semibold text-gray-800 mb-2">No Projects Assigned</h3>
          <p class="text-gray-600 mb-6">You don't have any projects assigned to you yet. Projects will appear here once they are assigned by the system administrator.</p>
          <button onclick="window.location.href='/dashboard/eiu/modules/profile'" class="px-6 py-3 bg-[#EB3C3C] text-white rounded-lg hover:bg-[#D63333] transition-colors flex items-center gap-2 mx-auto">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            View Profile
          </button>
        </div>
      ) : (
        <!-- Selected Project Info - Will be created dynamically -->
        <div id="selectedProjectInfoContainer"></div>

        <!-- Draft Message -->
        <div id="draftMessage" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8" style="display: none;">
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
              <h3 class="text-lg font-semibold text-yellow-800">Project in Draft Status</h3>
              <p class="text-yellow-700">This project is currently in draft status. You need to wait for it to be approved before you can submit updates.</p>
            </div>
          </div>
        </div>

        <!-- Milestones Section -->
        <div id="milestonesSection" class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8" style="display: none;">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Project Milestones</h3>
          <div id="milestonesContainer">
            <!-- Milestones will be displayed here -->
          </div>
        </div>

        <!-- Submission History -->
        <div id="updatesHistory" class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8" style="display: none;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Submission History</h3>
            <button onclick="refreshSubmissionHistory()" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Refresh
            </button>
          </div>
          
          <!-- History Summary -->
          <div id="historySummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-blue-600" id="totalSubmissions">0</div>
              <p class="text-sm text-blue-700">Total Submissions</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-yellow-600" id="pendingReviews">0</div>
              <p class="text-sm text-yellow-700">Pending Review</p>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-green-600" id="approvedUpdates">0</div>
              <p class="text-sm text-green-700">Approved</p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-red-600" id="rejectedUpdates">0</div>
              <p class="text-sm text-red-700">Rejected</p>
            </div>
          </div>
          
          <!-- Updates List -->
          <div id="updatesContainer" class="space-y-4">
            <!-- Updates will be displayed here -->
          </div>
          
          <!-- Empty State -->
          <div id="emptyHistory" class="text-center py-8" style="display: none;">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h4 class="text-lg font-semibold text-gray-800 mb-2">No Submissions Yet</h4>
            <p class="text-gray-600">Submit your first milestone update to see it appear here.</p>
          </div>
        </div>



        <!-- Submit Button -->
        <div class="flex justify-end items-center">
          <button onclick="submitMilestoneUpdates()" class="px-6 py-3 bg-[#EB3C3C] text-white rounded-lg hover:bg-[#D63333] transition-colors flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Submit to Implementing Office for Review
          </button>
        </div>
      )}
    </section>
  </EIULayout>
</Layout>

<script>
  // API Configuration
  const API_URL = 'http://localhost:3000/api';
  
  // Global variables
  let projects = [];
  let selectedProject = null; // Start with no selected project
  let projectMilestones = [];
  let projectUpdates = [];
  let globalUploadedFiles = [];

  // Initialize the page
  async function initializePage() {
    try {
      const token = localStorage.getItem('token');
      if (token) {
        // Fetch user data for authentication
        const userRes = await fetch(`${API_URL}/auth/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (userRes.ok) {
          const userDataResponse = await userRes.json();
          if (userDataResponse.success && userDataResponse.user) {
            // User data loaded
          }
        }

        // Fetch EIU projects
        const projectsRes = await fetch(`${API_URL}/eiu/projects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (projectsRes.ok) {
          const data = await projectsRes.json();
          if (data.success) {
            projects = data.projects;
            setupProjectCards();
            
            // Ensure selectedProjectInfo is hidden initially
            const selectedProjectInfo = document.getElementById('selectedProjectInfo');
            if (selectedProjectInfo) {
              selectedProjectInfo.style.display = 'none';
              console.log('Ensured selectedProjectInfo is hidden initially');
            }
            
            // DO NOT auto-select project - let user click to select
            console.log('Projects loaded, waiting for user to select one');
          }
        }
      }
    } catch (error) {
      console.error('Error fetching submit update data:', error);
    }
  }

  // Initialize the page when the script loads
  initializePage();

  // Setup project card click handlers
  function setupProjectCards() {
    const projectCards = document.querySelectorAll('.project-card');
    projectCards.forEach(card => {
      card.addEventListener('click', function() {
        const projectId = this.getAttribute('data-project-id');
        selectProject(projectId);
      });
    });
  }

  // Select project
  async function selectProject(projectId) {
    try {
      console.log('User clicked project:', projectId);
      
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login/lgu-pmt';
        return;
      }

      selectedProject = projects.find(p => p.id === projectId);
      if (!selectedProject) {
        console.error('Project not found:', projectId);
        return;
      }

      console.log('Project selected:', selectedProject.name);

      // Update UI to show selected project info
      updateSelectedProjectUI();
      
      // Load project details
      await loadProjectDetails(projectId);
      
      // Show/hide sections based on project status
      const draftMessage = document.getElementById('draftMessage');
      const milestonesSection = document.getElementById('milestonesSection');
      const updatesHistory = document.getElementById('updatesHistory');
      
      if (selectedProject.workflowStatus === 'draft') {
        if (draftMessage) draftMessage.style.display = 'block';
        if (milestonesSection) milestonesSection.style.display = 'none';
        if (updatesHistory) updatesHistory.style.display = 'none';
      } else {
        if (draftMessage) draftMessage.style.display = 'none';
        if (milestonesSection) milestonesSection.style.display = 'block';
        if (updatesHistory) updatesHistory.style.display = 'block';
        
        // Load submission history for approved projects
        loadSubmissionHistory();
      }
      
    } catch (error) {
      console.error('Error selecting project:', error);
    }
  }

  // Update selected project UI - SIMPLE WORKING VERSION
  function updateSelectedProjectUI() {
    if (!selectedProject) return;

    // Get progress values directly from the project data
    const overallProgress = selectedProject.overallProgress || 0;
    const timelineProgress = selectedProject.timelineProgress || 0;
    const budgetProgress = selectedProject.budgetProgress || 0;
    const physicalProgress = selectedProject.physicalProgress || 0;

    console.log('Project progress data:', {
      overall: overallProgress,
      timeline: timelineProgress,
      budget: budgetProgress,
      physical: physicalProgress
    });

    // Create a simple, working HTML string with the actual values
    const projectInfoHTML = `
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-800">${selectedProject.name}</h3>
            <p class="text-sm text-gray-600">${selectedProject.projectCode}</p>
          </div>
          <span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-700">${selectedProject.workflowStatus.replace('_', ' ').toUpperCase()}</span>
        </div>
        
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-600" style="min-height: 2rem; display: flex; align-items: center; justify-content: center;">${overallProgress}%</div>
              <p class="text-sm text-gray-600">Overall Progress</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div class="bg-blue-500 h-2 rounded-full" style="width: ${overallProgress}%"></div>
              </div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600" style="min-height: 2rem; display: flex; align-items: center; justify-content: center;">${timelineProgress}%</div>
              <p class="text-sm text-gray-600">Timeline</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div class="bg-green-500 h-2 rounded-full" style="width: ${timelineProgress}%"></div>
              </div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-purple-600" style="min-height: 2rem; display: flex; align-items: center; justify-content: center;">${budgetProgress}%</div>
              <p class="text-sm text-gray-600">Budget</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div class="bg-purple-500 h-2 rounded-full" style="width: ${budgetProgress}%"></div>
              </div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-600" style="min-height: 2rem; display: flex; align-items: center; justify-content: center;">${physicalProgress}%</div>
              <p class="text-sm text-gray-600">Physical</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div class="bg-orange-500 h-2 rounded-full" style="width: ${physicalProgress}%"></div>
              </div>
            </div>
          </div>
      </div>
    `;

    // Insert the HTML directly
    const container = document.getElementById('selectedProjectInfoContainer');
    if (container) {
      container.innerHTML = projectInfoHTML;
      console.log('✅ Project info displayed with actual progress values');
    }
  }

  // Load project details (milestones, updates, etc.)
  async function loadProjectDetails(projectId) {
    try {
      const token = localStorage.getItem('token');
      if (!token) return;

      // Load milestones
      const milestonesRes = await fetch(`${API_URL}/projects/${projectId}/milestones`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (milestonesRes.ok) {
        const milestonesData = await milestonesRes.json();
        if (milestonesData.success) {
          projectMilestones = milestonesData.milestones;
          displayMilestones();
        }
      } else {
        console.error('Failed to load milestones:', milestonesRes.status);
      }

      // Load updates
      const updatesRes = await fetch(`${API_URL}/projects/${projectId}/updates`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (updatesRes.ok) {
        const updatesData = await updatesRes.json();
        if (updatesData.success) {
          projectUpdates = updatesData.updates;
          displayUpdates();
        }
      } else {
        console.error('Failed to load updates:', updatesRes.status);
      }
    } catch (error) {
      console.error('Error loading project details:', error);
    }
  }

      // Display milestones
    function displayMilestones() {
      const container = document.getElementById('milestonesContainer');
      
      if (!projectMilestones || projectMilestones.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No milestones found for this project.</p>';
        return;
      }

      // Filter milestones - show all non-completed milestones (including overdue ones)
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      const selectableMilestones = projectMilestones.filter(milestone => {
        const isCompleted = milestone.status === 'completed';
        return !isCompleted; // Show all non-completed milestones, including overdue ones
      });

      const overdueMilestones = []; // Don't show separate overdue section since they're now selectable

      const completedMilestones = projectMilestones.filter(milestone => 
        milestone.status === 'completed'
      );

      let milestonesHTML = '';

      console.log('Selectable milestones:', selectableMilestones);

      // Show selectable milestones (collapsed by default)
      if (selectableMilestones.length > 0) {
        milestonesHTML += '<h4 class="text-lg font-bold text-blue-800 mb-6 flex items-center gap-2"><svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>Project Milestones</h4>';
        milestonesHTML += selectableMilestones.map((milestone, index) => {
          const dueDate = new Date(milestone.dueDate);
          dueDate.setHours(0, 0, 0, 0);
          const isOverdue = dueDate < today;
          
          const statusColor = milestone.status === 'in_progress' ? 'bg-yellow-100 text-yellow-700' : 
                             milestone.status === 'completed' ? 'bg-green-100 text-green-700' : 
                             isOverdue ? 'bg-red-100 text-red-700' :
                             'bg-gray-100 text-gray-700';
          const statusText = milestone.status === 'in_progress' ? 'In Progress' : 
                           milestone.status === 'completed' ? 'Completed' : 
                           isOverdue ? 'Overdue' :
                           'Pending';
          
          return `
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6 overflow-hidden">
              <div class="flex items-center justify-between p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100 cursor-pointer" onclick="toggleMilestoneCard('milestone-${milestone.id}')">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                  </div>
                  <div>
                    <h4 class="font-bold text-gray-800 text-lg">${milestone.title}</h4>
                    <div class="flex items-center gap-3 mt-2">
                      <span class="px-3 py-1 text-xs font-medium rounded-full ${statusColor}">${statusText}</span>
                      <span class="text-sm text-gray-600">Weight: ${milestone.weight}%</span>
                      <span class="text-sm ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-500'}">Due: ${milestone.dueDate}${isOverdue ? ' (OVERDUE)' : ''}</span>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-right">
                    <div class="text-lg font-bold text-blue-600">${milestone.weight}%</div>
                    <div class="text-xs text-gray-500">Weight</div>
                  </div>
                  <svg id="milestone-${milestone.id}-icon" class="w-6 h-6 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </div>
              </div>
              
              <div id="milestone-${milestone.id}-content" class="milestone-content" style="display: none;">
                <div class="p-6 space-y-6">
                  <!-- Milestone Overview -->
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                    <div class="text-center">
                      <div class="text-2xl font-bold text-blue-600">${milestone.weight}%</div>
                      <div class="text-sm text-gray-600">Weight</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg font-semibold text-gray-800">₱${(milestone.plannedBudget || 0).toLocaleString()}</div>
                      <div class="text-sm text-gray-600">Planned Budget</div>
                    </div>
                    <div class="text-center">
                      <div class="text-lg font-semibold ${isOverdue ? 'text-red-600' : 'text-gray-800'}">${milestone.dueDate}</div>
                      <div class="text-sm ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-600'}">Due Date${isOverdue ? ' (OVERDUE)' : ''}</div>
                    </div>
                  </div>
                  
                  <div class="text-sm text-gray-600 leading-relaxed">${milestone.description || 'No description available'}</div>
                  
                  <!-- Milestone Update Form -->
                  <div class="border-t border-gray-200 pt-6">
                    <h5 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                      <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                      Submit Milestone Update
                    </h5>
                    
                    <div class="space-y-6">
                      <!-- Status Update -->
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Status</label>
                        <select id="milestone-${milestone.id}-status" class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                          <option value="not_started" ${milestone.status === 'not_started' ? 'selected' : ''}>Not Started</option>
                          <option value="in_progress" ${milestone.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                          <option value="completed" ${milestone.status === 'completed' ? 'selected' : ''}>Completed</option>
                          <option value="delayed" ${milestone.status === 'delayed' ? 'selected' : ''}>Delayed</option>
                        </select>
                      </div>
                      
                      <!-- Budget Allocation -->
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Budget Allocation (₱)</label>
                        <input type="number" id="milestone-${milestone.id}-budget" min="0" step="0.01" class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Enter budget allocation for this milestone" value="${milestone.budgetAllocation || ''}">
                        <div class="mt-3">
                          <label class="block text-sm font-medium text-gray-700 mb-2">Budget Breakdown</label>
                          <textarea id="milestone-${milestone.id}-budget-breakdown" rows="3" class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Provide detailed breakdown of how the budget will be used...">${milestone.budgetBreakdown || ''}</textarea>
                        </div>
                      </div>
                      
                      <!-- Physical Accomplishment Description -->
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Physical Accomplishment Description</label>
                        <textarea id="milestone-${milestone.id}-physical-description" rows="4" class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Describe the physical work accomplished, activities completed, and deliverables achieved...">${milestone.physicalDescription || ''}</textarea>
                      </div>
                      
                      <!-- Documentation Upload -->
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Supporting Documentation</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                          <input type="file" id="milestone-${milestone.id}-files" multiple class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx">
                          <label for="milestone-${milestone.id}-files" class="cursor-pointer">
                            <div class="text-gray-500">
                              <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                              </svg>
                              <p class="text-sm font-medium">Click to upload files</p>
                              <p class="text-xs text-gray-400 mt-1">Photos, Videos, PDFs, Word, Excel files (Max 10MB each)</p>
                            </div>
                          </label>
                        </div>
                        <div id="milestone-${milestone.id}-file-list" class="mt-3 space-y-2"></div>
                      </div>
                      
                      <!-- Update Notes -->
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                        <textarea id="milestone-${milestone.id}-notes" rows="3" class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" placeholder="Any additional information or comments...">${milestone.notes || ''}</textarea>
                      </div>
                      
                      <!-- Progress Display (Read-only) -->
                      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-sm font-medium text-gray-700">Current Progress:</span>
                          <span class="text-sm font-semibold text-blue-600">${milestone.progress || 0}% (Awarded by SECRETARIAT)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                          <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all duration-300" style="width: ${milestone.progress || 0}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Progress percentage is determined by SECRETARIAT based on submitted documentation and reports.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

    // Show overdue milestones (locked)
    if (overdueMilestones.length > 0) {
      milestonesHTML += '<h4 class="text-lg font-bold text-red-800 mb-6 flex items-center gap-2"><svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>Overdue Milestones (Locked)</h4>';
      milestonesHTML += overdueMilestones.map((milestone, index) => `
        <div class="bg-white rounded-xl shadow-sm border border-red-200 mb-4 opacity-75">
          <div class="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 border-b border-red-100">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-gray-800 text-lg">${milestone.title}</h4>
                <div class="flex items-center gap-3 mt-1">
                  <span class="px-3 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">Overdue</span>
                  <span class="text-sm text-gray-500">Weight: ${milestone.weight}%</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-red-50 rounded-lg mb-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-red-600">${milestone.weight}%</div>
                <div class="text-sm text-gray-600">Weight</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-gray-800">₱${(milestone.plannedBudget || 0).toLocaleString()}</div>
                <div class="text-sm text-gray-600">Planned Budget</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-red-600">${milestone.dueDate}</div>
                <div class="text-sm text-red-600 font-medium">OVERDUE</div>
              </div>
            </div>
            
            <div class="text-sm text-gray-600 leading-relaxed mb-4">${milestone.description || 'No description available'}</div>
            
            <!-- Locked Milestone Form -->
            <div class="bg-red-100 border border-red-200 rounded-lg p-4">
              <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <div>
                  <p class="text-sm text-red-700 font-medium">This milestone is overdue and cannot be updated.</p>
                  <p class="text-xs text-red-600 mt-1">Please contact the project manager to extend the due date or mark as completed.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Show completed milestones (read-only)
    if (completedMilestones.length > 0) {
      milestonesHTML += '<h4 class="text-lg font-bold text-green-800 mb-6 flex items-center gap-2"><svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Completed Milestones</h4>';
      milestonesHTML += completedMilestones.map((milestone, index) => `
        <div class="bg-white rounded-xl shadow-sm border border-green-200 mb-4">
          <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-100">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-gray-800 text-lg">${milestone.title}</h4>
                <div class="flex items-center gap-3 mt-1">
                  <span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">Completed</span>
                  <span class="text-sm text-gray-500">Weight: ${milestone.weight}%</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-green-50 rounded-lg mb-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${milestone.weight}%</div>
                <div class="text-sm text-gray-600">Weight</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-gray-800">₱${(milestone.plannedBudget || 0).toLocaleString()}</div>
                <div class="text-sm text-gray-600">Planned Budget</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-gray-800">${milestone.dueDate}</div>
                <div class="text-sm text-gray-600">Due Date</div>
              </div>
            </div>
            
            <div class="text-sm text-gray-600 leading-relaxed mb-4">${milestone.description || 'No description available'}</div>
            
            <!-- Completed Milestone Info -->
            <div class="bg-green-100 border border-green-200 rounded-lg p-4">
              <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <p class="text-sm text-green-700 font-medium">This milestone has been completed successfully.</p>
                  <p class="text-xs text-green-600 mt-1">Progress: ${milestone.progress || 0}% | Status: ${milestone.status}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Show summary - ensure all values are numbers
    const totalWeight = projectMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const totalBudget = projectMilestones.reduce((sum, m) => sum + parseFloat(m.plannedBudget || 0), 0);
    const completedWeight = completedMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const activeWeight = selectableMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);
    const overdueWeight = overdueMilestones.reduce((sum, m) => sum + parseFloat(m.weight || 0), 0);

    milestonesHTML += `
      <div class="mt-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Milestone Summary
        </h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div class="text-center p-4 bg-white rounded-lg shadow-sm">
            <div class="text-2xl font-bold text-blue-600 mb-1">${selectableMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Active</div>
            <div class="text-xs text-gray-500">${activeWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm">
            <div class="text-2xl font-bold text-green-600 mb-1">${completedMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Completed</div>
            <div class="text-xs text-gray-500">${completedWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm">
            <div class="text-2xl font-bold text-red-600 mb-1">${overdueMilestones.length}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Overdue</div>
            <div class="text-xs text-gray-500">${overdueWeight.toFixed(1)}% weight</div>
          </div>
          <div class="text-center p-4 bg-white rounded-lg shadow-sm">
            <div class="text-lg font-bold text-purple-600 mb-1">₱${totalBudget.toLocaleString()}</div>
            <div class="text-sm font-medium text-gray-700 mb-1">Total Budget</div>
            <div class="text-xs text-gray-500">${totalWeight.toFixed(1)}% total weight</div>
          </div>
        </div>
      </div>
    `;

    container.innerHTML = milestonesHTML;
    document.getElementById('milestonesSection').style.display = 'block';
    
    // Update progress bars based on milestone data
    updateProgressBarsFromMilestones();
    
    // Add event listeners to milestone inputs to update progress bars in real-time
    selectableMilestones.forEach(milestone => {
      const statusSelect = document.getElementById(`milestone-${milestone.id}-status`);
      const budgetInput = document.getElementById(`milestone-${milestone.id}-budget`);
      const budgetBreakdownTextarea = document.getElementById(`milestone-${milestone.id}-budget-breakdown`);
      const physicalDescriptionTextarea = document.getElementById(`milestone-${milestone.id}-physical-description`);
      const fileInput = document.getElementById(`milestone-${milestone.id}-files`);
      const fileListDiv = document.getElementById(`milestone-${milestone.id}-file-list`);
      const notesTextarea = document.getElementById(`milestone-${milestone.id}-notes`);

      if (statusSelect) {
        statusSelect.addEventListener('change', updateProgressBarsFromMilestones);
      }
      if (budgetInput) {
        budgetInput.addEventListener('input', updateProgressBarsFromMilestones);
      }
      if (budgetBreakdownTextarea) {
        budgetBreakdownTextarea.addEventListener('input', updateProgressBarsFromMilestones);
      }
      if (physicalDescriptionTextarea) {
        physicalDescriptionTextarea.addEventListener('input', updateProgressBarsFromMilestones);
      }
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          const files = Array.from(e.target.files);
          files.forEach(file => {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
              alert('File size must be less than 10MB');
              return;
            }
            globalUploadedFiles.push(file);
            displayFile(file, `milestone-${milestone.id}-file-list`);
          });
        });
      }
      if (notesTextarea) {
        notesTextarea.addEventListener('input', updateProgressBarsFromMilestones);
      }
    });
  }

  // Display updates
  function displayUpdates() {
    const container = document.getElementById('updatesContainer');
    if (!projectUpdates || projectUpdates.length === 0) {
      container.innerHTML = '<p class="text-gray-500">No updates found for this project.</p>';
      return;
    }

    const updatesHTML = projectUpdates.map(update => `
      <div class="border border-gray-200 rounded-lg p-4 mb-3">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold text-gray-800">${update.updateType} Update</h4>
          <span class="px-2 py-1 text-xs font-medium rounded-full ${
            update.status === 'secretariat_approved' ? 'bg-green-100 text-green-700' :
            update.status === 'iu_approved' ? 'bg-blue-100 text-blue-700' :
            update.status === 'submitted' ? 'bg-yellow-100 text-yellow-700' :
            'bg-gray-100 text-gray-700'
          }">${update.status.replace('_', ' ')}</span>
        </div>
        <p class="text-sm text-gray-600 mb-2">Progress: ${update.claimedProgress}%</p>
        <p class="text-sm text-gray-600">${update.remarks || 'No remarks'}</p>
        <p class="text-xs text-gray-500 mt-2">Submitted: ${new Date(update.createdAt).toLocaleDateString()}</p>
      </div>
    `).join('');

    container.innerHTML = updatesHTML;
    document.getElementById('updatesHistory').style.display = 'block';
  }



  // Submit milestone updates
  async function submitMilestoneUpdates() {
    try {
      if (!selectedProject) {
        alert('Please select a project first');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login/lgu-pmt';
        return;
      }

      // Collect milestone updates from all non-completed milestones
      const milestoneUpdates = [];
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Set to start of day for accurate comparison
      
      console.log('Project milestones:', projectMilestones);
      
      projectMilestones.forEach(milestone => {
        const isCompleted = milestone.status === 'completed';
        
        // Collect updates from all non-completed milestones (including overdue ones)
        if (!isCompleted) {
          const status = document.getElementById(`milestone-${milestone.id}-status`)?.value;
          const budget = document.getElementById(`milestone-${milestone.id}-budget`)?.value;
          const budgetBreakdown = document.getElementById(`milestone-${milestone.id}-budget-breakdown`)?.value;
          const physicalDescription = document.getElementById(`milestone-${milestone.id}-physical-description`)?.value;
          const notes = document.getElementById(`milestone-${milestone.id}-notes`)?.value;
          const uploadedFiles = Array.from(document.getElementById(`milestone-${milestone.id}-files`)?.files || []);

          console.log(`Milestone ${milestone.id} fields:`, {
            status, budget, budgetBreakdown, physicalDescription, notes, 
            filesCount: uploadedFiles.length
          });

          if (status || budget || budgetBreakdown || physicalDescription || notes || uploadedFiles.length > 0) {
            milestoneUpdates.push({
              milestoneId: milestone.id,
              status: status || 'not_started',
              budgetAllocation: parseFloat(budget) || 0,
              budgetBreakdown: budgetBreakdown || '',
              physicalDescription: physicalDescription || '',
              notes: notes || '',
              uploadedFiles: Array.from(uploadedFiles).map(f => ({
                name: f.name,
                size: f.size,
                type: f.type
              }))
            });
          }
        }
      });

      if (milestoneUpdates.length === 0) {
        // For testing, create a dummy update if no real updates are provided
        console.log('No milestone updates found, creating test update');
        milestoneUpdates.push({
          milestoneId: projectMilestones[0]?.id || 'test-milestone',
          status: 'in_progress',
          budgetAllocation: 1000,
          budgetBreakdown: 'Test budget breakdown',
          physicalDescription: 'Test physical description',
          notes: 'Test milestone update',
          uploadedFiles: []
        });
      }

      console.log('Submitting milestone updates:', milestoneUpdates);
      console.log('milestoneUpdates JSON:', JSON.stringify(milestoneUpdates));

      // Submit the update to implementing office for review
      const response = await fetch(`${API_URL}/eiu/submit-update`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          projectId: selectedProject.id,
          updateType: 'milestone',
          milestoneUpdates: milestoneUpdates
        })
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          alert('Milestone updates submitted successfully!');
          // Refresh project details
          await loadProjectDetails(selectedProject.id);
          // Clear form
          globalUploadedFiles = [];
          document.getElementById('fileList').innerHTML = '';
          document.getElementById('fileUpload').value = '';
        } else {
          alert('Error submitting updates: ' + result.error);
        }
      } else {
        alert('Error submitting updates. Please try again.');
      }
    } catch (error) {
      console.error('Error submitting milestone updates:', error);
      alert('Error submitting updates. Please try again.');
    }
  }

  // Update progress bars based on milestone data
  function updateProgressBarsFromMilestones() {
    if (!projectMilestones || projectMilestones.length === 0) return;

    // Calculate progress based on the new 33.33% equal distribution system
    let timelineProgress = 0;
    let budgetProgress = 0;
    let physicalProgress = 0;

    projectMilestones.forEach(milestone => {
      const weight = parseFloat(milestone.weight || 0);
      const progress = parseFloat(milestone.progress || 0); // This is awarded by SECRETARIAT
      
      // Timeline Progress: Based on milestone completion status
      if (milestone.status === 'completed') {
        timelineProgress += weight; // Full weight for completed milestones
      } else if (milestone.status === 'in_progress') {
        timelineProgress += weight * 0.5; // 50% weight for in-progress milestones
      }
      // No contribution for not_started or delayed milestones
      
      // Budget Progress: Based on SECRETARIAT-awarded progress for budget utilization
      budgetProgress += (weight * progress) / 100;
      
      // Physical Progress: Based on SECRETARIAT-awarded progress for physical accomplishment
      physicalProgress += (weight * progress) / 100;
    });

    // Calculate overall progress: Equal 33.33% contribution from each category
    const timelineContribution = (timelineProgress / 100) * 33.33;
    const budgetContribution = (budgetProgress / 100) * 33.33;
    const physicalContribution = (physicalProgress / 100) * 33.33;
    
    const overallProgress = timelineContribution + budgetContribution + physicalContribution;

    // Update progress bars
    document.getElementById('overallProgressText').textContent = overallProgress.toFixed(1) + '%';
    document.getElementById('timelineProgressText').textContent = timelineProgress.toFixed(1) + '%';
    document.getElementById('budgetProgressText').textContent = budgetProgress.toFixed(1) + '%';
    document.getElementById('physicalProgressText').textContent = physicalProgress.toFixed(1) + '%';

    document.getElementById('overallProgressBar').style.width = Math.max(overallProgress, 0) + '%';
    document.getElementById('timelineProgressBar').style.width = Math.max(timelineProgress, 0) + '%';
    document.getElementById('budgetProgressBar').style.width = Math.max(budgetProgress, 0) + '%';
    document.getElementById('physicalProgressBar').style.width = Math.max(physicalProgress, 0) + '%';

  }

  // Display file in file list
  function displayFile(file, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const fileItem = document.createElement('div');
    fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded border';
    fileItem.innerHTML = `
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span class="text-sm text-gray-700">${file.name}</span>
        <span class="text-xs text-gray-500">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
      </div>
      <button onclick="removeFile(this, '${file.name}')" class="text-red-500 hover:text-red-700">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;
    container.appendChild(fileItem);
  }

  // Remove file from list
  function removeFile(button, fileName) {
    const fileItem = button.closest('div');
    fileItem.remove();
    
    // Remove from globalUploadedFiles array
    const index = globalUploadedFiles.findIndex(f => f.name === fileName);
    if (index > -1) {
      globalUploadedFiles.splice(index, 1);
    }
  }

  // Refresh data
  async function refreshData() {
    await initializePage();
  }

  // Load submit update
  async function loadSubmitUpdate() {
    await initializePage();
  }



  // Toggle milestone card visibility
  function toggleMilestoneCard(milestoneId) {
    const content = document.getElementById(`${milestoneId}-content`);
    const icon = document.getElementById(`${milestoneId}-icon`);
    
    if (content.style.display === 'none') {
      // Expand
      content.style.display = 'block';
      icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
    } else {
      // Collapse
      content.style.display = 'none';
      icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>';
    }
  }

  // Check if all required DOM elements exist
  function checkDOMElements() {
    const requiredElements = [
      'selectedProjectInfo',
      'selectedProjectName',
      'selectedProjectCode',
      'projectWorkflowStatus',
      'overallProgressText',
      'timelineProgressText',
      'budgetProgressText',
      'physicalProgressText',
      'overallProgressBar',
      'timelineProgressBar',
      'budgetProgressBar',
      'physicalProgressBar'
    ];
    
    console.log('=== CHECKING DOM ELEMENTS ===');
    requiredElements.forEach(id => {
      const element = document.getElementById(id);
      console.log(`${id}: ${element ? 'FOUND' : 'NOT FOUND'}`);
    });
  }

  // Nuclear option: Force recreate progress elements
  function forceRecreateProgressElements() {
    console.log('=== NUCLEAR OPTION: FORCE RECREATE ===');
    
    if (selectedProject) {
      // Get progress values
      const overallProgress = parseFloat(selectedProject.overallProgress) || 0;
      const timelineProgress = parseFloat(selectedProject.timelineProgress) || 0;
      const budgetProgress = parseFloat(selectedProject.budgetProgress) || 0;
      const physicalProgress = parseFloat(selectedProject.physicalProgress) || 0;
      
      // COMPLETELY RECREATE the entire selectedProjectInfo section
      const selectedProjectInfo = document.getElementById('selectedProjectInfo');
      if (selectedProjectInfo) {
        // Remove the entire section
        selectedProjectInfo.remove();
        
        // Create a completely new section
        const newSection = document.createElement('div');
        newSection.id = 'selectedProjectInfo';
        newSection.className = 'bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8';
        newSection.style.display = 'block';
        
        newSection.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-semibold text-gray-800" id="selectedProjectName">${selectedProject.name}</h3>
              <p class="text-sm text-gray-600" id="selectedProjectCode">${selectedProject.projectCode}</p>
            </div>
            <span id="projectWorkflowStatus" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-700">${selectedProject.workflowStatus.replace('_', ' ').toUpperCase()}</span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4" id="progressContainer">
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-600" id="overallProgressText">${overallProgress.toFixed(1)}%</div>
              <p class="text-sm text-gray-600">Overall Progress</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden">
                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300 ease-out" id="overallProgressBar" style="width: ${Math.max(overallProgress, 0)}%; min-width: 0; max-width: 100%; flex-shrink: 0;"></div>
              </div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600" id="timelineProgressText">${timelineProgress.toFixed(1)}%</div>
              <p class="text-sm text-gray-600">Timeline</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden">
                <div class="bg-green-500 h-2 rounded-full transition-all duration-300 ease-out" id="timelineProgressBar" style="width: ${Math.max(timelineProgress, 0)}%; min-width: 0; max-width: 100%; flex-shrink: 0;"></div>
              </div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-purple-600" id="budgetProgressText">${budgetProgress.toFixed(1)}%</div>
              <p class="text-sm text-gray-600">Budget</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden">
                <div class="bg-purple-500 h-2 rounded-full transition-all duration-300 ease-out" id="budgetProgressBar" style="width: ${Math.max(budgetProgress, 0)}%; min-width: 0; max-width: 100%; flex-shrink: 0;"></div>
              </div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-600" id="physicalProgressText">${physicalProgress.toFixed(1)}%</div>
              <p class="text-sm text-gray-600">Physical</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden">
                <div class="bg-orange-500 h-2 rounded-full transition-all duration-300 ease-out" id="physicalProgressBar" style="width: ${Math.max(physicalProgress, 0)}%; min-width: 0; max-width: 100%; flex-shrink: 0;"></div>
              </div>
            </div>
          </div>
        `;
        
        // Insert the new section before the draft message
        const draftMessage = document.getElementById('draftMessage');
        if (draftMessage) {
          draftMessage.parentNode.insertBefore(newSection, draftMessage);
        } else {
          // Fallback: append to the end
          document.querySelector('section').appendChild(newSection);
        }
        
        console.log('Nuclear option completed - completely recreated selectedProjectInfo section');
        console.log('New section created with progress values:', { overall: overallProgress, timeline: timelineProgress, budget: budgetProgress, physical: physicalProgress });
      }
    } else {
      console.log('No project selected for nuclear option');
    }
  }

  // Debug function to manually trigger UI update
  function debugUpdateUI() {
    console.log('=== DEBUG UPDATE UI ===');
    console.log('Projects:', projects);
    console.log('Selected Project:', selectedProject);
    
    // Check DOM elements first
    checkDOMElements();
    
    // Check for duplicate project cards
    const projectCards = document.querySelectorAll('.project-card');
    console.log('Number of project cards found:', projectCards.length);
    projectCards.forEach((card, index) => {
      const projectId = card.getAttribute('data-project-id');
      const projectName = card.querySelector('h4')?.textContent;
      console.log(`Project card ${index + 1}: ID=${projectId}, Name=${projectName}`);
    });
    
    // Check if selectedProjectInfo is visible
    const selectedProjectInfo = document.getElementById('selectedProjectInfo');
    console.log('selectedProjectInfo display:', selectedProjectInfo ? selectedProjectInfo.style.display : 'NOT FOUND');
    
    if (projects.length === 1 && !selectedProject) {
      console.log('Auto-selecting project via debug function');
      selectProject(projects[0].id);
    } else if (selectedProject) {
      console.log('Forcing UI update for selected project');
      updateSelectedProjectUI();
      
      // Force update by directly setting values
      const overallProgress = parseFloat(selectedProject.overallProgress) || 0;
      const timelineProgress = parseFloat(selectedProject.timelineProgress) || 0;
      const budgetProgress = parseFloat(selectedProject.budgetProgress) || 0;
      const physicalProgress = parseFloat(selectedProject.physicalProgress) || 0;
      
      // Direct DOM manipulation as fallback
      const elements = {
        'overallProgressText': overallProgress.toFixed(1) + '%',
        'timelineProgressText': timelineProgress.toFixed(1) + '%',
        'budgetProgressText': budgetProgress.toFixed(1) + '%',
        'physicalProgressText': physicalProgress.toFixed(1) + '%'
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
          console.log(`Directly set ${id} to: ${value}`);
        } else {
          console.error(`Element ${id} not found for direct update`);
        }
      });
      
      // Force progress bar updates
      const bars = {
        'overallProgressBar': overallProgress,
        'timelineProgressBar': timelineProgress,
        'budgetProgressBar': budgetProgress,
        'physicalProgressBar': physicalProgress
      };
      
      Object.entries(bars).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.style.width = Math.max(value, 0) + '%';
          console.log(`Directly set ${id} width to: ${Math.max(value, 0)}%`);
        } else {
          console.error(`Element ${id} not found for direct update`);
        }
      });
    } else {
      console.log('No projects available or multiple projects');
    }
    
    // Try nuclear option as last resort
    setTimeout(() => {
      console.log('Trying nuclear option...');
      forceRecreateProgressElements();
    }, 1000);
  }

  // Load submission history for the selected project
  async function loadSubmissionHistory() {
    if (!selectedProject) return;
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_URL}/project-updates/project/${selectedProject.id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          projectUpdates = data.updates || [];
          displaySubmissionHistory();
        }
      }
    } catch (error) {
      console.error('Error loading submission history:', error);
    }
  }

  // Display submission history
  function displaySubmissionHistory() {
    const container = document.getElementById('updatesContainer');
    const emptyHistory = document.getElementById('emptyHistory');
    
    if (!container) return;
    
    // Update summary statistics
    const totalSubmissions = projectUpdates.length;
    const pendingReviews = projectUpdates.filter(u => u.status === 'submitted').length;
    const approvedUpdates = projectUpdates.filter(u => u.status === 'secretariat_approved').length;
    const rejectedUpdates = projectUpdates.filter(u => u.status === 'rejected').length;
    
    document.getElementById('totalSubmissions').textContent = totalSubmissions;
    document.getElementById('pendingReviews').textContent = pendingReviews;
    document.getElementById('approvedUpdates').textContent = approvedUpdates;
    document.getElementById('rejectedUpdates').textContent = rejectedUpdates;
    
    if (projectUpdates.length === 0) {
      container.style.display = 'none';
      emptyHistory.style.display = 'block';
      return;
    }
    
    container.style.display = 'block';
    emptyHistory.style.display = 'none';
    
    // Sort updates by date (newest first)
    const sortedUpdates = [...projectUpdates].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    container.innerHTML = sortedUpdates.map(update => {
      const statusColors = {
        'submitted': 'bg-yellow-100 text-yellow-800',
        'iu_approved': 'bg-blue-100 text-blue-800',
        'secretariat_approved': 'bg-green-100 text-green-800',
        'rejected': 'bg-red-100 text-red-800',
        'compiled_for_secretariat': 'bg-purple-100 text-purple-800'
      };
      
      const statusText = {
        'submitted': 'Pending Review',
        'iu_approved': 'IU Approved',
        'secretariat_approved': 'Approved',
        'rejected': 'Rejected',
        'compiled_for_secretariat': 'Compiled for Secretariat'
      };
      
      const date = new Date(update.createdAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-gray-800">${update.title || 'Milestone Update'}</h4>
                <p class="text-sm text-gray-600">Submitted on ${date}</p>
              </div>
            </div>
            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusColors[update.status] || 'bg-gray-100 text-gray-800'}">
              ${statusText[update.status] || update.status}
            </span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <span class="text-gray-600">Type:</span>
              <span class="font-medium ml-1">${update.updateType.replace('_', ' ').toUpperCase()}</span>
            </div>
            <div>
              <span class="text-gray-600">Progress:</span>
              <span class="font-medium ml-1">${update.currentProgress || 0}%</span>
            </div>
            <div>
              <span class="text-gray-600">Budget Used:</span>
              <span class="font-medium ml-1">₱${(update.budgetUsed || 0).toLocaleString()}</span>
            </div>
          </div>
          
          ${update.remarks ? `
            <div class="mt-3 p-3 bg-gray-50 rounded-lg">
              <p class="text-sm text-gray-700"><strong>Remarks:</strong> ${update.remarks}</p>
            </div>
          ` : ''}
          
          ${update.secretariatReviewRemarks ? `
            <div class="mt-3 p-3 bg-blue-50 rounded-lg">
              <p class="text-sm text-blue-700"><strong>Review Comments:</strong> ${update.secretariatReviewRemarks}</p>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // Refresh submission history
  function refreshSubmissionHistory() {
    loadSubmissionHistory();
  }

  // Make functions globally available
  window.selectProject = selectProject;
  window.submitMilestoneUpdates = submitMilestoneUpdates;
  window.refreshData = refreshData;
  window.loadSubmitUpdate = loadSubmitUpdate;
  window.toggleMilestoneCard = toggleMilestoneCard;
  window.displayFile = displayFile;
  window.removeFile = removeFile;
  window.debugUpdateUI = debugUpdateUI;
  window.checkDOMElements = checkDOMElements;
  window.forceRecreateProgressElements = forceRecreateProgressElements;
  window.refreshSubmissionHistory = refreshSubmissionHistory;
</script> 